<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-30986898-2"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-30986898-2');
</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({
          google_ad_client: "ca-pub-1187111537862676",
          enable_page_level_ads: true
     });
</script>
  
  <title>Dibran&#39;s Blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="Dibran&#39;s Blog">
<meta property="og:url" content="https://dibranmulder.github.io/index.html">
<meta property="og:site_name" content="Dibran&#39;s Blog">
<meta property="og:locale">
<meta property="article:author" content="Dibran Mulder">
<meta property="article:tag" content="Azure, Development, Cloud, DevOps.">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="Dibran&#39;s Blog" type="application/atom+xml">
  
  
    <link rel="icon" href="favicon.ico">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  
<link rel="stylesheet" href="/css/style.css">

<!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-math@4.0.0/dist/style.css">
<!-- hexo injector head_end end --><meta name="generator" content="Hexo 5.2.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Dibran&#39;s Blog</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://dibranmulder.github.io"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-Improving-your-Azure-Seach-performance" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/09/22/Improving-your-Azure-Seach-performance/" class="article-date">
  <time datetime="2020-09-21T22:00:00.000Z" itemprop="datePublished">2020-09-22</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/09/22/Improving-your-Azure-Seach-performance/">Improving your Azure Cognitive Seach performance</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>It can be a quite a struggle to really understand the in and outs of Azure Search and how search results are scored and how scoring profiles with weights and functions add up. In this blogpost I aim to explain the Azure Search inner workings, explaining the scoring algorithm and how to tweak it into your advantage. I also provide some practical tips on how to improve on search performance, but in order for you to apply those tips correctly you have to have a deeper understanding of the Azure Search itself. </p>
<h1 id="Azure-Search"><a href="#Azure-Search" class="headerlink" title="Azure Search"></a>Azure Search</h1><figure><img src="/images/search/azure-search-diagram.svg" /><figcaption style="font-style: italic; text-align: center;"><a target="_blank" rel="noopener" href="https://docs.microsoft.com/bs-cyrl-ba/azure/search/search-what-is-azure-search">Azure Cognitive Search</a></figcaption></figure>
Azure Cognitive Search can index various data sources and make them searchable by text queries. It lets you connect multiple data sources such as CosmosDb collections, SQL databases or even documents such as PDF's. The index then indexes the content based on the Index definition that has been configured. In most cases the indexation takes place on databases such as SQL databases or CosmosDb, enabling users to index for instance their E-commerce platform or knowledge base.

<p>Once the content has been indexed one can query the index with a text query and additionally add facets, filters and sorting. This query will be evaluated against the index and the system will return the highest scored documents. This blogpost is about unraveling the scoring system, and to help you to improve on your search performance. It matters because the user experience of the search is mainly impacted by the usability of the returned documents. In projects with Azure Cognitive Search I have come across way to many questions like: How did this document score this high? And why does it also find these documents? This blogpost is written to help you answer such questions.</p>
<h1 id="The-Search-Engine"><a href="#The-Search-Engine" class="headerlink" title="The Search Engine"></a>The Search Engine</h1><figure><img src="/images/search/search workflow.png" /><figcaption style="font-style: italic; text-align: center;">Azure Cognitive Search Overview</figcaption></figure>

<p>The search engine of Azure Cognitive Search is quite complex. To be honest, the documentation isn’t really forthcoming in how documents are being indexed and how the entered query eventually gets processed and scored against the indexed documents. This blogpost intents to shine some light into that black box. First I will explain the general flow of indexing, secondly I will explain how a search query is evaluated against the index and lastly I will give some practical tips on how to improve your Azure Search Performance.</p>
<h1 id="Indexing-documents"><a href="#Indexing-documents" class="headerlink" title="Indexing documents"></a>Indexing documents</h1><p>Indexing documents basically comes down to the creation of a database which stores a set of tokens per field that are generated for each document that has been indexed. The search engine will then use this so called index to evaluate a given query to it. What’s important to notice is is that the same process for indexing a document aswell as for tokenizing a query is performed. The data either a document or a search query will go through a so called analyzer, more on those later.</p>
<h2 id="Index"><a href="#Index" class="headerlink" title="Index"></a>Index</h2><p>An Azure Cognitive Search Index consists out of <code>fields</code>, <code>analyzers</code>, <code>charFilters</code>, <code>tokenizers</code> and <code>tokenFilters</code>. In most cases one won’t need to create a custom analyzer but rather would use one of the prebuild analyzers such as the language specific analyzers (nl.microsoft, en.microsoft) or the default analyzer. However it is possible to create a custom analyzer and configure it for the appropriate fields. Note that every field can configure its own analyzer. Even more so, its possible to configure a different analyzer for indexing the document than for searching(querying) the document. This can be a usefull scenario when one is trying to reduce the noise in the search results. Especially the prebuild language analyzers generate a lot of lingistic tokens that are not necessarily helpfull at all times. Below a JSON representation of an index.</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;name&quot;</span>:<span class="string">&quot;myindex&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;fields&quot;</span>:[</span><br><span class="line">       &#123;</span><br><span class="line">          <span class="attr">&quot;name&quot;</span>:<span class="string">&quot;id&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;type&quot;</span>:<span class="string">&quot;Edm.String&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;key&quot;</span>:<span class="literal">true</span>,</span><br><span class="line">          <span class="attr">&quot;searchable&quot;</span>:<span class="literal">false</span></span><br><span class="line">       &#125;,</span><br><span class="line">       &#123;</span><br><span class="line">          <span class="attr">&quot;name&quot;</span>:<span class="string">&quot;title&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;type&quot;</span>:<span class="string">&quot;Edm.String&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;analyzer&quot;</span>: <span class="string">&quot;en.microsoft&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;indexAnalyzer&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">          <span class="attr">&quot;searchAnalyzer&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">          <span class="attr">&quot;searchable&quot;</span>: <span class="literal">true</span></span><br><span class="line">       &#125;,</span><br><span class="line">       &#123;</span><br><span class="line">          <span class="attr">&quot;name&quot;</span>:<span class="string">&quot;text&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;type&quot;</span>:<span class="string">&quot;Edm.String&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;searchable&quot;</span>:<span class="literal">true</span>,</span><br><span class="line">          <span class="attr">&quot;analyzer&quot;</span>:<span class="string">&quot;my_analyzer&quot;</span></span><br><span class="line">       &#125;</span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">&quot;analyzers&quot;</span>:[</span><br><span class="line">       &#123;</span><br><span class="line">          <span class="attr">&quot;name&quot;</span>:<span class="string">&quot;my_analyzer&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;@odata.type&quot;</span>:<span class="string">&quot;#Microsoft.Azure.Search.CustomAnalyzer&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;charFilters&quot;</span>:[</span><br><span class="line">             <span class="string">&quot;map_dash&quot;</span>,</span><br><span class="line">             <span class="string">&quot;remove_whitespace&quot;</span></span><br><span class="line">          ],</span><br><span class="line">          <span class="attr">&quot;tokenizer&quot;</span>:<span class="string">&quot;my_standard_tokenizer&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;tokenFilters&quot;</span>:[</span><br><span class="line">             <span class="string">&quot;my_asciifolding&quot;</span>,</span><br><span class="line">             <span class="string">&quot;lowercase&quot;</span></span><br><span class="line">          ]</span><br><span class="line">       &#125;</span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">&quot;charFilters&quot;</span>:[</span><br><span class="line">       &#123;</span><br><span class="line">          <span class="attr">&quot;name&quot;</span>:<span class="string">&quot;map_dash&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;@odata.type&quot;</span>:<span class="string">&quot;#Microsoft.Azure.Search.MappingCharFilter&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;mappings&quot;</span>:[<span class="string">&quot;-=&gt;_&quot;</span>]</span><br><span class="line">       &#125;,</span><br><span class="line">       &#123;</span><br><span class="line">          <span class="attr">&quot;name&quot;</span>:<span class="string">&quot;remove_whitespace&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;@odata.type&quot;</span>:<span class="string">&quot;#Microsoft.Azure.Search.MappingCharFilter&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;mappings&quot;</span>:[<span class="string">&quot;\\u0020=&gt;&quot;</span>]</span><br><span class="line">       &#125;</span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">&quot;tokenizers&quot;</span>:[</span><br><span class="line">       &#123;</span><br><span class="line">          <span class="attr">&quot;name&quot;</span>:<span class="string">&quot;my_standard_tokenizer&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;@odata.type&quot;</span>:<span class="string">&quot;#Microsoft.Azure.Search.StandardTokenizerV2&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;maxTokenLength&quot;</span>:<span class="number">20</span></span><br><span class="line">       &#125;</span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">&quot;tokenFilters&quot;</span>:[</span><br><span class="line">       &#123;</span><br><span class="line">          <span class="attr">&quot;name&quot;</span>:<span class="string">&quot;my_asciifolding&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;@odata.type&quot;</span>:<span class="string">&quot;#Microsoft.Azure.Search.AsciiFoldingTokenFilter&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;preserveOriginal&quot;</span>:<span class="literal">true</span></span><br><span class="line">       &#125;</span><br><span class="line">    ]</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<h2 id="Analyzers"><a href="#Analyzers" class="headerlink" title="Analyzers"></a>Analyzers</h2><p>Let’s take a closer look at an analyzer. As stated before an (custom) analyzer includes a <code>charFilter</code>, <code>tokenizer</code> and <code>tokenFilter</code>. The index requires an analyzer for every  <code>searchable</code> property, this can either be the same analyzer for indexing aswell as for searching. The analyzers can be configured using the <code>indexAnalyzer</code> and the <code>searchAnalyzer</code> properties. If one requires the same analyzer for both indexing aswell as searching then the <code>analyzer</code> property can be set. </p>
<p>Depending on either or not one needs custom <code>charFilters</code>, <code>tokenizers</code> and <code>tokenFilters</code> one can configure them in the Index. <a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/azure/search/index-add-custom-analyzers">The Azure Cogntive Search documentation contains a reference of all prebuild components</a>. One can pick and choose to create the most optimal analyzer for its needs.</p>
<figure><img src="/images/search/analyzer-flow.png" /><figcaption style="font-style: italic; text-align: center;">Azure Cognitive Search Analyzer</figcaption></figure>

<p>It’s important to know how an analyzer works. The tokens that are generated for every seachable field form the basis for every search outcome. One can easily test what tokens are generated by performing a simple REST call to the Azure Cognitive Search service. Below is an example of the difference between a <code>standard</code> (default) analyzer and the English <code>en.microsoft</code> analyzer. When entered the text <code>cycling helmet</code> the <code>en.microsoft</code> analyzer adds a conjugation of the word cycling namely the stem: cycle. When for instance this analyzer is configured for searching, then all properties that have the word cycle present in the index will be returned as a match on the given search query. This can be the cause of lots of noise or bad matching search results. Properties containing the exact match <code>Cycling</code> will return a higher score, but more on scoring in the Scoring chapter.</p>
<h3 id="Example-of-a-language-specific-and-default-analyzer"><a href="#Example-of-a-language-specific-and-default-analyzer" class="headerlink" title="Example of a language specific and default analyzer"></a>Example of a language specific and default analyzer</h3><p>Below one can see two examples of tokens being generated by a language specific and default analyzer. Note that language specific analyzers add conjugations of certain words. In a lot of cases conjugations of verbs, nouns but also adjectives are added. Note that in the example the stem of the verb is added and also the singular conjugation of the noun helmets. The standard analyzer however just splits the search query based on spaces and doesn’t add any conjugations.</p>
<h4 id="Example-language-specific-analyzer"><a href="#Example-language-specific-analyzer" class="headerlink" title="Example language specific analyzer"></a>Example language specific analyzer</h4><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">POST https://[az search].search.windows.net/indexes/[index name]/analyze?api-version=[api-version]</span><br><span class="line">    Content-Type: application/json</span><br><span class="line">    api-key: [admin key]</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;text&quot;</span>: <span class="string">&quot;cycling helmets&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;analyzer&quot;</span>: <span class="string">&quot;en.microsoft&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Response</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;@odata.context&quot;</span>: <span class="string">&quot;https://[az search].search.windows.net/$metadata#Microsoft.Azure.Search.V2020_06_30.AnalyzeResult&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;tokens&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">&quot;token&quot;</span>: <span class="string">&quot;cycle&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;startOffset&quot;</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="attr">&quot;endOffset&quot;</span>: <span class="number">7</span>,</span><br><span class="line">            <span class="attr">&quot;position&quot;</span>: <span class="number">0</span></span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">&quot;token&quot;</span>: <span class="string">&quot;cycling&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;startOffset&quot;</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="attr">&quot;endOffset&quot;</span>: <span class="number">7</span>,</span><br><span class="line">            <span class="attr">&quot;position&quot;</span>: <span class="number">0</span></span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">&quot;token&quot;</span>: <span class="string">&quot;helmet&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;startOffset&quot;</span>: <span class="number">8</span>,</span><br><span class="line">            <span class="attr">&quot;endOffset&quot;</span>: <span class="number">15</span>,</span><br><span class="line">            <span class="attr">&quot;position&quot;</span>: <span class="number">1</span></span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">&quot;token&quot;</span>: <span class="string">&quot;helmets&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;startOffset&quot;</span>: <span class="number">8</span>,</span><br><span class="line">            <span class="attr">&quot;endOffset&quot;</span>: <span class="number">15</span>,</span><br><span class="line">            <span class="attr">&quot;position&quot;</span>: <span class="number">1</span></span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Example-Standard-Analyzer"><a href="#Example-Standard-Analyzer" class="headerlink" title="Example Standard Analyzer"></a>Example Standard Analyzer</h4><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">POST https://[az search].search.windows.net/indexes/[index name]/analyze?api-version=[api-version]</span><br><span class="line">    Content-Type: application/json</span><br><span class="line">    api-key: [admin key]</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;text&quot;</span>: <span class="string">&quot;cycling helmet&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;analyzer&quot;</span>: <span class="string">&quot;standard&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Response</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;@odata.context&quot;</span>: <span class="string">&quot;https://[az search].search.windows.net/$metadata#Microsoft.Azure.Search.V2020_06_30.AnalyzeResult&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;tokens&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">&quot;token&quot;</span>: <span class="string">&quot;cycling&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;startOffset&quot;</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="attr">&quot;endOffset&quot;</span>: <span class="number">7</span>,</span><br><span class="line">            <span class="attr">&quot;position&quot;</span>: <span class="number">0</span></span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">&quot;token&quot;</span>: <span class="string">&quot;helmet&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;startOffset&quot;</span>: <span class="number">8</span>,</span><br><span class="line">            <span class="attr">&quot;endOffset&quot;</span>: <span class="number">14</span>,</span><br><span class="line">            <span class="attr">&quot;position&quot;</span>: <span class="number">1</span></span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>For more information on how to test <code>analyzers</code>, <code>charFilters</code>, <code>tokenizers</code> and <code>tokenFilters</code> please visit: <a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/rest/api/searchservice/test-analyzer">https://docs.microsoft.com/en-us/rest/api/searchservice/test-analyzer</a>.</p>
<h1 id="Searching-through-documents"><a href="#Searching-through-documents" class="headerlink" title="Searching through documents."></a>Searching through documents.</h1><p>Now that you know how tokens are generated for both documents and search terms, we’ve come to a further review of the Azure Cognitive Search scoring mechanism. Depending on the API version you are using, Azure Cognitive Search uses the BM25 or TFIDF algorithm. In principle, both algorithms come down to the same thing. Basically what the algorithms do is compare the list of tokens stored in the index with the tokens generated for the specified search query and calculate a <code>term frequency</code>. The score that is calculated has a range of <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0...1</mn></mrow><annotation encoding="application/x-tex">0...1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">0</span><span class="mord">.</span><span class="mord">.</span><span class="mord">.</span><span class="mord">1</span></span></span></span> where no results will be produced with a score of 0, but everything above is considered a result. So you can imagine that the conjugations the analyzer adds to the tokens can cause more documents to return a score of <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>&gt;</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">&gt; 0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5782em;vertical-align:-0.0391em;"></span><span class="mrel">&gt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">0</span></span></span></span>, which could cause your search results to be noisy. Obviously, the documents with the most matched terms will score the highest, as a result of which the documents with the most matching content will be considered the best search results.</p>
<h2 id="Scoring-profiles"><a href="#Scoring-profiles" class="headerlink" title="Scoring profiles"></a>Scoring profiles</h2><p>In addition to the standard <code>term frequency</code> scoring mechanism, a scoring profile can be configured. A scoring profile consists of two parts, namely: weights &amp; functions. Weights can be used to weigh certain fields in index more strongly than other fields. Each searchable field basically counts proportionally in determining the <code>0 - 1</code> term frequency score. What is important to know is that fields with a relatively long text will yield a lower score than fields with a short text. In other words, the term frequency of a short text field is logically higher than the term frequency of a long text field. For example, if you search for <code>cyling helmet</code> and the title of the document contains the exact terms, the score off that field will be higher than if the description of ~ 200 words also contains the text cycling helmet. Suppose the title is ‘Red Specialized Cycling Helmet’, then the term frequency is relatively high. The description may also include content such as aerodynamics or other details of the product in which the words <code>cylcing helmet</code> are relatively less frequent. Based on this reasoning, it is therefore not always wise to weigh the title more heavily as the description field, because the length of the content of the fields is already strongly included in the <code>term frequency</code> algorithm.</p>
<p>However, weights can be a good addition to tweak search results. A good example is to apply weights to keyword fields. An E-commerce platform often has keywords that should give a strong boost in relevance when the user enters exactly the keyword as search term. In the case of keywords, it is important to determine whether conjugations generated by the analyzer have a negative or positive effect on the accuracy of the search results. For keywords you may want to ensure that only exact matches cause an increase in relevance and not conjugations. An example to illustrate the concept. The <code>en.microsoft</code> analyzer will generate the tokens <code>cylcing</code>,<code> cycle</code> and <code>helmet</code> for the search query: <code>cylcing helmet</code>. When the user enters the search query: <code>motorcycle helmet</code>, document with the keyword <code>Cycling helmet</code> will also be scored. If, for example, a comparison is made with a motorcycle helmet in the description, it is possible that a cycling helmet document scores even higher than a motorcycle helmet. So keep in mind what keywords you store and how much you let them weigh in.</p>
<h3 id="Bepalen-van-gewichten"><a href="#Bepalen-van-gewichten" class="headerlink" title="Bepalen van gewichten"></a>Bepalen van gewichten</h3><h2 id="Scoring-algorithm"><a href="#Scoring-algorithm" class="headerlink" title="Scoring algorithm"></a>Scoring algorithm</h2><p>Azure Cognitive Search uses a scoring algorithm which they do not publish in their documentation. It can therefore be quite hard to figure out how a score is composed and how the different factors come in play. I tried to the sum it up in a mathematical equation. I’m by no means a mathematician but I tried to do it well. I found this algorithm by reverse engineering the Azure Cognitive Search. The process was quite simply, first add some searchable fields to an index, add some documents and evaluate the total unweighted score, I then added weights to see how they affect the search score and I found out that the weights multiply the raw search score which are yielded by the BM25 or TFIDF algorithm. I then added functions to see how they would come into play and I realised they also multiply the total weighted score of all searchable fields. If you put all of that you will get the following equation:</p>
<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>s</mi><mi>t</mi></msub><mo>=</mo><mo stretchy="false">(</mo><mo stretchy="false">(</mo><msub><mi>f</mi><mi>s</mi></msub><mo stretchy="false">(</mo><msub><mi>a</mi><mn>1</mn></msub><mo stretchy="false">)</mo><mo>∗</mo><msub><mi>w</mi><mn>1</mn></msub><mo stretchy="false">)</mo><mo>+</mo><mo stretchy="false">(</mo><msub><mi>f</mi><mi>s</mi></msub><mo stretchy="false">(</mo><msub><mi>a</mi><mn>2</mn></msub><mo stretchy="false">)</mo><mo>∗</mo><msub><mi>w</mi><mn>2</mn></msub><mo stretchy="false">)</mo><mo>+</mo><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mo stretchy="false">)</mo><mo>∗</mo><mo stretchy="false">(</mo><msub><mi>f</mi><mi>a</mi></msub><mo stretchy="false">(</mo><msub><mi>f</mi><mn>1</mn></msub><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mo separator="true">,</mo><msub><mi>f</mi><mn>2</mn></msub><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mo separator="true">,</mo><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mo stretchy="false">)</mo><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">% s = \displaystyle\left(\sum_{i=0}^\infin{f_s(a_i) * w_i}\right)*\left(f_a({\sum_{n=0}^\infin{f_n(x)}})\right)\\
s_t = ((f_s(a_1) * w_1) + (f_s(a_2) * w_2) + ...) * (f_a(f_1(x), f_2(x), ...))</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.58056em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2805559999999999em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.10764em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">s</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.02691em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.10764em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">s</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.02691em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">.</span><span class="mord">.</span><span class="mord">.</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.10764em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">a</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.10764em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.10764em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">.</span><span class="mord">.</span><span class="mord">.</span><span class="mclose">)</span><span class="mclose">)</span></span></span></span>
</br>
<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>s</mi><mi>t</mi></msub></mrow><annotation encoding="application/x-tex">s_t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.58056em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2805559999999999em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> will be the total score for each document. </br>

<h3 id="Weights"><a href="#Weights" class="headerlink" title="Weights"></a>Weights</h3><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>s</mi><mi>t</mi></msub><mo>=</mo><mi><mrow><mo stretchy="false">(</mo><mo stretchy="false">(</mo><msub><mi mathvariant="bold-italic">f</mi><mi mathvariant="bold-italic">s</mi></msub><mo stretchy="false">(</mo><msub><mi mathvariant="bold-italic">a</mi><mn mathvariant="bold">1</mn></msub><mo stretchy="false">)</mo><mo mathvariant="bold-italic">∗</mo><msub><mi mathvariant="bold-italic">w</mi><mn mathvariant="bold">1</mn></msub><mo stretchy="false">)</mo><mo mathvariant="bold-italic">+</mo><mo stretchy="false">(</mo><msub><mi mathvariant="bold-italic">f</mi><mi mathvariant="bold-italic">s</mi></msub><mo stretchy="false">(</mo><msub><mi mathvariant="bold-italic">a</mi><mn mathvariant="bold">2</mn></msub><mo stretchy="false">)</mo><mo mathvariant="bold-italic">∗</mo><msub><mi mathvariant="bold-italic">w</mi><mn mathvariant="bold">2</mn></msub><mo stretchy="false">)</mo><mo mathvariant="bold-italic">+</mo><mi mathvariant="bold">.</mi><mi mathvariant="bold">.</mi><mi mathvariant="bold">.</mi><mo stretchy="false">)</mo></mrow></mi><mo>∗</mo><mo stretchy="false">(</mo><msub><mi>f</mi><mi>a</mi></msub><mo stretchy="false">(</mo><msub><mi>f</mi><mn>1</mn></msub><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mo separator="true">,</mo><msub><mi>f</mi><mn>2</mn></msub><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mo separator="true">,</mo><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mo stretchy="false">)</mo><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">s_t = \boldsymbol{((f_s(a_1) * w_1) + (f_s(a_2) * w_2) + ...)} * (f_a(f_1(x), f_2(x), ...))</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.58056em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2805559999999999em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord"><span class="mopen mathbf">(</span><span class="mopen mathbf">(</span><span class="mord"><span class="mord boldsymbol" style="margin-right:0.11042em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.161108em;"><span style="top:-2.5500000000000003em;margin-left:-0.11042em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord boldsymbol mtight">s</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen mathbf">(</span><span class="mord"><span class="mord boldsymbol">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathbf mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose mathbf">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin mathbf">∗</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mord boldsymbol" style="margin-right:0.02778em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.02778em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathbf mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose mathbf">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin mathbf">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mopen mathbf">(</span><span class="mord"><span class="mord boldsymbol" style="margin-right:0.11042em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.161108em;"><span style="top:-2.5500000000000003em;margin-left:-0.11042em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord boldsymbol mtight">s</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen mathbf">(</span><span class="mord"><span class="mord boldsymbol">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathbf mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose mathbf">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin mathbf">∗</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mord boldsymbol" style="margin-right:0.02778em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.02778em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathbf mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose mathbf">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin mathbf">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathbf">.</span><span class="mord mathbf">.</span><span class="mord mathbf">.</span><span class="mclose mathbf">)</span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.10764em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">a</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.10764em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.10764em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">.</span><span class="mord">.</span><span class="mord">.</span><span class="mclose">)</span><span class="mclose">)</span></span></span></span>
<p>The left hand of the function is a series of searchable fields (<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>a</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">a_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.58056em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>) which will be evaluated. Each field will be evaluated by the scoring function (<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>f</mi><mi>s</mi></msub></mrow><annotation encoding="application/x-tex">f_s </annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.10764em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">s</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>) which is either a BM25 or TFIDF algorithm. The output of the function will yield a score of <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0...1</mn></mrow><annotation encoding="application/x-tex">0...1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">0</span><span class="mord">.</span><span class="mord">.</span><span class="mord">.</span><span class="mord">1</span></span></span></span> which will be multiplied by the weight (<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>w</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">w_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.58056em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.02691em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>) which corresponds to the evaluated field (<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>a</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">a_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.58056em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>). The total of all evaluated search fields will be summed up and yield a total weighted score.</p>
<h3 id="Functions"><a href="#Functions" class="headerlink" title="Functions"></a>Functions</h3><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>s</mi><mi>t</mi></msub><mo>=</mo><mo stretchy="false">(</mo><mo stretchy="false">(</mo><msub><mi>f</mi><mi>s</mi></msub><mo stretchy="false">(</mo><msub><mi>a</mi><mn>1</mn></msub><mo stretchy="false">)</mo><mo>∗</mo><msub><mi>w</mi><mn>1</mn></msub><mo stretchy="false">)</mo><mo>+</mo><mo stretchy="false">(</mo><msub><mi>f</mi><mi>s</mi></msub><mo stretchy="false">(</mo><msub><mi>a</mi><mn>2</mn></msub><mo stretchy="false">)</mo><mo>∗</mo><msub><mi>w</mi><mn>2</mn></msub><mo stretchy="false">)</mo><mo>+</mo><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mo stretchy="false">)</mo><mo>∗</mo><mi><mrow><mo stretchy="false">(</mo><msub><mi mathvariant="bold-italic">f</mi><mi mathvariant="bold-italic">a</mi></msub><mo stretchy="false">(</mo><msub><mi mathvariant="bold-italic">f</mi><mn mathvariant="bold">1</mn></msub><mo stretchy="false">(</mo><mi mathvariant="bold-italic">x</mi><mo stretchy="false">)</mo><mo separator="true">,</mo><msub><mi mathvariant="bold-italic">f</mi><mn mathvariant="bold">2</mn></msub><mo stretchy="false">(</mo><mi mathvariant="bold-italic">x</mi><mo stretchy="false">)</mo><mo separator="true">,</mo><mi mathvariant="bold">.</mi><mi mathvariant="bold">.</mi><mi mathvariant="bold">.</mi><mo stretchy="false">)</mo><mo stretchy="false">)</mo></mrow></mi></mrow><annotation encoding="application/x-tex">s_t = ((f_s(a_1) * w_1) + (f_s(a_2) * w_2) + ...) * \boldsymbol{(f_a(f_1(x), f_2(x), ...))}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.58056em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2805559999999999em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.10764em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">s</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.02691em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.10764em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">s</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.02691em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">.</span><span class="mord">.</span><span class="mord">.</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord"><span class="mopen mathbf">(</span><span class="mord"><span class="mord boldsymbol" style="margin-right:0.11042em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.161108em;"><span style="top:-2.5500000000000003em;margin-left:-0.11042em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord boldsymbol mtight">a</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen mathbf">(</span><span class="mord"><span class="mord boldsymbol" style="margin-right:0.11042em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.11042em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathbf mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen mathbf">(</span><span class="mord boldsymbol">x</span><span class="mclose mathbf">)</span><span class="mpunct mathbf">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord boldsymbol" style="margin-right:0.11042em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.11042em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathbf mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen mathbf">(</span><span class="mord boldsymbol">x</span><span class="mclose mathbf">)</span><span class="mpunct mathbf">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathbf">.</span><span class="mord mathbf">.</span><span class="mord mathbf">.</span><span class="mclose mathbf">)</span><span class="mclose mathbf">)</span></span></span></span></span></span>

<p>The right hand of the function is a series of functions (<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>f</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">f_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.10764em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>) which will be evaluated. Each function can either be a <code>freshness</code>, <code>magnitude</code>, <code>distance</code> or <code>tag</code> functions. The aggregration of the series of functions can be either a <code>summation</code>, <code>average</code>, <code>minimum</code>, <code>maximum</code> or first matching function (<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>f</mi><mi>a</mi></msub></mrow><annotation encoding="application/x-tex">f_a</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.10764em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">a</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>).</p>
<p>The score yielded by a function can be quite hard to understand. In all cases one needs to pick an <code>interpolation</code> and a <code>boost</code> factor. The interpolation affects the score prior to boosting it. When the interpolation is not constant then the function score will be determined on the range set in the scoring function. The <code>freshness</code>, <code>magnitude</code>, <code>distance</code> logically need a range of values to work with. These scoring functions boost documents that are within a time period, a numeric range or a geographical range. In all cases the scoring functions returns a score of <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0...1</mn></mrow><annotation encoding="application/x-tex">0...1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">0</span><span class="mord">.</span><span class="mord">.</span><span class="mord">.</span><span class="mord">1</span></span></span></span>. The boost function will then multiply the score with an offset of 1. This is also the reason why the boosting function has to be <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>&gt;</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">&gt; 1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5782em;vertical-align:-0.0391em;"></span><span class="mrel">&gt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span></span></span></span>. The equation of predicting the total score of a function is: <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi><mo>=</mo><mn>1</mn><mo>+</mo><mo stretchy="false">(</mo><mi>b</mi><mo>−</mo><mn>1</mn><mo stretchy="false">)</mo><mo>∗</mo><msub><mi>f</mi><mi>s</mi></msub></mrow><annotation encoding="application/x-tex">s = 1+(b-1)*f_s</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal">s</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal">b</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">1</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.10764em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">s</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>, where <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi></mrow><annotation encoding="application/x-tex">s</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal">s</span></span></span></span> is the score, <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>b</mi></mrow><annotation encoding="application/x-tex">b</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal">b</span></span></span></span> is the <code>boost</code> factor and <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>f</mi><mi>s</mi></msub></mrow><annotation encoding="application/x-tex">f_s</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.10764em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">s</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> is the function score.</p>
<figure><img src="/images/search/scoringfunction.png" /><figcaption style="font-style: italic; text-align: center;">Scoring Function Interpolation</figcaption></figure>

<p>I will eloborate further with an example. Lets say you have a new site or E-commerce platform that needs to boost document that are written in the last year. In order for you to do that you need to configure a <code>magnitude</code> function with for instance a linear <code>interpolation</code>. If you want to relevance to decrease rapidly or slowly then one should choose a quadratic or logarithmic interpolation. If documents need to boost constantly over the entire year one chooses constant. </p>
<p>Lets say we have a document that has a written date of 50 days ago. The range of the freshness function is set from today to 365 days ago. That gives us a range of 0…365. In our example 50 days from now scores a <code>0.8630137</code> if 1 is today and 0 is 365 ago or earlier. One can easily calculate the value on a custom scale by this function: <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mi>m</mi><mi>i</mi><mi>n</mi><mi>i</mi><mi>m</mi><mi>u</mi><mi>m</mi><mo>−</mo><mi>v</mi><mi>a</mi><mi>l</mi><mi>u</mi><mi>e</mi><mo stretchy="false">)</mo><mi mathvariant="normal">/</mi><mo stretchy="false">(</mo><mi>m</mi><mi>i</mi><mi>n</mi><mi>i</mi><mi>m</mi><mi>u</mi><mi>m</mi><mo>−</mo><mi>m</mi><mi>a</mi><mi>x</mi><mi>i</mi><mi>m</mi><mi>u</mi><mi>m</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(minimum-value)/(minimum-maximum)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal">m</span><span class="mord mathnormal">i</span><span class="mord mathnormal">n</span><span class="mord mathnormal">i</span><span class="mord mathnormal">m</span><span class="mord mathnormal">u</span><span class="mord mathnormal">m</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">u</span><span class="mord mathnormal">e</span><span class="mclose">)</span><span class="mord">/</span><span class="mopen">(</span><span class="mord mathnormal">m</span><span class="mord mathnormal">i</span><span class="mord mathnormal">n</span><span class="mord mathnormal">i</span><span class="mord mathnormal">m</span><span class="mord mathnormal">u</span><span class="mord mathnormal">m</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">m</span><span class="mord mathnormal">a</span><span class="mord mathnormal">x</span><span class="mord mathnormal">i</span><span class="mord mathnormal">m</span><span class="mord mathnormal">u</span><span class="mord mathnormal">m</span><span class="mclose">)</span></span></span></span>, in our case: <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mn>365</mn><mo>−</mo><mn>50</mn><mo stretchy="false">)</mo><mi mathvariant="normal">/</mi><mo stretchy="false">(</mo><mn>365</mn><mo>−</mo><mn>0</mn><mo stretchy="false">)</mo><mo>=</mo><mn>0.8630137</mn></mrow><annotation encoding="application/x-tex">(365-50)/(365-0)=0.8630137</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord">3</span><span class="mord">6</span><span class="mord">5</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">5</span><span class="mord">0</span><span class="mclose">)</span><span class="mord">/</span><span class="mopen">(</span><span class="mord">3</span><span class="mord">6</span><span class="mord">5</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">0</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">0</span><span class="mord">.</span><span class="mord">8</span><span class="mord">6</span><span class="mord">3</span><span class="mord">0</span><span class="mord">1</span><span class="mord">3</span><span class="mord">7</span></span></span></span>. If a boost of 2 is configured the total score of the function will be <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1.8630137</mn><mo>=</mo><mn>1</mn><mo>+</mo><mo stretchy="false">(</mo><mn>2</mn><mo>−</mo><mn>1</mn><mo stretchy="false">)</mo><mo>∗</mo><mn>0.8630137</mn></mrow><annotation encoding="application/x-tex">1.8630137 = 1+(2-1)*0.8630137</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span><span class="mord">.</span><span class="mord">8</span><span class="mord">6</span><span class="mord">3</span><span class="mord">0</span><span class="mord">1</span><span class="mord">3</span><span class="mord">7</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord">2</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">1</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">0</span><span class="mord">.</span><span class="mord">8</span><span class="mord">6</span><span class="mord">3</span><span class="mord">0</span><span class="mord">1</span><span class="mord">3</span><span class="mord">7</span></span></span></span></p>
<h3 id="Total"><a href="#Total" class="headerlink" title="Total"></a>Total</h3><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>t</mi><mi>o</mi><mi>t</mi><mi>a</mi><mi>l</mi><mi>s</mi><mi>c</mi><mi>o</mi><mi>r</mi><mi>e</mi><mo>=</mo><mo stretchy="false">(</mo><mi>w</mi><mi>e</mi><mi>i</mi><mi>g</mi><mi>h</mi><mi>t</mi><mi>e</mi><mi>d</mi><mi>f</mi><mi>i</mi><mi>e</mi><mi>l</mi><mi>d</mi><mi>s</mi><mi>c</mi><mi>o</mi><mi>r</mi><mi>e</mi><mi>s</mi><mo stretchy="false">)</mo><mo>∗</mo><mo stretchy="false">(</mo><mi>f</mi><mi>u</mi><mi>n</mi><mi>c</mi><mi>t</mi><mi>i</mi><mi>o</mi><mi>n</mi><mi>a</mi><mi>g</mi><mi>g</mi><mi>r</mi><mi>e</mi><mi>g</mi><mi>r</mi><mi>a</mi><mi>t</mi><mi>i</mi><mi>o</mi><mi>n</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">total score = (weighted field scores) * (function aggregration)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal">t</span><span class="mord mathnormal">o</span><span class="mord mathnormal">t</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">s</span><span class="mord mathnormal">c</span><span class="mord mathnormal">o</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal">e</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="mord mathnormal">e</span><span class="mord mathnormal">i</span><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="mord mathnormal">h</span><span class="mord mathnormal">t</span><span class="mord mathnormal">e</span><span class="mord mathnormal">d</span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mord mathnormal">i</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">d</span><span class="mord mathnormal">s</span><span class="mord mathnormal">c</span><span class="mord mathnormal">o</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal">e</span><span class="mord mathnormal">s</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mord mathnormal">u</span><span class="mord mathnormal">n</span><span class="mord mathnormal">c</span><span class="mord mathnormal">t</span><span class="mord mathnormal">i</span><span class="mord mathnormal">o</span><span class="mord mathnormal">n</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal">a</span><span class="mord mathnormal">t</span><span class="mord mathnormal">i</span><span class="mord mathnormal">o</span><span class="mord mathnormal">n</span><span class="mclose">)</span></span></span></span>
<p>This brings us at the grand total of a document including weights, functions and boosting. The total is a simple multiplication of the total weightes score times the total of the function aggregation.</p>
<h1 id="Measuring-performance"><a href="#Measuring-performance" class="headerlink" title="Measuring performance"></a>Measuring performance</h1><p>Measuring search performance is very difficult. Apart from the fact that it is complex to understand the logic that drives the search results, understanding the performance of your Azure Search is complex. This is because a search query often returns multiple results that come back in a certain order. The order of the results largely determines the performance of your Azure Search device. Tweaking the analyzers, scoring profiles and the like can have a big effect on the performance of your Azure Search. However, it is strongly recommended to compile a gold set of the most commonly used queries before tweaking. Depending on the size of your Azure Search, I recommend a Goldset of about 100-200 commonly used search terms. The goldset helps you to stay out of the discussion of edge cases, too often I have seen that the Azure Search was adjusted to accommodate a certain egde case, but I forgot to test regression properly. It may then happen that an adjustment actually results in a worse general performance. To prevent this, you should always test with a gold set that is representative of your target audience. If an edge becomes so important, you should add it to the gold set in order to always test from a fixed basis whether the adjustments you make bring about a general improvement.</p>
<p>An important tip I would like to give you is that it is wise to store the gold set in a database. For example a SQL Database table or an Azure Table Storage table. This will allow you to automate the regression test in the long run. Automating the regression test is essential to be able to continuously make small improvements to your Azure Search in an Agile way.</p>
<h2 id="Regression-testing"><a href="#Regression-testing" class="headerlink" title="Regression testing"></a>Regression testing</h2><p>Suppose you have a gold set, how do you perform a regression test on Azure Search? First of all, you need to create a script that retrieves the goldset from the database and runs it on the Azure Search index. You must then store the results in a database. This can be a simple table with the search term as primary key, a date time column and as other columns the IDs of the top 10 search results. With this data you can analyze the impact of an adjustment by comparing 2 test runs. The first metric of interest is the ** significance of the adjustment **. To determine the significance you can simply use the percentage of:</p>
<ul>
<li>the number of queries where the 1st search result has been changed.</li>
<li>the number of queries where the first 3 search results were changed.</li>
<li>the number of queries where the first 5 search results were changed.</li>
<li>the number of queries where the first 10 search results were changed.</li>
</ul>
<p>This gives you an idea of whether the change you have made has a major impact or not. If it has a big impact then you should be aware that it can also have a big impact on the user experience.</p>
<h2 id="Analysing-a-regression-test"><a href="#Analysing-a-regression-test" class="headerlink" title="Analysing a regression test"></a>Analysing a regression test</h2><p>When you have performed a regression test, it is wise to classify the major changes as improvement or deterioration. Of course, you cannot classify the changes based on the average change reate, you will have to look at certain search terms more closely. What I find a clear and good method is to compare 2 test runs with each other and thus generate the following table.</p>
<table>
<thead>
<tr>
<th>Search term</th>
<th>1</th>
<th>2</th>
<th>3</th>
<th>4</th>
<th>5</th>
<th>6</th>
<th>7</th>
<th>8</th>
<th>9</th>
<th>10</th>
</tr>
</thead>
<tbody><tr>
<td>Racing bike</td>
<td><span class="w3-badge w3-orange">2</span></td>
<td><span class="w3-badge w3-orange w3-orange">3</span></td>
<td><span class="w3-badge w3-orange">4</span></td>
<td><span class="w3-badge w3-orange">5</span></td>
<td><span class="w3-badge w3-orange w3-red">1</span></td>
<td><span class="w3-badge">6</span></td>
<td><span class="w3-badge">7</span></td>
<td><span class="w3-badge">8</span></td>
<td><span class="w3-badge">9</span></td>
<td><span class="w3-badge">10</span></td>
</tr>
<tr>
<td>Gravel bike</td>
<td><span class="w3-badge">1</span></td>
<td><span class="w3-badge">2</span></td>
<td><span class="w3-badge">3</span></td>
<td><span class="w3-badge w3-orange ">5</span></td>
<td><span class="w3-badge w3-orange ">4</span></td>
<td><span class="w3-badge">6</span></td>
<td><span class="w3-badge">7</span></td>
<td><span class="w3-badge">8</span></td>
<td><span class="w3-badge">9</span></td>
<td><span class="w3-badge">10</span></td>
</tr>
<tr>
<td>Cyclocross bike</td>
<td><span class="w3-badge">1</span></td>
<td><span class="w3-badge">2</span></td>
<td><span class="w3-badge">3</span></td>
<td><span class="w3-badge">4</span></td>
<td><span class="w3-badge">5</span></td>
<td><span class="w3-badge">6</span></td>
<td><span class="w3-badge">7</span></td>
<td><span class="w3-badge ">8</span></td>
<td><span class="w3-badge w3-orange ">10</span></td>
<td><span class="w3-badge w3-orange ">9</span></td>
</tr>
<tr>
<td>Mountainbike</td>
<td><span class="w3-badge w3-green">8</span></td>
<td><span class="w3-badge w3-green">9</span></td>
<td><span class="w3-badge w3-green">10</span></td>
<td><span class="w3-badge">4</span></td>
<td><span class="w3-badge">5</span></td>
<td><span class="w3-badge">6</span></td>
<td><span class="w3-badge">7</span></td>
<td><span class="w3-badge w3-red ">2</span></td>
<td><span class="w3-badge w3-red">1</span></td>
<td><span class="w3-badge w3-red">3</span></td>
</tr>
<tr>
<td>Cycling helmet</td>
<td><span class="w3-badge">1</span></td>
<td><span class="w3-badge w3-green">new</span></td>
<td><span class="w3-badge w3-orange">2</span></td>
<td><span class="w3-badge w3-orange">3</span></td>
<td><span class="w3-badge w3-orange ">6</span></td>
<td><span class="w3-badge w3-orange ">5</span></td>
<td><span class="w3-badge w3-orange ">7</span></td>
<td><span class="w3-badge w3-orange ">8</span></td>
<td><span class="w3-badge">9</span></td>
<td><span class="w3-badge">10</span></td>
</tr>
<tr>
<td>Cycling gloves</td>
<td><span class="w3-badge">1</span></td>
<td><span class="w3-badge">2</span></td>
<td><span class="w3-badge">3</span></td>
<td><span class="w3-badge w3-orange ">4</span></td>
<td><span class="w3-badge w3-orange ">5</span></td>
<td><span class="w3-badge w3-orange ">6</span></td>
<td><span class="w3-badge w3-orange ">7</span></td>
<td><span class="w3-badge w3-orange ">8</span></td>
<td><span class="w3-badge">9</span></td>
<td><span class="w3-badge">10</span></td>
</tr>
<tr>
<td>Bicycle lights</td>
<td><span class="w3-badge w3-green">7</span></td>
<td><span class="w3-badge w3-orange ">4</span></td>
<td><span class="w3-badge w3-orange ">3</span></td>
<td><span class="w3-badge w3-orange ">2</span></td>
<td><span class="w3-badge w3-orange ">5</span></td>
<td><span class="w3-badge w3-orange ">6</span></td>
<td><span class="w3-badge w3-red">1</span></td>
<td><span class="w3-badge w3-orange ">8</span></td>
<td><span class="w3-badge">9</span></td>
<td><span class="w3-badge">10</span></td>
</tr>
<tr>
<td>Cycling bibs</td>
<td><span class="w3-badge">1</span></td>
<td><span class="w3-badge w3-orange ">4</span></td>
<td><span class="w3-badge w3-orange ">6</span></td>
<td><span class="w3-badge w3-orange ">2</span></td>
<td><span class="w3-badge w3-orange ">5</span></td>
<td><span class="w3-badge w3-orange ">3</span></td>
<td><span class="w3-badge w3-orange ">7</span></td>
<td><span class="w3-badge w3-orange ">8</span></td>
<td><span class="w3-badge">9</span></td>
<td><span class="w3-badge">10</span></td>
</tr>
<tr>
<td>Cycling tights</td>
<td><span class="w3-badge">1</span></td>
<td><span class="w3-badge">2</span></td>
<td><span class="w3-badge">3</span></td>
<td><span class="w3-badge">4</span></td>
<td><span class="w3-badge">5</span></td>
<td><span class="w3-badge">6</span></td>
<td><span class="w3-badge">7</span></td>
<td><span class="w3-badge w3-orange ">10</span></td>
<td><span class="w3-badge w3-orange ">9</span></td>
<td><span class="w3-badge w3-orange ">8</span></td>
</tr>
</tbody></table>
<p><span class="w3-badge w3-green">?</span> If it has moved more than 5 places forwards.<br><span class="w3-badge w3-red ">?</span> If it has moved more than 5 places backwards.<br><span class="w3-badge w3-orange ">?</span> If it has the same rank with a margin of 3.<br><span class="w3-badge">?</span> If its has the same rank.</p>
<p>In this example I use a gold set of 10 search terms which can be used for for instance a bicycle E-commerce store. In this overview, the significance of the change can be seen quickly and easily. When you see major changes, you can always analyze the results more closely and see if the change you made in case of a single search term is an improvement or a deterioration. If too many deteriorations have occurred, consider whether you want to bring the adjustment live.</p>
<p>This way you can regression test adjustments to an Azure Search. You keep the old index intact and also build a new one. By running the goldset on both Azure Search indexes you can analyze the impact of your change and later classify the results of individual search terms as improvement or deterioration.</p>
<h1 id="10-Azure-Search-performance-tips"><a href="#10-Azure-Search-performance-tips" class="headerlink" title="10 Azure Search performance tips"></a>10 Azure Search performance tips</h1><ol>
<li>Create a gold set of search terms and improve your Azure Search based on this set.</li>
<li>Make sure to test regression so that you can estimate the impact and classify it as improvement or deterioration.</li>
<li>Automate the regression test.</li>
<li>Make sure you have good and clean data. Divide the data into fields. Avoid adding additional fields with bulks of text.</li>
<li>Apply weights for fields that are important. Make sure weights are balanced.</li>
<li>Apply functions to determine scenarios such as time relevance or commercial considerations.</li>
<li>Make sure you use the same indexing analyzer as search.</li>
<li>Provide good facet and filter options so that the data being searched with text search is already limited.</li>
<li>Use the correct analyzers for fields or create custom analyzers as needed.</li>
<li>A / B test the changes you make to the Azure Search.</li>
</ol>
<link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
      
    </div>
    <footer class="article-footer">
      <a data-url="https://dibranmulder.github.io/2020/09/22/Improving-your-Azure-Seach-performance/" data-id="ckfdm139f0000s849brcfca99" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Azure/" rel="tag">Azure</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Azure-Search/" rel="tag">Azure Search</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Applying-an-Azure-Governance-Framework-in-10-steps" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/12/06/Applying-an-Azure-Governance-Framework-in-10-steps/" class="article-date">
  <time datetime="2019-12-06T15:17:55.000Z" itemprop="datePublished">2019-12-06</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/12/06/Applying-an-Azure-Governance-Framework-in-10-steps/">Applying an Azure Governance Framework in 10 steps</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <figure><img src="/images/governance/framework.png" /><figcaption style="font-style: italic; text-align: center;">Cloud Republic - Azure Governance Framework.</figcaption></figure>

<p>Every year RightScale, now Flexera, holds a survey to measure the current cloud challenges. This year just like in previous years Managing cloud spend and applying governance were the top challenges companies face. This blogpost is to manage the governance challenge. It provides a simple but yet effective framework to apply cloud governance into your business.</p>
<h1 id="1-Get-a-grip-on-your-subscriptions"><a href="#1-Get-a-grip-on-your-subscriptions" class="headerlink" title="1. Get a grip on your subscriptions"></a>1. Get a grip on your subscriptions</h1><figure><img style="width: 400px;" src="/images/governance/subscriptions.png" /><figcaption style="font-style: italic; text-align: center;">Azure account types</figcaption></figure>

<p>It all starts with your Azure subscriptions. When creating an Azure tetant there are 4 ways of creating it.<br>If you choose to create one via Microsoft then you have 2 options, either the Pay-As-You-Go account type or an Enterprise Agreement.<br>If your organization it not a small or medium business then you will probably need an Enterprise Agreement. It offers you a way to easily create multiple subscriptions and create them accordingly to for instance your business value domains.</p>
<p>The alternative is to choose either a direct on indirect Microsoft partner. These are so called Cloud Solution Providers. The CSP’s will get a kick back fee for your Azure consumption making it a interesting option for them to help you with your Azure needs. In return Microsoft expects that CSP’s will give a first line of support to their customers.</p>
<figure><img style="width: 400px;" src="/images/governance/dta-prod.png" /><figcaption style="font-style: italic; text-align: center;">Azure subscriptions; dev, test, acceptance & production.</figcaption></figure>

<p>It’s also wise to always create a separate production subscription or dependent on the size of your value domains also separate dev, test and acceptance subscriptions. For security and governance reasons later described in the Role based Access Control section, it is wise to separate production from dta. </p>
<h2 id="To-conclude"><a href="#To-conclude" class="headerlink" title="To conclude"></a>To conclude</h2><p>Basically, the rules of thumb are:</p>
<ol>
<li>Only if you’re a really small company or start-up use a Pay-As-You-Go subscription.</li>
<li>Use CSP subscriptions if you need a 3rd party to help you with 1st line of support questions.</li>
<li>Use an Enterprise Agreement if your reasonable in size and want to negotiate with Microsoft regarding Azure prices.</li>
</ol>
<p>Secondly,</p>
<ol>
<li>Create multiple subscriptions for different value domains within your company.</li>
<li>Create separate subscriptions for dev, test, acceptance and production workloads.</li>
</ol>
<p>For a detailed overview of Enterprise Agreement, CSP and Pay-As-You-Go subscriptions please visit <a target="_blank" rel="noopener" href="https://medium.com/@vunvulear/different-ways-of-buying-azure-services-pay-as-you-go-ea-direct-csp-indirect-csp-a563aa8cd89d">this blog</a>.</p>
<h1 id="2-Apply-structure-with-Naming-conventions"><a href="#2-Apply-structure-with-Naming-conventions" class="headerlink" title="2. Apply structure with Naming conventions"></a>2. Apply structure with Naming conventions</h1><p>It sounds evident but it’s certainly not. Applying <strong>transparent</strong> and <strong>clear</strong> naming conventions is often forgotten or poorly implemented. Especially when there is no central organ within an organization that sees to it that the conventions are correctly applied. The importance of naming conventions can’t be overestimated. Without them Azure subscriptions quickly become a mess of unrelated, unregulatable resources. </p>
<p>It’s very important that the naming conventions are consistent throughout the various subscriptions.<br>Often Infrastructure as Code (IAC) code, such as ARM templates or Azure CLI commands, is parameterized based on these conventions.<br>Its helps to <strong>reuse code</strong> and make <strong>fewer mistakes</strong>.</p>
<p>A naming convention is often a composition of properties that describe the Azure resource.<br>One composition that I often use is the following:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">env-company-businessunit-application-resourcetype-region-suffix</span><br></pre></td></tr></table></figure>

<p>Its made up out of several critical properties, some that are also used within some naming conventions proposed by <a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/azure/cloud-adoption-framework/ready/azure-best-practices/naming-and-tagging">the Microsoft documentation</a>.</p>
<table><tr><th>Property</th><th>Example</th><th>Abbreviation</th></tr><tr><td>Environment</td><td>Production</td><td>p</td></tr><tr><td>Company</td><td>Cloud Republic B.V.</td><td>clr</td></tr><tr><td>Business unit</td><td>Development</td><td>dev</td></tr><tr><td>Application</td><td>Customer Portal</td><td>csp</td></tr><tr><td>Resource type</td><td>Resource Group</td><td>rg</td></tr><tr><td>Region</td><td>West Europe</td><td>weu</td></tr><tr><td>Suffix</td><td>001</td><td>001</td></tr></table>

<p><strong>Resulting in this name</strong>:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">p-clr-dev-csp-rg-weu-001</span><br></pre></td></tr></table></figure>

<p>Applying the same naming conventions throughout the whole organization can be very useful. Organizations often end up building tooling to automate development processes and workflows. Without a consistent and clear naming convention this can be very hard. Secondly having a consistent and clear naming convention can help to reduce security issues. For Ops-people it has to be clip and clear if the resource is a production one and if its vital to the organization. With the right naming its easier to categorize resources.</p>
<h2 id="Some-generic-tips-for-composing-a-naming-convention"><a href="#Some-generic-tips-for-composing-a-naming-convention" class="headerlink" title="Some generic tips for composing a naming convention"></a>Some generic tips for composing a naming convention</h2><ol>
<li>Start with the environment property because its often the only parameterized property. This reduces the need for string concatenation within IaC code.</li>
<li>Use 3 or 4 letter abbreviations consistently throughout all properties.</li>
<li>Use the resource abbreviations <a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/azure/cloud-adoption-framework/ready/azure-best-practices/naming-and-tagging#recommended-resource-type-prefixes">proposed by Microsoft</a>.</li>
<li>Add a suffix because it may occur that a resource name is locked for a significant amount of time when its deleted.<ul>
<li>This happened to me once when I tried to recreate an Azure Service Bus. The name was locked for 2 days.</li>
</ul>
</li>
<li>Use all lower cases characters, <a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/azure/architecture/best-practices/resource-naming">there are some restrictions</a>.</li>
<li>Don’t use special characters, only alphanumeric characters. Hyphen (-) excluded.</li>
<li>Try to be unique<ul>
<li>Some resource names, such as PaaS services with public endpoints or virtual machine DNS labels, have global scopes, which means that they must be unique across the entire Azure platform.</li>
</ul>
</li>
</ol>
<h1 id="3-Take-precautions-with-Blueprints-Policies"><a href="#3-Take-precautions-with-Blueprints-Policies" class="headerlink" title="3. Take precautions with Blueprints / Policies"></a>3. Take precautions with Blueprints / Policies</h1><figure><img src="/images/governance/azure-gov.png" style="width:600px" /><figcaption style="font-style: italic; text-align: center;">[Azure Governance Architecture](https://www.microsoft.com/en-us/us-partner-blog/2019/07/24/azure-governance)</figcaption></figure>

<p>There are several ways to create Azure resources, namely via the Azure portal, ARM templates, Azure CLI or via Powershell. In all cases its very important that Azure resources are created in a controlled manner. We often see organizations struggling with compliance and governance, especially when an organization wants to get back in control after a period of experimenting and starting.</p>
<p>Its very important to adopt the major DevOps practices to truely get back in control. Some practices that really relate to governance are the following.</p>
<ol>
<li>Version control</li>
<li>Continuous integration</li>
<li>Continuous delivery</li>
<li>Infrastructure as Code</li>
<li>Monitoring and logging</li>
</ol>
<p>These practices all point to a set of underlying principles, namely: traceability and accountability and the least access principle.</p>
<h2 id="Traceability-and-accountability"><a href="#Traceability-and-accountability" class="headerlink" title="Traceability and accountability"></a>Traceability and accountability</h2><p><strong>Version control</strong> and CI/CD enables organizations to get in control of the artifacts that are being deployed in their cloud environment. With an DevOps platform like Azure Devops its very easy to setup source code repositories (with for instance Git) to take care of an organizations source code. Version control helps organizations to collaboratively work on code in a controlled way. </p>
<p>With <strong>continuous integration</strong> organizations can continuously check the status of their code. Does the latest change negatively or positively impacted the quality of the code? With static code analysis and automated testing with for instance unit testing the quality of the code can be made deterministic. Did the unit test code coverage increase or decrease with the latest change? And did we have more or less compiler warnings?</p>
<p>With <strong>continuous delivery</strong> organizations can continuously deploy their artifacts to a testing environment. Getting the feedback loop as quick as possible boosts the quality of an Agile development cycle. It enables testers to test a developers work earlier and also it enables product owners and stakeholders to provide feedback earlier. Lastly setting up a delivery pipeline to for instance Azure reduces the amount of deployment mistakes. Once the delivery pipeline is setup it should also work for production.</p>
<p>With <strong>infrastructure as code (IaC)</strong> organizations can make sure that the created resources in Azure are consistent and reliable. IaC enables developers to specify the infrastructure needed for their applications in code. This can either be template like for instance an JSON ARM template, but it can also be a script with Azure CLI or Azure Powershell. It’s also possible to use cloud independent tools like Terraform, Ansible or Pulumi. In all cases automation accounts are used to create or update resources in Azure. Secondly within your DevOps platform, like Azure DevOps you can make sure that this IaC code is reviewed by at least 2 people and use Continuous delivery pipelines to execute the IaC code against your Azure subscriptions.</p>
<p>With <strong>monitoring and logging</strong> organizations can get continuous feedback on the health, performance and reliability of their applications. With a good governance framework in place organizations will use the monitoring dashboards as a primary source of information for their production applications. When RBAC is taking care of developers are typically not authorized to sneak and peek into production. More on that in the least access principle.</p>
<h2 id="Least-access-principle"><a href="#Least-access-principle" class="headerlink" title="Least access principle"></a>Least access principle</h2><p>One very important principle which is truely going to impact your business, both in a developers mindset way but also in a procedural way, is the <strong>least access principle</strong>. Basically it comes down to the fact that no developer has access to read or modify production related resources. DevOps-engineers should use monitoring and logging to get a sense of how table their production applications are running. With this measure we tackle two very important, namely: GPDR law and unintended production disorders.</p>
<p>When DevOps-engineers can’t touch production and are obligated to work via the CI/CD pipelines and use monitoring then they are going to think different. Initially they might slow down but eventually they will test better and add better monitoring and logging to get insights into their applications. You don’t want your engineers to run blind and therefore implementing this measure requires true care. You can start with taking away their contributor rights and let them fix issues via the CI/CD pipeline.</p>
<h3 id="Temporary-access-via-Privileged-Identity-Management"><a href="#Temporary-access-via-Privileged-Identity-Management" class="headerlink" title="Temporary access via Privileged Identity Management"></a>Temporary access via Privileged Identity Management</h3><p>Of course we understand that sometimes when a production issue occurs DevOps-engineers have to look into the Azure resources manually. Ideally this is not what you want since how do you know they don’t break other things? How do you know that they do not get access data privacy related data and so on. However sometimes its necessary, especially when the logging isn’t suffice.</p>
<p>Azure Active Directory has a great feature for this scenario, its called Privileged Identity Management, short PIM. With PIM administrators can give <strong>just-in-time</strong> role assignments to DevOps-engineers. The role assignments can be <strong>time-bound</strong> so that the role assignments will be resigned after a given period of time. Secondly a very important feature for GPDR and the Dutch AVG privacy laws is the <strong>audit history</strong>. An admin can download an audit history for the temporary elevated privileges, this can be needed for audits regarding privacy and security.</p>
<h2 id="So-what-are-Azure-Policy-and-Azure-Blueprints"><a href="#So-what-are-Azure-Policy-and-Azure-Blueprints" class="headerlink" title="So what are Azure Policy and Azure Blueprints?"></a>So what are Azure Policy and Azure Blueprints?</h2><p>So once you’ve setup the DevOps practices you can apply Azure policies and blueprints to further secure your Azure environment and ensure compliance. Policies are basically a set of rules to which an Azure resource has to comply. Think about tagging your Azure resources with costs center tags or maybe you want to enable SSL/TLS for all web traffic and disable plain Http encrypted traffic. You can enforce this with Azure Policy. </p>
<p>Blueprints on the other hand are more a template sort of functionality. It enables organizations to define a way of setting up Azure resources, a default way of setting up for instance a SQL Server with a Web App. Complying to the set of rules defined by your organization, like for instance default SSL/TLS, always encrypted databases, integrated Active Directory authentication and so on. This helps to prevent that Azure resources are being created that do not comply to your policies.</p>
<p><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/azure/devops/learn/what-is-devops">https://docs.microsoft.com/en-us/azure/devops/learn/what-is-devops</a><br><a target="_blank" rel="noopener" href="https://www.microsoft.com/en-us/us-partner-blog/2019/07/24/azure-governance">https://www.microsoft.com/en-us/us-partner-blog/2019/07/24/azure-governance</a></p>
<h1 id="4-Bring-logic-in-the-universe-with-Azure-Resource-Groups"><a href="#4-Bring-logic-in-the-universe-with-Azure-Resource-Groups" class="headerlink" title="4. Bring logic in the universe with Azure Resource Groups"></a>4. Bring logic in the universe with Azure Resource Groups</h1><figure><img src="/images/governance/resource-group-example.png" style="width:600px" /><figcaption style="font-style: italic; text-align: center">Azure Resource Groups example</figcaption></figure>

<p>Setting up resource groups in Azure sounds like a next-next-finish exercise, however in practice it can be very difficult to come up with a clear and understandable setup of your resource groups. A rule of thumb that you can use is that <strong>a resource group should always be a single unit of deployment</strong>. In the example above I have tried to come up with a clear example.</p>
<p>Let’s say you are building a portal. Its build with React and an ASP.net core backend. Ideally you want to be able to deploy the backend API separately from your front-end single page application. Its then fundamental to split those resources up into 2 separate resource groups. In the naming scheme we have used the following pattern: environment-company-production-resource-region-suffix, where the company, Cloud Republic is abbreviated to: clr and the product portal to: por and the financial module to: fin. </p>
<p>With this resource groups are a logical set up Azure resources that are deployed as a single unit. <strong>Secondly resource groups are linked with their names to collectively form a product</strong>. This helps for instance Ops-engineers to determine to importance of the Azure resources and take the necessary steps.</p>
<h1 id="5-Add-security-with-Role-based-Access-Control-RBAC"><a href="#5-Add-security-with-Role-based-Access-Control-RBAC" class="headerlink" title="5. Add security with Role based Access Control (RBAC)"></a>5. Add security with Role based Access Control (RBAC)</h1><figure><img src="/images/governance/rbac-overview.png" style="width:400px" /><figcaption style="font-style: italic; text-align: center;">[Azure - Role Bassed Access Control](https://docs.microsoft.com/en-us/azure/role-based-access-control/overview)</figcaption></figure>

<p>One of the key pillars of any governance framework is an authorization / authentication framework. In Azure its tightly linked with Azure Active Directory and how that integrates with Azure resources. In essence there are 4 types of security principals namely: <strong>users</strong>, <strong>groups</strong>, <strong>service principals</strong> and <strong>managed identities</strong>. Those service principals are then <strong>assigned a role</strong>, typically: <strong>owner</strong>, <strong>contributor</strong> or <strong>reader</strong> to a specific scope. Let’s say a resource group or subscription.</p>
<h2 id="Users-and-groups"><a href="#Users-and-groups" class="headerlink" title="Users and groups"></a>Users and groups</h2><p>Having a clear separation between production and dev/test workloads helps to arrange the right RBAC implementation. For dev and test subscription you might want to assign everyone the contributor role to the whole subscription. In acceptance workloads you might want to narrow down the role assignments to teams of DevOps-engineers being having reader role assignments to their resource groups. And in production you only want maybe first line of support engineers to have reader role assignments.</p>
<p>When DevOps-engineers are assigned roles to certain Azure scopes its very important to create logical groups of users, and then assign the roles to those groups instead of to users directly. If an admin assigns roles directly to users it will quickly become a clumsy mess of role assignments, and people eventually will get access to the Azure resources which they should not get access to.</p>
<h2 id="Managed-identities"><a href="#Managed-identities" class="headerlink" title="Managed identities"></a>Managed identities</h2><p>Managed identities are basically security principals that behave on behalf of applications. These managed identities and their role assignments should always be created through Infrastructure as Code. Redeploying applications should never break these identities. </p>
<h2 id="Service-principals"><a href="#Service-principals" class="headerlink" title="Service principals"></a>Service principals</h2><p>Service principals on the other hand are Azure security principals that are used to connected other services to the Azure environment. Its often used to connect Azure Devops pipeliens to an Azure account. Its very important that these service principals do not become God accounts. Its a common mistake to allow the service principals on the whole subscription. One should always narrow the scope of such a service principals to the resource groups a team should have access to. Secondly the service principals will have access to production application. If a developer has access to the service principals via for instance Azure DevOps pipelines then the engineer basically has delegated production rights. Administrators therefore have to take care of the Azure DevOps roles and rights as well. The rule of thumb that we use alot is that every change has to be seen by 2 sets of eyes. So a DevOps-engineer should never be able to release anything into production without having an extra peer review. This especially counts for edits on the release pipelines, that’s why Yaml release pipelines are such a great feature.</p>
<h1 id="6-Tag-your-resources-to-get-insights"><a href="#6-Tag-your-resources-to-get-insights" class="headerlink" title="6. Tag your resources to get insights"></a>6. Tag your resources to get insights</h1><p>Tagging resources can help to identify important properties of Azure resources. Its often used as a type of documentation for Azure resources. Most of the time a tag is correlated to either: accountability, costs or reliability, but other categories can be useful as well. With accountability tags we often try to answer questions like: Who created this resource? Who should we contact if anything happens? Which business unit is accountable? And additionally some tracability. For costs related tags we often try to answer questions like: Who is paying for the resource? Which budget does it relate to? And lastly with reliability tags we answers questions like: What is the expected uptime? Is this resource business critical? What needs to happen when a disaster happens?</p>
<p>You can use the template below as a starting point (<a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/azure/cloud-adoption-framework/ready/azure-best-practices/naming-and-tagging]">copied from Microsoft</a>).</p>
<table><tr><th>Accountability</th><th>Costs</th><th>Reliablity</th></tr><tr><td>Start date of the project</td><td>Budget required/approved</td><td>Disaster recovery</td></tr><tr><td>End date of the project</td><td>Cost center</td><td>Service class</td></tr><tr><td>Application name</td><td>Environment deployment</td><td></td></tr><tr><td>Approver name</td><td></td><td></td></tr><tr><td>Requester name</td><td></td><td></td></tr><tr><td>Owner name</td><td></td><td></td></tr><tr><td>Business unit</td><td></td><td></td></tr></table>

<h1 id="7-Monitor-with-Azure-security-center"><a href="#7-Monitor-with-Azure-security-center" class="headerlink" title="7. Monitor with Azure security center"></a>7. Monitor with Azure security center</h1><p>One way of monitoring the security of your Azure resources is with Azure security center. It continuously checks all your Azure resources and will come up with a secure score, recommendations, alerts and possible measures. It’s a costly feature but if security is a top priority for your organization then it can be very helpful. </p>
<figure><img src="/images/governance/security-center.png" /><figcaption style="font-style: italic; text-align: center;">Azure Security Center</figcaption></figure>

<h2 id="Alerts"><a href="#Alerts" class="headerlink" title="Alerts"></a>Alerts</h2><p>bla</p>
<h1 id="8-Automate-your-work-with-Azure-Automation"><a href="#8-Automate-your-work-with-Azure-Automation" class="headerlink" title="8. Automate your work with Azure Automation"></a>8. Automate your work with Azure Automation</h1><p>One helpful tool to apply governance measures at scale can be Azure Automation. It can help in several scenario’s ranging from adding tags to all Azure resources to fixing security center findings like outdated VM’s for instance. </p>
<h1 id="9-Lock-your-viable-resources"><a href="#9-Lock-your-viable-resources" class="headerlink" title="9. Lock your viable resources"></a>9. Lock your viable resources</h1><p>A quick win for organizations who start to implement the governance framework is to enable locking. With locking you can prevent developers or ops-engineers to accidently remove or edit Azure resources. This can be very helpful in securing critical production workloads. Within Azure there are 2 types of locks, namely: CanNotDelete and ReadOnly.</p>
<h2 id="CanNotDelete"><a href="#CanNotDelete" class="headerlink" title="CanNotDelete"></a>CanNotDelete</h2><p>CanNotDelete means that an authorized user is still able to read and modify the resource. However the user is not able to delete the resource without explicitly removing the lock first.</p>
<h2 id="ReadOnly"><a href="#ReadOnly" class="headerlink" title="ReadOnly"></a>ReadOnly</h2><p>ReadOnly means that an authorized user is able to read the resource but is not able to change or delete the resource. Effectively it restricts all users even admins to the Reader role.</p>
<h2 id="To-conclude-1"><a href="#To-conclude-1" class="headerlink" title="To conclude"></a>To conclude</h2><p>In my opinion resource locking is not something organizations have to implement in an ideal situation. When production workloads are separated in production subscriptions, and when RBAC is implement correctly then the need for Locking resources is minimal. However when organizations are in the beginning of applying this or any governance framework it can be a helpful instrument to prevent mistakes or to ensure business continuity.</p>
<!-- ### An example of locking a App Service via ARM
```json
{
    "type": "Microsoft.Web/sites/providers/locks",
    "apiVersion": "2016-09-01",
    "name": "[concat(variables('siteName'), '/Microsoft.Authorization/siteLock')]",
    "dependsOn": [
        "[resourceId('Microsoft.Web/sites', variables('siteName'))]"
    ],
    "properties": {
        "level": "CanNotDelete",
        "notes": "Site should not be deleted."
    }
}
``` -->

<h1 id="Further-reading"><a href="#Further-reading" class="headerlink" title="Further reading"></a>Further reading</h1><table><tr><th>Topic</th><th>Resource</th></tr><tr><td>Azure Accounts / Enterprise agreement</td><td>https://docs.microsoft.com/azure/azure-resource-manager/resourcemanager-subscription-governance</td></tr><tr><td>Naming conventions</td><td>https://docs.microsoft.com/azure/guidance/guidance-naming-conventions</td></tr><tr><td>Azure Blueprints</td><td>https://docs.microsoft.com/en-us/azure/governance/blueprints/overview</td></tr><tr><td>Azure policies</td><td>https://docs.microsoft.com/en-us/azure/governance/policy/overview</td></tr><tr><td>Resource tags</td><td>https://docs.microsoft.com/azure/azure-resource-manager/resourcegroup-using-tags</td></tr><tr><td>Resource groups</td><td>https://docs.microsoft.com/azure/azure-resource-manager/resourcegroup-overview</td></tr><tr><td>RBAC</td><td>https://docs.microsoft.com/azure/active-directory/role-based-accesscontrol-what-is</td></tr><tr><td>Azure locks</td><td>https://docs.microsoft.com/en-us/azure/azure-resource-manager/resource-group-lock-resources</td></tr><tr><td>Azure Automation</td><td>https://docs.microsoft.com/azure/automation/automation-intro</td></tr><tr><td>Security Center</td><td>https://docs.microsoft.com/azure/security-center/security-center-intro</td></tr></table>

<h2 id="References"><a href="#References" class="headerlink" title="References"></a>References</h2><p>A big inspiration for this blog comes from this article.<br><a target="_blank" rel="noopener" href="https://novacontext.com/azure-strategy-and-implementation">https://novacontext.com/azure-strategy-and-implementation</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://dibranmulder.github.io/2019/12/06/Applying-an-Azure-Governance-Framework-in-10-steps/" data-id="ckfdlvwy9000vfk492oxggrv3" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Azure/" rel="tag">Azure</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Blueprints/" rel="tag">Blueprints</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Compliance/" rel="tag">Compliance</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Governance-Framework/" rel="tag">Governance Framework</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Naming-conventions/" rel="tag">Naming conventions</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Policies/" rel="tag">Policies</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Resource-groups/" rel="tag">Resource groups</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Running-an-OpenAI-Gym-on-Windows-with-WSL" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/09/06/Running-an-OpenAI-Gym-on-Windows-with-WSL/" class="article-date">
  <time datetime="2019-09-06T14:17:55.000Z" itemprop="datePublished">2019-09-06</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/09/06/Running-an-OpenAI-Gym-on-Windows-with-WSL/">Running an OpenAI Gym on Windows with WSL</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Recently, I have been playing with Artifical Intelligence a little bit. I want to take on this subject a little bit more serious and I was looking for a playground to combine gaming with AI, to make it fun. I came accross the <a target="_blank" rel="noopener" href="https://github.com/openai/gym">OpenAI Gym</a> which has a built in Atari simulator! How cool is it to write an AI model to play Pacman. </p>
<p>I’m a Windows power user, always have been. I have tried Ubuntu and MacOS but those don’t cut it for me. However the Atari simulator is only supported for Linux, so I have to use Linux. Recently I have heard about WSL (Windows Subsystem for Linux) which is a lite weight way of running Ubuntu on Windows. I thought I’d use that, but sadly it doesn’t bring an UI, and I need one to see Pacman crushing those ghosts. But I managed to fix that.</p>
<p>In this blogpost I’ll show you how to run an OpenAI Gym Atari Emulator on WSL with an UI. Secondly I’ll show you how to run Python code against it. This blogpost doesn’t include the AI part because I still have to learn it :)</p>
<h2 id="Install-Ubuntu-on-WSL-for-Windows"><a href="#Install-Ubuntu-on-WSL-for-Windows" class="headerlink" title="Install Ubuntu on WSL for Windows"></a>Install Ubuntu on WSL for Windows</h2><p>First of all we have to enable WSL in Windows, you can simply do that by executing the following Powershell code in Admin mode.</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Enable-WindowsOptionalFeature</span> <span class="literal">-Online</span> <span class="literal">-FeatureName</span> Microsoft<span class="literal">-Windows</span><span class="literal">-Subsystem</span><span class="literal">-Linux</span></span><br></pre></td></tr></table></figure>

<p>After that you can install a Linux distro. I took the <code>Ubuntu 18.04 LTS</code> version. You can easily install it via the <a target="_blank" rel="noopener" href="https://www.microsoft.com/en-us/p/ubuntu-1804-lts/9n9tngvndl3q?activetab=pivot:overviewtab">Microsoft Store</a>. Don’t forget to execute the following Powershell in Admin mode to enable WSL in Windows.</p>
<p>Once Ubuntu is installed it will prompt you for an admin username and password. After that make sure to update and upgrade Ubuntu, using the following bash command. </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get update &amp;&amp; sudo apt-get upgrade -y &amp;&amp; sudo apt-get upgrade -y &amp;&amp; sudo apt-get dist-upgrade -y &amp;&amp; sudo apt-get autoremove -y</span><br></pre></td></tr></table></figure>

<p><em>For a complete guide on installing WSL on Windows please visit this <a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/windows/wsl/install-win10">website</a></em>.</p>
<h2 id="Screen-mirroring"><a href="#Screen-mirroring" class="headerlink" title="Screen mirroring"></a>Screen mirroring</h2><p>Now that we’ve got WSL running on Windows its time to get the UI working. WSL doesn’t come with a graphical user interface. OpenAI Gym however does require a user interface. We can fix that with mirroring the screen to a X11 display server. With X11 you can add a remote display on WSL and a X11 Server to your Windows machine. With this UI can be mirrored to your Windows host.</p>
<p>First of all we need a X11 Server for Windows. I used the <a target="_blank" rel="noopener" href="https://sourceforge.net/projects/xming/">Xming X Server for Windows</a>. Download it and install it on your host machine.</p>
<p>After that we have to link the WSL instance to the remote display server, running on Windows. Execute the following code inside your WSL terminal.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">&quot;export DISPLAY=localhost:0.0&quot;</span> &gt;&gt; ~/.bashrc</span><br></pre></td></tr></table></figure>
<p>After that restart the bash terminal or execute this command.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">. ~/.bashrc</span><br></pre></td></tr></table></figure>

<p>It’s as simple as that. You can test if the mirroring works by installing for instance the X11 Apps. It comes with a funny demo application. </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install x11-apps</span><br><span class="line"><span class="comment"># Start a demo application</span></span><br><span class="line">xeyes</span><br></pre></td></tr></table></figure>

<img src="/images/wsl/xeyes.png" />

<p>The last thing you have to install is OpenGL for Python. OpenAI Gym uses OpenGL for Python but its not installed in WSL by default.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install python-opengl</span><br></pre></td></tr></table></figure>

<h2 id="Anaconda-and-Gym-creation"><a href="#Anaconda-and-Gym-creation" class="headerlink" title="Anaconda and Gym creation"></a>Anaconda and Gym creation</h2><p>Now that we’ve got the screen mirroring working its time to run an OpenAI Gym. I use Anaconda to create a virtual environment to make sure that my Python versions and packages are correct.</p>
<p>First of all install Anaconda’s dependencies.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install cmake zlib1g-dev xorg-dev libgtk2.0-0 python-matplotlib swig python-opengl xvfb</span><br></pre></td></tr></table></figure>
<p>After that download the shell script for Anaconda and install it.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Download Anaconda</span></span><br><span class="line">wget https://repo.continuum.io/archive/Anaconda3-5.2.0-Linux-x86_64.sh</span><br><span class="line"><span class="comment"># Make it executable.</span></span><br><span class="line">chmod +x Anaconda3-5.2.0-Linux-x86_64.sh</span><br><span class="line"><span class="comment"># Execute it.</span></span><br><span class="line">./Anaconda3-5.2.0-Linux-x86_64.sh</span><br></pre></td></tr></table></figure>
<p>Refresh the bash or start the terminal.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">. ~&#x2F;.bashrc</span><br></pre></td></tr></table></figure>

<p>Now that we’ve got Anaconda installed we can create a virtual environment. Use Python 3.5 because the OpenAI Gym supports that version.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Create the environment</span></span><br><span class="line">conda create --name gym python=3.5</span><br><span class="line"><span class="comment"># Activate the environment</span></span><br><span class="line"><span class="built_in">source</span> activate gym</span><br></pre></td></tr></table></figure>

<p>Now that we are inside the environment its time to install the OpenAI Gym package. You can do that by simply executing this code.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Install the gym package</span></span><br><span class="line">(gym) user@machine: pip install gym</span><br><span class="line"><span class="comment"># Install the Atari simulator</span></span><br><span class="line">(gym) user@machine: pip install gym[atari]</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>You should be ready! You can now create a Python file with a simple loop that creates a random input for the pacman.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(gym) user@machine: touch test.py</span><br><span class="line">(gym) user@machine: nano test.py</span><br></pre></td></tr></table></figure>

<p>With the following code.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> gym</span><br><span class="line">env = gym.make(<span class="string">&#x27;MsPacman-v0&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(num_episodes):</span><br><span class="line">    state = env.reset()</span><br><span class="line">    totalReward = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> _ <span class="keyword">in</span> range(<span class="number">1000</span>):</span><br><span class="line">        env.render()</span><br><span class="line"></span><br><span class="line">        <span class="comment"># take a random action</span></span><br><span class="line">        randomAction = env.action_space.sample()</span><br><span class="line">        observation,reward,done,info = env.step(randomAction) </span><br><span class="line"></span><br><span class="line">        time.sleep(<span class="number">0.1</span>)</span><br><span class="line">        totalReward += reward</span><br><span class="line"></span><br><span class="line">    print(<span class="string">&#x27;Episode&#x27;</span>, i,<span class="string">&#x27;, Total reward:&#x27;</span>, totalReward)</span><br><span class="line"></span><br><span class="line">env.close()</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<img src="/images/wsl/pacman.png" />

<h2 id="VS-Code"><a href="#VS-Code" class="headerlink" title="VS Code"></a>VS Code</h2><p>Working with Nano is a pain in the ass. I prefer VS Code as a development environment. Luckily VS Code comes with a great extension for WSL development called <a target="_blank" rel="noopener" href="https://marketplace.visualstudio.com/items?itemName=ms-vscode-remote.remote-wsl">Remote - WSL</a>. You can simply install it and connect with a WSL environment.</p>
<img src="/images/wsl/wsl connected.png" />

<p>Thats about it! Happy coding.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://dibranmulder.github.io/2019/09/06/Running-an-OpenAI-Gym-on-Windows-with-WSL/" data-id="ckfdlvwxn000jfk49ck3x4lst" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/AI/" rel="tag">AI</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Linux/" rel="tag">Linux</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/OpenAI/" rel="tag">OpenAI</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Tensorflow/" rel="tag">Tensorflow</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/WSL/" rel="tag">WSL</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Sending-e-mails-with-SendGrid-and-Azure-Functions" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/08/23/Sending-e-mails-with-SendGrid-and-Azure-Functions/" class="article-date">
  <time datetime="2019-08-23T10:44:16.000Z" itemprop="datePublished">2019-08-23</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/08/23/Sending-e-mails-with-SendGrid-and-Azure-Functions/">Sending e-mails with SendGrid and Azure Functions</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>In this blogpost I’ll show how to send e-mails with SendGrid and Azure Functions.<br>The goal is to send an email like this, stating in Dutch that some products that people are selling are hijacked.<br><img src="/images/sendgrid/email.png" /></p>
<h2 id="SendGrid-in-Azure"><a href="#SendGrid-in-Azure" class="headerlink" title="SendGrid in Azure"></a>SendGrid in Azure</h2><p>First or all we need a SendGrid instance, you can simply create one using the Azure Portal. But who uses the portal to create Azure services? If you’re still doing that you probably have a completely unmanged Azure subscription and you have no control over it. So start using Azure ARM templates or Azure CLI! SendGrid has a nice free tier. </p>
<img src="/images/sendgrid/pricing.png" />

<h2 id="ARM"><a href="#ARM" class="headerlink" title="ARM"></a>ARM</h2><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;[parameters(&#x27;sendgridAccountName&#x27;)]&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;Sendgrid.Email/accounts&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;location&quot;</span>: <span class="string">&quot;[resourceGroup().location]&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;apiVersion&quot;</span>: <span class="string">&quot;2015-01-01&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;plan&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;free&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;publisher&quot;</span>: <span class="string">&quot;Sendgrid&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;product&quot;</span>: <span class="string">&quot;sendgrid_azure&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;promotionCode&quot;</span>: <span class="string">&quot;&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;properties&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;password&quot;</span>: <span class="string">&quot;[parameters(&#x27;sendgridPassword&#x27;)]&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;acceptMarketingEmails&quot;</span>: <span class="string">&quot;0&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;email&quot;</span>: <span class="string">&quot;&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Azure-Function"><a href="#Azure-Function" class="headerlink" title="Azure Function"></a>Azure Function</h2><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">FunctionName(<span class="meta-string">&quot;SendHijackMails&quot;</span>)</span>]</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task <span class="title">SendHijackAlertsAsync</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    [ServiceBusTrigger(</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="string">&quot;hijack-alert&quot;</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">        Connection = <span class="string">&quot;ServiceBusConnectionString&quot;</span></span>)] Message updatedMessage,</span></span><br><span class="line"><span class="function">    [<span class="title">SendGrid</span>(<span class="params">ApiKey = <span class="string">&quot;SendGridApiKey&quot;</span></span>)] IAsyncCollector&lt;SendGridMessage&gt; messageCollector,</span></span><br><span class="line"><span class="function">    ILogger log) </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">var</span> hijackedAlert = JsonConvert.DeserializeObject&lt;HijackedAlert&gt;(</span><br><span class="line">                    Encoding.UTF8.GetString(updatedMessage.Body));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> msg = <span class="keyword">new</span> SendGridMessage();</span><br><span class="line">    msg.AddTo(hijackedAlert.Email, <span class="string">$&quot;<span class="subst">&#123;hijackedAlert.FirstName&#125;</span> <span class="subst">&#123;hijackedAlert.LastName&#125;</span>&quot;</span>);</span><br><span class="line">    msg.From = <span class="keyword">new</span> EmailAddress(<span class="string">&quot;info@somecompany.com&quot;</span>);</span><br><span class="line">    msg.TemplateId = <span class="string">&quot;d-sampletemplateId&quot;</span>;</span><br><span class="line"></span><br><span class="line">    msg.SetTemplateData(<span class="keyword">new</span> DynamicTemplateData()</span><br><span class="line">    &#123;</span><br><span class="line">        Products = hijackedAlert.Products.Select(x =&gt; <span class="keyword">new</span> EmailProduct()</span><br><span class="line">        &#123;</span><br><span class="line">            Name = x.Product?.Title,</span><br><span class="line">            Url = x.Product?.Url,</span><br><span class="line">            ProductId = x.ProductId</span><br><span class="line">        &#125;).ToArray()</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">await</span> messageCollector.AddAsync(msg);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="Handelbar-syntax"><a href="#Handelbar-syntax" class="headerlink" title="Handelbar syntax"></a>Handelbar syntax</h2><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span>&gt;</span><span class="tag">&lt;<span class="name">strong</span>&gt;</span>Hijackt alert<span class="tag">&lt;/<span class="name">strong</span>&gt;</span>- Sellest.io heeft geconstateerd dat er nieuwe aanbieders zijn gevonden voor de volgende producten:<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">ul</span>&gt;</span></span><br><span class="line">&#123;&#123;#each products&#125;&#125;</span><br><span class="line"><span class="tag">&lt;<span class="name">li</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;https://app.sellest.io/#/product/&#123;&#123;this.productId&#125;&#125;&quot;</span>&gt;</span>&#123;&#123;this.name&#125;&#125;<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">&#123;&#123;/each&#125;&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br></pre></td></tr></table></figure>


      
    </div>
    <footer class="article-footer">
      <a data-url="https://dibranmulder.github.io/2019/08/23/Sending-e-mails-with-SendGrid-and-Azure-Functions/" data-id="ckfdlvwxq000lfk499vqog5eh" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Azure-Functions/" rel="tag">Azure Functions</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/SendGrid/" rel="tag">SendGrid</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Autonoom-rijden" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/08/16/Autonoom-rijden/" class="article-date">
  <time datetime="2019-08-15T22:00:00.000Z" itemprop="datePublished">2019-08-16</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/08/16/Autonoom-rijden/">Autonoom rijden</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><em>Dibran over Artificial Intelligence</em>.<br>Dit is de eerste blog in de serie: “Dibran over Artificial Intelligence”, een serie blogs waarin ik dieper in ga op de hedendaagse mogelijkheden en toepassingen van artificial intelligence (kunstmatige intelligentie). Omdat het taalgebruik in het software- en artificial intelligencevakgebied doorgaans Engels is zal ik in mijn blogs ook de Engelse benamingen gebruiken.</p>
<h2 id="Wat-is-autonoom-rijden"><a href="#Wat-is-autonoom-rijden" class="headerlink" title="Wat is autonoom rijden?"></a>Wat is autonoom rijden?</h2><p>We horen in de media veel over autonoom rijden, bijna alle autofabrikanten zijn er mee bezig maar hoe ver zijn ze eigenlijk? En wanneer kunnen we echt slapend op de achterbank naar ons werk rijden? Hoe werkt het eigenlijk? In deze blogpost geef ik antwoord op deze vragen.</p>
<p>Autonoom rijden is opgedeeld in 5 levels(niveaus). Van geheel handmatig rijden tot volledig automatisch. Er is nog geen enkele auto in de wereld, ook geen test auto’s, die al level 5 hebben gehaald. Dit komt omdat een level 5 auto overal ter wereld zelfstandig moet kunnen rijden, dus van hartje Amsterdam tot de wegen in Afrika. Daarnaast moet het ook om kunnen gaan met allerlei omstandigheden, zoals: sneeuw, extreme regenval, wegwerkzaamheden, etc.</p>
<img src="/images/selfdriving/levels.png" />

<h3 id="Autonoom-rijden-in-de-praktijk"><a href="#Autonoom-rijden-in-de-praktijk" class="headerlink" title="Autonoom rijden in de praktijk"></a>Autonoom rijden in de praktijk</h3><p>De meeste toepassingen van autonoom rijden die we vandaag de dag zien zijn op level 2 of 3 niveau. Vaak wordt de combinatie van een ‘x’ aantal functies omgedoopt tot een nieuwe term als “autopilot” of iets vergelijkbaars. In de praktijk is het eigenlijk een combinatie van ingeschakelde functies waardoor de auto in bepaalde omstandigheden zelfstandig kan rijden. Omdat Tesla de meeste informatie deelt en ook het meest ver is met haar implementatie neem ik Tesla als voorbeeld. De autopilot van Tesla is momenteel een combinatie van de volgende functies: Traffic-Aware Cruise Control, Autosteer, Auto Lane Change, Side Collision Warning, Automatic Emergency Braking. Daarnaast omvat het ook nog overige functies zoals AutoPark en Summon.</p>
<p>De autopilot staat niet standaard aan wanneer de auto wordt gestart. De bestuurder kan op een snelweg de autopilot aanzetten, ook wel ‘engagen’ genoemd. De auto zal dan op basis van het niveau van zelfrijden automatisch afstand houden met de voorganger en automatisch sturen. Sommige auto’s zoals de Mercedes E-Klasse en de Tesla’s kunnen ook automatisch van rijbaan wisselen wanneer de bestuurder de richtsaanwijzer een paar seconden vasthoudt. De auto gebruikt dan zijn sensoren om te bepalen of de weg naast de auto beschikbaar is en sturen dan zelf naar de gewenste rijbaan. Dit is typisch een voorbeeld van level 2 autonomie. Onlangs heeft Tesla Auto Lane Change uitgebracht. Hierdoor hoeft de bestuurder niet meer zijn richtsaanwijzer te gebruiken om van rijbaan te wisselen, de auto bepaalt dan namelijk zelf wanneer het moet wisselen van rijbaan. Het idee is dat hiermee een Tesla zelfstandig op en afritten kan nemen op de snelweg, ook is het in staat op langzaam verkeer zoals vrachtwagens in te halen. Dit is een typisch voorbeeld van een level 3 feature.</p>
<img src="/images/selfdriving/autopilot.jpg" />

<p>Wanneer de auto de situatie niet meer kan inschatten zal het de besturing aan de gebruiker teruggeven. Dit gebeurt ook wanneer de gebruiker zelf gaat sturen of wanneer het op de rem trapt. Dit moment noemen we ‘disengagen’. Disengage momenten zijn belangrijk om van te leren vooral wanneer de bestuurder de controle overneemt over het voertuig. Veel autofabrikanten zullen de data van de sensoren bewaren om disengage momenten later te evalueren.</p>
<p>Momenteel is het zo dat de bestuurder moet opletten wanneer autopilot is ingeschakeld. De bestuurder moet zelfs het stuur af en toe vasthouden om aan te geven dat het nog oplet. Wanneer de bestuurder dit signaal negeert zal de auto hem waarschuwen, door flitsende meldingen en geluidsindicaties. Als de gebruiker weigert om het stuur vast te houden dan wordt disengage geforceerd en is autopilot voor de rest van de rit uitgeschakeld.</p>
<p>Vooralsnog zijn er weinig autofabrikanten die een auto met autopilot of vergelijkbare functionaliteit bieden. Het hogere segment van de auto’s van Volvo, Audi en Volkswagen hebben vaak wel een uitgebreide suite aan functies die op level 2 niveau zitten. Bijvoorbeeld adaptive cruise control en soms zelfs lane keeping. Echter er zijn weinig auto’s op de markt die dit combineren in een zelfrijdende modus.</p>
<h2 id="Hoe-werkt-autonoom-rijden"><a href="#Hoe-werkt-autonoom-rijden" class="headerlink" title="Hoe werkt autonoom rijden?"></a>Hoe werkt autonoom rijden?</h2><p>Een mens gebruikt zijn cognitieve zintuigen om een auto te besturen. Vanzelfsprekend is het gezichtsvermogen het belangrijkste zintuig voor het besturen van een auto. Met ons zicht zijn wij in staat om te bepalen hoe de weg loopt, diepte in te schatten en gevaren te herkennen. Met ons zicht, gehoor en tast verzamelen wij doorgaans genoeg informatie om een veilige autoreis te maken.</p>
<img src="/images/selfdriving/auto sight.png" />

<p>Toch is de mens niet perfect, los van domme beslissen is ons gezichtsveld namelijk vrij beperkt. Met spiegels hebben we dit gedeeltelijk opgelost, echter het is voor ons onmogelijk om telkens alle informatie te verzamelen. We kunnen maar 1 van de 4 gezichtsvelden tot ons nemen. Door periodiek alle informatiekanalen af te scannen krijgen we toch een vrij compleet beeld van onze omgeving.</p>
<p>Bij een autonome auto gaat het in essentie hetzelfde. Een auto wordt verrijkt met tal van sensoren waarmee genoeg informatie verzameld wordt om de omgeving van de auto in kaart te brengen. Deze ruwe data wordt ter plekke, in de auto, verwerkt door machine learning software. Dit levert een soort van kunstmatige menselijke intelligentie ervaring op die we doorgaans artificial intelligence noemen.</p>
<h3 id="Sensoren"><a href="#Sensoren" class="headerlink" title="Sensoren"></a>Sensoren</h3><p>Je hebt meerdere sensoren nodig om een auto autonoom te laten rijden. Niet alle fabrikanten gebruiken dezelfde sensoren, wat dit onderwerp an sich al tot een interessant onderwerp van discussie maakt. Het doel van de sensoren is om onder alle omstandigheden een juiste representatie te kunnen maken van de omgeving van de auto. Dit betekent dat de sensoren moeten kunnen werken, in het donker, in sneeuw, hevige regenval, felle zonneschijn, etc.</p>
<img src="/images/selfdriving/sensorscar.png" />

<p>Alle huidige toepassingen van autonoom rijdende auto’s maken gebruik van camera’s. In het geval van Tesla zitten er 8 camera’s in een auto. Deze camera’s hebben gezamenlijk een 360° beeld rondom de auto. Afhankelijk van de kijkrichting is het een camera van hogere kwaliteit waardoor het verder weg ook scherp kan zien.</p>
<p>Naast camera’s zien we nog meer sensoren die gebruikt worden. In het geval van Tesla worden ook nog radar en ultrasonics gebruikt. Met een radar kunnen objecten in de ruimte voor de auto gedetecteerd worden. Het mooie aan een radar sensor is dat het door fysieke objecten heen kan meten. Als het bijvoorbeeld heel hard regent, of er is mist dan kan de radar toch detecteren of er objecten in de buurt zijn. Vaak zit de radar alleen aan de voorkant van de auto. We zien bij veel auto’s dat de voorkant van de auto de meeste sensoren heeft, logisch aangezien daar de meest belangrijke informatie vandaan komt.</p>
<p>Ultrasonics kennen we van de parkeersensoren in onze huidige auto’s. Het is voor camera’s vrij moeilijk te detecteren of er een object naast de auto staat als hij heel dicht naast de auto staat. In het geval van Tesla zitten er 12 ultrasonics in de auto waarmee objecten in de nabije omgeving van de auto ook gedetecteerd kunnen worden.</p>
<blockquote>
<p>“Lidar vs Vision”</p>
</blockquote>
<p>Een verhitte discussie onder onderzoekers en ontwikkelaars van zelfrijdende auto’s is het gebruik van Lidar. Lidar is in wezen een soort van radar sensor die werkt op basis van laserstralen. Vaak zien we dit soort sensors boven op een dak van een auto, de sensor draait razendsnel rond en schiet allemaal laserstraaltjes af. De weerkaatsing van de laserstraaltjes wordt opgevangen door de sensor en de software kan hiermee een gedetailleerde representatie maken van de omgeving. Een belangrijk voordeel van de sensor is dat er een 360° 3D kaart van de omgeving mee gemaakt kan worden. In tegenstelling tot Radar die slechts een 3D kaart van de voorkant van de auto maakt. Belangrijke nadelen die worden genoemd zijn: </p>
<ul>
<li>Het is een dure sensor is om te maken.</li>
<li>Er gaat informatie verloren die je met beeldherkenning wel zou kunnen interpreteren.</li>
</ul>
<p>Lidar zou bijvoorbeeld een verkeersbord kunnen detecteren. Maar de betekenis van het bord zou het niet kunnen bepalen. Daarnaast kan lidar moeilijker gebruikt worden voor object herkenning. Stel er vliegt een plastic tas voorbij op de snelweg. Is dat een plastic tas of een kapotte autoband? Met lidar heb je niet genoeg informatie op dit te achterhalen.</p>
<ul>
<li>Objecten achter objecten worden niet herkent.</li>
</ul>
<p>Lidar gebruikt laser signalen in het visuele spectrum. Hierdoor is het supersnel en super accuraat. Echter heeft dit ook als gevolg dat het niet objecten achter objecten kan herkennen. Een radarsensor kan dit wel, doordat het een veel lagere frequentie gebruikt waardoor de sensor de auto voor de auto waar je achter rijdt ook kan detecteren.</p>
<p>Onlangs is er in de “Lidar vs Vision” discussie nog wat kolen op het vuur gegooid door Elon Musk, CEO van Tesla. Hij claimde het volgende: “Lidar is a crutch” en “Anyone relying on Lidar is doomed”. Een gedurfde uitlating, echter een uitlating die later grondig is onderbouwt door Tesla in de Autonomy days Videos.</p>
<p>Er is volgens Tesla namelijk geen reden waarom je met “vision technology” (de camera sensors) geen diepte zou kunnen bepalen en daarmee een 3D kaart van de omgeving kan maken. De mens doet in feite precies hetzelfde met zijn ogen. Wanneer 2 camera’s hetzelfde beeld vangen kan er op basis van stereo vision techniek diepte worden gemeten. Bij ons vindt de diepte bepaling plaats in het brein maar bij camera’s en computers kunnen we algoritmes implementeren die exact hetzelfde doen.</p>
<img src="/images/selfdriving/eyes.png" />

<p>Lidar lijkt dus een overbodige sensor te zijn, echter momenteel is het wel de meest accurate sensor om een 3D representatie van de omgeving te krijgen. De verwachtingen zijn echter dat vision in combinatie met radar het op lange termijn gaat winnen.</p>
<blockquote>
<p>“People don’t drive with lasers in their forehead.”</p>
</blockquote>
<h2 id="Software"><a href="#Software" class="headerlink" title="Software"></a>Software</h2><p>Alle output van de sensoren in een auto genereren een enorme stroom aan data. Uit deze stroom van data moet alle informatie gehaald worden om de auto veilig over de weg te laten rijden. Hiervoor heb je software nodig. Logica die van camera beelden, ultrasonic en radarsignalen een representatie kan maken van de wereld en op basis van die representatie de juiste beslissingen kan maken. Maar hoe schrijf je ooit een programma dat alle scenario’s omvat? Als je dit leest en niet kan programmeren vergelijk het dan met het maken van een flowchart. Hoe kan je een alomvattend flowchart maken die in 99.999% van de gevallen de juiste beslissing neemt? Dat is praktisch onmogelijk. </p>
<h3 id="Van-data-naar-een-representatie-van-de-wereld"><a href="#Van-data-naar-een-representatie-van-de-wereld" class="headerlink" title="Van data naar een representatie van de wereld"></a>Van data naar een representatie van de wereld</h3><p>Hoe kom je van ruwe camera beelden, ultrasonic en radar gegevens tot een goede representatie van de wereld? Belangrijk is om alle informatie uit de verschillende kanalen te combineren tot één werkelijkheid. Camera’s hebben vaak een overlappend beeld waardoor herkenning van objecten elkaar kunnen bevestigen of juist een error van 1 sensor kunnen voorkomen. Hetzelfde geldt voor radar en ultrasonic gegevens. Objecten die door de camera worden herkend dienen ook door de radar gezien te worden, zo kan het systeem met meer zekerheid zeggen of een object echt aanwezig is.</p>
<p>Het systeem combineert alle informatie van de sensoren en rekent het om naar een universeel lokaal coördinatensysteem. De software kan dan met alle gegevens de juiste beslissing gaan nemen. Hoe dat plaats vindt leg ik later uit.</p>
<p>Een ander belangrijk gegeven is dat de verwerking van alle data lokaal in de auto plaatsvindt. Het is namelijk praktisch onmogelijk om alle data te versturen naar de cloud om daar de verwerking van de gegevens te laten plaatsvinden. Dit komt omdat het simpelweg te veel data is die in te korte tijd verwerkt moet zijn. 8 camera’s, 12 ultrasonic en een radarsensor genereren gezamenlijk makkelijk 100Mbps. Dat is te veel data om realtime over-the-air te sturen naar een datacenter en te wachten op het antwoord. Daarbij opgeteld is de latency naar een datacenter vaak al 20ms. Hoe sneller een auto een beslissing kan nemen hoe veiliger de situatie wordt. Stel dat er ineens een kind de weg oversteekt, dan wil je dat de auto supersnel reageert. </p>
<img src="/images/selfdriving/Data car.png" />

<h3 id="Objectherkenning-uit-camera-beelden"><a href="#Objectherkenning-uit-camera-beelden" class="headerlink" title="Objectherkenning uit camera beelden"></a>Objectherkenning uit camera beelden</h3><p>We weten dus dat de beelden van de camera’s in de auto verwerkt moeten worden. Maar hoe kan dat zonder dat de auto een supercomputer is. Hier komt een belangrijke techniek in de artificial intelligence wereld om de hoek kijken, namelijk: neural networks. Een neural network (neuraal netwerk) is een techniek die het menselijk brein simuleert. Het menselijk brein bestaat namelijk uit netwerk van miljoenen neuronen. Deze neuronen krijgen constant prikkels van andere neuronen en conditioneel geven ze het signaal door aan de neuronen die vastzitten aan het betreffende neuron. Over tijd heeft het neuron geleerd of een bepaalt input signaal doorgegeven moet worden aan een volgend neuron. Zo herkennen wij situaties, beelden en geluid. </p>
<img src="/images/selfdriving/neural networks.png" />

<p>Bij artificial neural networks werkt het in feite hetzelfde. Het leren, wat bij een mens automatisch gaat, is echter een complex proces waar veel data voor nodig is. Dit leer proces bij neural networks heet backpropagation. Wat er gebeurt is dat het neural network een afbeelding wordt getoond met daarbij de oplossing. Backpropagation is een algoritme waarbij de connecties tussen de neuronen zodanig worden aangepast dat bij de volgende keer dat dezelfde afbeelding als input wordt gegeven aan het neural network, de kans hoger is dat het gegeven antwoord als output eruit komt. Bij dit proces is het belangrijk dat niet telkens dezelfde afbeelding als trainingsdata aan het neural network wordt gevoed. Een gevarieerde dataset levert altijd veel betere resultaten op. In het geval van zelfrijdende auto’s is het dus superbelangrijk om afbeeldingen van objecten (auto’s, fietsers, wandelaars, etc) te hebben in de sneeuw, regen, nacht en felle zon. Zodoende zal het neural network beter de juiste waarde tussen de connecties kunnen leggen om tot de juiste output te komen.</p>
<p>Je kunt je misschien voorstellen dat het herkennen van objecten nog lang niet genoeg is om een auto zelf te laten rijden. Stel je kunt auto’s, fietsers, voetgangers, brommers, vrachtwagens, etc detecteren dan nog is hun gedrag vrij moeilijk te voorspellen. Toch wordt hier dezelfde techniek voor gebruikt alleen dan in een ander neural network. Onze hersenen doen eigenlijk hetzelfde. De visuele cortex is het gedeelte van het brein dat de input van het netvlies omzet naar beelden, wat wij met die beelden doen is aan een ander gedeelte in het brein overgelaten. Zet het ons aan tot beweging, emotie of iets anders? Bij zelfrijdende auto’s werkt dat ook zo. De output van het ene neural network is de input voor het volgende. Als we een auto hebben herkend dan is dat de input voor het “gevaren” neural network. Die gaat het gedrag van de auto voorspellen om zodoende te bepalen of de auto nog op een veilige tour is. Dit neural network leert precies op dezelfde manier als het object herkennings neural network. Het systeem wordt gevoed met allerlei veilige en onveilige gedragingen van auto’s. Zo herkent het op de duur het veilige en onveilige gedrag van automobilisten en signaleert de juiste output voor het volgende neural network.</p>
<img src="/images/selfdriving/tesla neural network.png" />

<p>Om uiteindelijk van al die input bronnen tot een zelfrijdende auto te komen zijn er dus meerdere neurale netwerken nodig die in verbinding met elkaar staan. Tesla heeft op de Autonomy Day informatie gedeeld over hun neurale netwerken. Het is indrukwekkend om te zien wat voor landschap van neural networks en software er nodig is om een level 2-3 zelfrijdende auto te maken. Mijn verwachting is dat deze software nog factoren complexer gaat worden naarmate de auto richting level 4 en 5 self driving gaat. </p>
<h3 id="Zelflerende-software"><a href="#Zelflerende-software" class="headerlink" title="Zelflerende software"></a>Zelflerende software</h3><p>Van artificial intelligence software wordt vaak geclaimd dat het zelflerend is. Dat het over tijd vanzelf beter wordt en dat dat soms een gevaar kan vormen voor de samenleving. Dat deze software niet vanzelf beter wordt werd wel duidelijk tijdens de presentaties op de Tesla Autonomy Day. Om de software telkens beter te maken en meer situaties te laten ondersteunen voert Tesla constant updates uit. Deze updates vinden over-the-air plaats. Dat wil zeggen dat Tesla op afstand updates kan doorvoeren om de zelfrijdende auto’s beter te maken. Andersom gebruiken ze de auto’s ook om data te verzamelen die nodig is om de neural networks te trainen met de juiste situaties. Dit proces noemt Tesla de data engine.</p>
<img src="/images/selfdriving/dataengine.png" />

<p>Het komt er kort op neer dat Tesla situaties identificeert die nog niet goed worden opgepakt door de software, inaccuracies genoemd. Denk bijvoorbeeld aan vuil op de weg, plastic zakken, banden, etc, of wat ik persoonlijk een mooi voorbeeld vind is een fiets achterop een fietsendrager van een auto. Je kunt je voorstellen dat de fiets geïdentificeerd wordt als verkeersdeelnemer. Het systeem kan op basis van deze foutieve herkenning hele rare beslissingen nemen. Het systeem heeft namelijk geleerd dat het voorzichtig om moet gaan met fietsers. Wat Tesla dan doet in zo’n geval is dat ze de fleet van auto’s vragen om vergelijkbare situaties op te sturen naar hun datacenters.</p>
<p>Alle auto’s van Tesla, met de full self driving setup, hebben een lokale opslag van data. Hierin worden momenten opgeslagen waarin de software geen goede beslissing kon nemen of wanneer de bestuurder ingreep. De gehele output van alle sensoren wordt opgeslagen samen met de output van de software, dit worden ook wel clips genoemd. Wanneer de ontwikkelaars bij Tesla een inaccuracy willen oplossen query-en ze de fleet naar vergelijkbare situaties, ook hier worden neural networks toegepast om vergelijkbare situaties ten opzichte van de inaccuracy situatie te vinden. Alle resultaten worden over-the-air naar de datacenters van Tesla gestuurd. Wat er dan gebeurt is dat mensen handmatig of semi geautomatiseerd de situaties gaan labelen. Ze gaan dus bij de camera streams aangegeven waar de fiets zich bevindt achterop de auto. Met deze gelabelde data gaan ze de juiste neural networks trainen met het eerdergenoemde backpropagation algoritme. Wat er dus gebeurt is dat de connecties tussen de neuronen zodanig worden aangepast dat een fietser niet als object herkend wordt wanneer de fiets achterop een auto is vastgemaakt.</p>
<p>Een belangrijk concept wat Tesla hanteert is shadow mode. Het verbeterde neural network wordt eerst in shadow mode gedraaid in de auto’s. Pas wanneer uit de analyses blijkt dat het nieuwe neural network beter presteert dan de voorgaande, dan pas gaan ze over op de nieuwe versie. Het kan dus zijn dat jouw Tesla terwijl je aan het rijden bent een test versie van een neural network naast je actieve neural network draait. Je merkt hier helemaal niets van.</p>
<img src="/images/selfdriving/summary.png" />

<p>Voor Tesla zijn er 3 factoren die het verschil maken om als eerste een zelfrijdende auto te leveren. Het is superbelangrijk dat er een grote gevarieerde data set opgebouwd wordt. In het geval van Tesla wordt deze dataset opgebouwd door data te verzamelen van alle auto’s die de volledige hardware setup hebben voor full self driving. Daarnaast is het belangrijk dat Tesla de fleet van auto’s kan vragen om data van vergelijkbare situaties op te leveren. Het is praktisch onmogelijk om alle data van de auto’s op te sturen naar de servers van Tesla. In plaats daarvan hebben ze een vindingrijke oplossing gevonden waarin ze de auto’s gebruiken als data buffer die ze ondemand kunnen bevragen. Als laatst is shadow mode een hele belangrijke feature. Dit is Tesla’s manier om te testen of de nieuwe software beter presteert dan de oude. Omdat de software een combinatie is van meerdere neurale netwerken is het moeilijk te testen met klassieke test routines. Uiteraard doen ze dat wel maar de praktijk moet leren of de nieuwe versie beter is dan de vorige.</p>
<h2 id="Hardware"><a href="#Hardware" class="headerlink" title="Hardware"></a>Hardware</h2><p>Het verwerken van alle data in de neural networks vereist nogal wat van de hardware specificaties van de computer in de auto. Het evalueren van data in een neural network levert enorm veel mathematische berekeningen op. Het is namelijk zo dat op basis van het input signaal er calculaties moeten plaatsvinden om te evalueren welk opvolgend neuron een signaal moet krijgen. Op basis van de waardes die aan de connecties tussen de neuronen hangen wordt het volgende neuron namelijk gesignaleerd. Je kunt je voorstellen dat er miljoenen operaties per seconde uitgevoerd moeten worden om van een input signaal naar een output te komen.</p>
<p>Uit het Bitcoin tijdperk hebben we geleerd dat grafische videokaarten erg goed zijn in het uitvoeren van mathematische berekeningen. Vergelijkbare operaties dienen namelijk ook te gebeuren in games. Hierin bewegen objecten zich ook in de ruimte en interacteren met elkaar. Het is dan ook geen verassing dat in de Tesla Hardware 2.0 en 2.5 NVidia GPU’s worden gebruikt om deze berekeningen uit te voeren. Wat we echter in het Bitcoin tijdperk ook hebben geleerd is dat chips met een dedicated ontwerp nog sneller kunnen zijn in het verwerken van deze data. Dit soort chips heten ASIC chips (application specific integrated circuit).</p>
<img src="/images/selfdriving/chips.png" />

<p>We kunnen stellen dat hoe flexibeler de chip is, hoe minder efficiënt hij is. Een grafische kaart van NVidia kan gebruikt worden in veel situaties. Ze zijn wel beperkt tot het verwerken van grafische/mathematische berekeningen maar je zou ze net zo goed kunnen inzetten voor games. Wat Tesla heeft gedaan is dat ze een eigen chip hebben ontworpen die puur en alleen bedoeld is voor de zelfrijdende auto. De neural networks kunnen hierdoor super efficiënt worden geëvalueerd door de hardware waardoor het wel tot 2100 frames van video signaal per seconde kan verwerken, dat is zo’n 250fps per camera. </p>
<h2 id="Toekomst"><a href="#Toekomst" class="headerlink" title="Toekomst"></a>Toekomst</h2><p>De toekomst van zelfrijdende auto’s komt razendsnel op ons af. Tesla heeft een dominante positie en lijkt die de komende tijd nog niet te verliezen. Ze hebben by-far de grootste fleet met auto’s die actief gebruikt worden om het systeem beter te maken.</p>
<p>Zelfrijdende auto’s beloven niet alleen veiliger te zijn maar brengen ook nieuwe mogelijkheden met zich mee. Zo heeft Tesla al een nieuw concept aangekondigd namelijk RoboTaxi. Met RoboTaxi kunnen auto eigenaren hun auto toevoegen aan een soort van Uber fleet van auto’s. Eigenlijk is je auto dan een zelfrijdende taxi wanneer je hem niet gebruikt. Dit klinkt natuurlijk erg mooi maar de praktijk moet uitwijzen of dit haalbaar is.</p>
<p>Daarnaast hebben bedrijven als Tesla ook nog een grote uitdaging aangaande wetgeving en verzekeringen. Het zal nog een hele tijd duren voordat de juridische puzzel opgelost wordt wanneer er geen bestuurder aanwezig is in de auto.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://dibranmulder.github.io/2019/08/16/Autonoom-rijden/" data-id="ckfdlvwy8000ufk492qp97r3g" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Autonoom-rijden/" rel="tag">Autonoom rijden</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Self-driving-cars/" rel="tag">Self driving cars</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Tesla/" rel="tag">Tesla</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Learn-CosmosDb-in-20-pictures" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/06/18/Learn-CosmosDb-in-20-pictures/" class="article-date">
  <time datetime="2019-06-18T12:33:56.000Z" itemprop="datePublished">2019-06-18</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/06/18/Learn-CosmosDb-in-20-pictures/">Learn CosmosDb in 27 pictures</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>The Azure CosmosDb team published a series of cartoons on their <a target="_blank" rel="noopener" href="https://twitter.com/AzureCosmosDB">twitter account</a> to explain alot of CosmosDb features. I collected them and thought it would be nice to reshare them with you. Happy learning!</p>
<h2 id="The-7-new-ones"><a href="#The-7-new-ones" class="headerlink" title="The 7 new ones"></a>The 7 new ones</h2><img src="/images/cosmos/costs 1.png" />
<hr>
<img src="/images/cosmos/costs 2.png" />
<hr>
<img src="/images/cosmos/ttl.png" />
<hr>
<img src="/images/cosmos/unique key.png" />
<hr>
<img src="/images/cosmos/perf 1.png" />
<hr>
<img src="/images/cosmos/perf 2.png" />
<hr>
<img src="/images/cosmos/perf 3.png" />

<h2 id="The-20-original-ones"><a href="#The-20-original-ones" class="headerlink" title="The 20 original ones"></a>The 20 original ones</h2><img src="/images/cosmos/resource model.png" />
<hr>
<img src="/images/cosmos/regional presence.png" />
<hr>
<img src="/images/cosmos/database design.png" />
<hr>
<img src="/images/cosmos/database modeling.png" />
<hr>
<img src="/images/cosmos/data modeling ref vs embed.png" />
<hr>
<img src="/images/cosmos/partioning.png" />
<hr>
<img src="/images/cosmos/partioning key.png" />
<hr>
<img src="/images/cosmos/provisioning througput.png" />
<hr>
<img src="/images/cosmos/request units.png" />
<hr>
<img src="/images/cosmos/requests units 2.png" />
<hr>
<img src="/images/cosmos/indexing 2.png" />
<hr>
<img src="/images/cosmos/indexing.png" />
<hr>
<img src="/images/cosmos/quering with indexes.png" />
<hr>
<img src="/images/cosmos/global distribution.png" />
<hr>
<img src="/images/cosmos/change feed v2.png" />
<hr>
<img src="/images/cosmos/cosmosdb change feed.png" />
<hr>
<img src="/images/cosmos/consistency levels.png" />
<hr>
<img src="/images/cosmos/consistency models.png" />
<hr>
<img src="/images/cosmos/durability and recovery time.png" />
<hr>
<img src="/images/cosmos/lambda architecture.png" />
      
    </div>
    <footer class="article-footer">
      <a data-url="https://dibranmulder.github.io/2019/06/18/Learn-CosmosDb-in-20-pictures/" data-id="ckfdlvwxj000ffk492pqj2s8d" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Azure/" rel="tag">Azure</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/CosmosDb/" rel="tag">CosmosDb</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Testing-time-triggered-Azure-Functions" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/05/20/Testing-time-triggered-Azure-Functions/" class="article-date">
  <time datetime="2019-05-20T11:24:46.000Z" itemprop="datePublished">2019-05-20</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/05/20/Testing-time-triggered-Azure-Functions/">Locally testing Azure Functions</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Azure Functions with for instance TimeTriggers or ServiceBusTriggers can be difficult to test. Especially when you’re trying not to interfere in a development or testing environment. What a lot of people don’t know is that the Azure Functions platform provides a feature to manually trigger Azure Functions, regardless of their actual trigger type.</p>
<p>The only thing you’ll have to do is to send a Http POST message to an admin enpoint. <strong>Keep it mind to add a payload with at least an empty input property</strong>, otherwise the function will not be triggered.</p>
<p>Take for instance this Functions with a TimeTrigger named <code>TriggerOnTime</code>.</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title">Functions</span></span><br><span class="line">&#123;</span><br><span class="line">    [<span class="meta">FunctionName(<span class="meta-string">&quot;TriggerOnTime&quot;</span>)</span>]</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">async</span> Task <span class="title">DoSomethingAsync</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">        [TimerTrigger(<span class="string">&quot;0 0 */8 * * *&quot;</span></span>)] TimerInfo myTimer,</span></span><br><span class="line"><span class="function">        ILogger log)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        log.LogInformation(<span class="string">&quot;This function triggers every 8 hours.&quot;</span>);</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>To manually fire this off, perform a Http POST message to the following endpoint: <code>POST: http://localhost:7071/admin/functions/TriggerOnTime</code><br>Don’t forget to add an empty payload.</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;input&quot;</span>: <span class="string">&quot;&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>You can perform this request with a simple curl command.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">curl</span><br><span class="line">    --header <span class="string">&quot;Content-Type: application/json&quot;</span></span><br><span class="line">    --request POST </span><br><span class="line">    --data <span class="string">&#x27;&#123;&quot;input&quot;:&quot;&quot;&#125;&#x27;</span> </span><br><span class="line">    http://localhost:7071/admin/<span class="built_in">functions</span>/TriggerOnTime</span><br></pre></td></tr></table></figure>
<p>To mock a ServiceBusMessage simple provide the JSON serialized content of the message inside the input property.</p>
<p>Happy coding!</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://dibranmulder.github.io/2019/05/20/Testing-time-triggered-Azure-Functions/" data-id="ckfdlvwxq000mfk495hzsbe40" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Azure-Functions/" rel="tag">Azure Functions</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Versioning-with-Azure-PaaS" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/04/16/Versioning-with-Azure-PaaS/" class="article-date">
  <time datetime="2019-04-16T12:45:39.000Z" itemprop="datePublished">2019-04-16</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/04/16/Versioning-with-Azure-PaaS/">Versioning with Azure PaaS and Serverless</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Working with multiple teams on a big microservices architecture can be a real struggle. What I often see is that teams are responsible for their set of microservices and struggle to isolate their services. Resulting in the following problems:</p>
<ul>
<li>Teams are not able to release independently.</li>
<li>Teams are building release trains that have to be coordinated precisely.<ul>
<li>Hence, companies are hiring people as release coordinators.</li>
</ul>
</li>
<li>Reverting release trains is not possible, fix-over-fix scenario’s will occur.</li>
<li>The applications are temporary in a state of flux while releasing a train.</li>
</ul>
<img src='/images/versioning/releasetrain.png' />

<p>What we ideally want is that teams stop building release trains and start releasing independently at any given time of the day. However, a lot has to be done before companies achieve that kind of development maturity. I came up with a set of principles that will guide an organization to become more maturity, and there by increasing flexibility, productivity and quality.</p>
<h3 id="The-golden-principles"><a href="#The-golden-principles" class="headerlink" title="The golden principles."></a>The golden principles.</h3><ol>
<li>Services must be able to run independently.<ul>
<li>Services must be able to reconnect with other services. Any dependency can be deployed at any time. Design your service to fail.</li>
</ul>
</li>
<li>Services can never introduce breaking changes.<ul>
<li>This means services should adopt a versioning strategy.</li>
</ul>
</li>
<li>There can be no direct dependencies between services, that means no direct REST interfaces anymore.</li>
<li>Teams are able to release their service at any given time.</li>
<li>Teams are responsible and accountable for their own services.</li>
</ol>
<p>Most of the principles are kind of straight forward, but keep in mind they are key for success. Sometimes simple principles are the hardest to implement, especially when you have legacy components in your microservices architecture, or maybe because it’s technically difficult to implement them. In this blog I’ll help you implementing some of the principles in Azure PaaS and Serverless services. Let’s start with a combination of versioning strategy and mitigating direct dependencies. </p>
<h2 id="Service-bus-versioning"><a href="#Service-bus-versioning" class="headerlink" title="Service bus versioning"></a>Service bus versioning</h2><p>The most common way for microservices to communicate in an asynchronous matter on Azure is the use of Azure Service Bus. With Azure Service Bus, teams can define message channels to communicate between microservices. What a lot of development teams forget is to adopt a versioning strategy for their service bus messages.</p>
<p>One way of versioning service bus messages is to add a <code>custom property</code> to a message. I like this better then to add a <code>version</code> property to the actual JSON or XML message because, in my opinion, a version is not part of the data you actually want to send, it’s the metadata. It’s important for the consuming party to know.</p>
<p>So depending on the programming language you use you can add a <code>custom message property</code> to a service bus message. In C# it will look like something like this.</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Data you want to send.</span></span><br><span class="line"><span class="keyword">var</span> user = <span class="keyword">new</span></span><br><span class="line">&#123;</span><br><span class="line">    name = <span class="string">&quot;Dibran&quot;</span>,</span><br><span class="line">    lastName = <span class="string">&quot;Mulder&quot;</span>,</span><br><span class="line">    position = <span class="string">&quot;Dev&quot;</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// Serialize to JSON.</span></span><br><span class="line"><span class="keyword">string</span> json = JsonConvert.SerializeObject(user);</span><br><span class="line">Message message = <span class="keyword">new</span> Message(Encoding.UTF8.GetBytes(json));</span><br><span class="line"><span class="comment">// Add a custom verison property.</span></span><br><span class="line">message.UserProperties.Add(<span class="string">&quot;Version&quot;</span>, <span class="string">&quot;1.0&quot;</span>);</span><br></pre></td></tr></table></figure>
<p>I like to keep the version the same as the version of your microservice. In this way we are not bogged down into a versioning hell. The version of the message is equal to the version of the service that actually created the message. A simple but effective rule. In this way you can also track by what version of a microservice a message is actually created.</p>
<p>With <a target="_blank" rel="noopener" href="https://github.com/paolosalvatori/ServiceBusExplorer">Azure Service Bus explorer</a> you can easily check messages, create additional subscriptions, etc. I highly recommend you to use it, you can see what kind of messages are send and also inspect the custom message properties. It’s a nice tool to debug your versioning strategy.</p>
<p>So if you send messages with a Version <code>custom message property</code> you can create for instance create 2 subscriptions for each version. With a service bus filter you can then make sure that messages with a specific version are only received by certain topics.</p>
<img src='/images/versioning/servicebus.png' />
<img src='/images/versioning/sendmessage.png' />

<p>A simple service bus filter can be:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Version=&#x27;1.0&#x27;</span><br></pre></td></tr></table></figure>
<p><strong>Don’t forget to remove the default rule: 1=1.</strong> If one of the rules match a message will be accepted by a subscription.</p>
<p>You can also choose to do the filtering and version handling in the consuming service. But I personally like it better to separate messages in subscriptions based on version numbers.</p>
<p>Lastly, I would like to add that service bus filters can easily be created by <a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/azure/service-bus-messaging/service-bus-resource-manager-namespace-topic-with-rule">ARM scripts</a>. In this way you won’t need to service bus explorer or code to manage your infrastructure. </p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;apiVersion&quot;</span>: <span class="string">&quot;[variables(&#x27;sbVersion&#x27;)]&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;[parameters(&#x27;serviceBusRuleName&#x27;)]&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;Rules&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;dependsOn&quot;</span>: [</span><br><span class="line">        <span class="string">&quot;[parameters(&#x27;serviceBusSubscriptionName&#x27;)]&quot;</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">&quot;properties&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;filterType&quot;</span>: <span class="string">&quot;SqlFilter&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;sqlFilter&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;sqlExpression&quot;</span>: <span class="string">&quot;Version = &#x27;1.0&#x27;&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;requiresPreprocessing&quot;</span>: <span class="string">&quot;false&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">&quot;action&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;sqlExpression&quot;</span>: <span class="string">&quot;set FilterTag = &#x27;true&#x27;&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Azure-Functions-versioning"><a href="#Azure-Functions-versioning" class="headerlink" title="Azure Functions versioning"></a>Azure Functions versioning</h2><p>With Azure functions it’s pretty easy to handle versioning. You can add a versioning scheme to the route of an <code>Http Trigger</code> like this.</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">FunctionName(<span class="meta-string">&quot;SomeHttpFunction&quot;</span>)</span>]</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">async</span> Task&lt;HttpResponseMessage&gt; <span class="title">Run</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    [HttpTrigger(</span></span></span><br><span class="line"><span class="function"><span class="params">        AuthorizationLevel.Function,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="string">&quot;POST&quot;</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">        Route = <span class="string">&quot;api/v1/entity&quot;</span></span>)]</span></span><br><span class="line"><span class="function">    HttpRequestMessage req,</span></span><br><span class="line"><span class="function">    ILogger log)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// Code...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>However, routing in Azure Functions is pretty badly implemented. ASP.net core handles it way better and its therefore highly recommended to use an API gateway in front of it. As I described in <a href="https://dibranmulder.github.io/2018/10/19/Building-Serverless-APIs-in-Azure/">this blog post</a> you can use for instance Azure API Management to handle that for you. You will then get a lot of additional options such as: routing, mocking, caching, authorization, etc.<br><img src='/images/serverless/Serverless.png' /></p>
<h2 id="ASP-net-core-versioning"><a href="#ASP-net-core-versioning" class="headerlink" title="ASP.net core versioning"></a>ASP.net core versioning</h2><p>Lastly I would like to point out to a very nice <a target="_blank" rel="noopener" href="https://github.com/Microsoft/aspnet-api-versioning">Github repository</a> for ASP.net core versioning. It has several examples to implement versioning correctly. Versioning is actually a 1st class citizen in ASP.net core, enabling you to adopt a solid strategy and never make breaking changes again.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://dibranmulder.github.io/2019/04/16/Versioning-with-Azure-PaaS/" data-id="ckfdlvwy0000pfk493wmyaufc" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Azure-PaaS-Serverless-Teams-Agile-Versioning/" rel="tag">Azure, PaaS, Serverless, Teams, Agile, Versioning</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Migrating-Azure-Table-Storage-to-SQL-with-Azure-Logic-Apps" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/03/22/Migrating-Azure-Table-Storage-to-SQL-with-Azure-Logic-Apps/" class="article-date">
  <time datetime="2019-03-22T08:36:42.000Z" itemprop="datePublished">2019-03-22</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/03/22/Migrating-Azure-Table-Storage-to-SQL-with-Azure-Logic-Apps/">Migrating Azure Table Storage to SQL with Azure Logic Apps</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>I’ve created an App that uses Azure Table Storage as a backing store. At first this looked like the right decision but after a while I figured that I should migrate to a relational database. But in the mean while the Table Storage database grew quite big. I’m not talking about millions of records but more like: 5 tables with about 100k of records in it. So how do you migrate that data to a SQL Server database? I figured I would use Azure Logic Apps.</p>
<img src="/images/logicapps/start-logic-app.png" />

<p>It all starts with a trigger, in Azure Logic Apps a manual trigger is often an Http Request. After that I initialize 2 variables, the <code>FirstRun</code> and <code>NextRowKey</code> variables. The <code>FirstRun</code> is used to call the Azure Table Storage tables without a <code>NextRowKey</code> query parameter. Once the first page is fetched this variable will be set to <code>false</code> and the subsequent pages will be requested with a <code>NextRowKey</code> query parameter. This is the first step to fetch your data with pages. <strong>Bear in mind Azure Table Storage can only return 1000 records per request!</strong> </p>
<p>The JSON for initializing the variables.</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;Init_first_run&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;inputs&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;variables&quot;</span>: [</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;FirstRun&quot;</span>,</span><br><span class="line">                    <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;Boolean&quot;</span>,</span><br><span class="line">                    <span class="attr">&quot;value&quot;</span>: <span class="literal">true</span></span><br><span class="line">                &#125;</span><br><span class="line">            ]</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">&quot;runAfter&quot;</span>: &#123;&#125;,</span><br><span class="line">        <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;InitializeVariable&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;Initialize_nextrowkey&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;inputs&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;variables&quot;</span>: [</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;NextRowKey&quot;</span>,</span><br><span class="line">                    <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;String&quot;</span>,</span><br><span class="line">                    <span class="attr">&quot;value&quot;</span>: <span class="string">&quot;&quot;</span></span><br><span class="line">                &#125;</span><br><span class="line">            ]</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">&quot;runAfter&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;Init_first_run&quot;</span>: [</span><br><span class="line">                <span class="string">&quot;Succeeded&quot;</span></span><br><span class="line">            ]</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;InitializeVariable&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<img src="/images/logicapps/until.png" />
The next part is to repeat the fetch records part until there are no more records or when its the first run. I use this expression to check wether to continue or not: `@and(equals(variables('NextRowKey'), null), not(variables('FirstRun')))`

<p>After that I use a condition Action to check whether its the first run or not. Remember I initialize a variable to determine if its the first run.  If its the first run that obviously we’ve to set the <code>FirstRun</code> variable to <code>false</code>. After that its just quite simple, either we fetch a page with a <code>NextRowKey</code> query parameter or not. Either way we Parse the outcome of the fetch entities and loop over it to insert the records into the SQL database.</p>
<p>The trick is to retrieve the <code>NextRowKey</code> token from the Http Response header of the <code>Get Entities</code> action. I’ve searched in the documentation but its actually quite hard to come up with an expression to get it. But here it is: ```json<br>{<br>    “Set_variable”: {<br>        “inputs”: {<br>            “name”: “NextRowKey”,<br>            “value”: “@{actions(‘Get_next_page’)?[‘outputs’]?[‘headers’]?[‘x-ms-continuation-NextRowKey’]}”<br>        },<br>        “runAfter”: {<br>            “Get_next_page”: [<br>                “Succeeded”<br>            ]<br>        },<br>        “type”: “SetVariable”<br>    }<br>}</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">So basically, we refer to the &#96;action&#96; to fetch the next page, check at its &#96;ouputs&#96;, look at its &#96;headers&#96; and get the &#96;x-ms-continuation-NextRowKey&#96;. We then set the value of it in the &#96;NextRowKey&#96; iteration and use it to fetch the next page. Its actually quite easy but sometimes it can be hard to get the right syntax. I find this [Workflow definition functions reference documentation](&#39;https:&#x2F;&#x2F;docs.microsoft.com&#x2F;en-us&#x2F;azure&#x2F;logic-apps&#x2F;workflow-definition-language-functions-reference&#39;) very handy.</span><br><span class="line"></span><br><span class="line">## Complete Workflow definition </span><br><span class="line"></span><br><span class="line">&#96;&#96;&#96;json</span><br><span class="line">&#123;</span><br><span class="line">    &quot;$connections&quot;: &#123;</span><br><span class="line">        &quot;value&quot;: &#123;</span><br><span class="line">            &quot;azuretables&quot;: &#123;</span><br><span class="line">                &quot;connectionId&quot;: &quot;&#x2F;subscriptions&#x2F;9b4ed9c7-de20-49df-b301-d39322443140&#x2F;resourceGroups&#x2F;TradersmateBackend&#x2F;providers&#x2F;Microsoft.Web&#x2F;connections&#x2F;azuretables&quot;,</span><br><span class="line">                &quot;connectionName&quot;: &quot;azuretables&quot;,</span><br><span class="line">                &quot;id&quot;: &quot;&#x2F;subscriptions&#x2F;9b4ed9c7-de20-49df-b301-d39322443140&#x2F;providers&#x2F;Microsoft.Web&#x2F;locations&#x2F;westeurope&#x2F;managedApis&#x2F;azuretables&quot;</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;sql&quot;: &#123;</span><br><span class="line">                &quot;connectionId&quot;: &quot;&#x2F;subscriptions&#x2F;9b4ed9c7-de20-49df-b301-d39322443140&#x2F;resourceGroups&#x2F;TradersmateBackend&#x2F;providers&#x2F;Microsoft.Web&#x2F;connections&#x2F;sql&quot;,</span><br><span class="line">                &quot;connectionName&quot;: &quot;sql&quot;,</span><br><span class="line">                &quot;id&quot;: &quot;&#x2F;subscriptions&#x2F;9b4ed9c7-de20-49df-b301-d39322443140&#x2F;providers&#x2F;Microsoft.Web&#x2F;locations&#x2F;westeurope&#x2F;managedApis&#x2F;sql&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;definition&quot;: &#123;</span><br><span class="line">        &quot;$schema&quot;: &quot;https:&#x2F;&#x2F;schema.management.azure.com&#x2F;providers&#x2F;Microsoft.Logic&#x2F;schemas&#x2F;2016-06-01&#x2F;workflowdefinition.json#&quot;,</span><br><span class="line">        &quot;actions&quot;: &#123;</span><br><span class="line">            &quot;Init_first_run&quot;: &#123;</span><br><span class="line">                &quot;inputs&quot;: &#123;</span><br><span class="line">                    &quot;variables&quot;: [</span><br><span class="line">                        &#123;</span><br><span class="line">                            &quot;name&quot;: &quot;FirstRun&quot;,</span><br><span class="line">                            &quot;type&quot;: &quot;Boolean&quot;,</span><br><span class="line">                            &quot;value&quot;: true</span><br><span class="line">                        &#125;</span><br><span class="line">                    ]</span><br><span class="line">                &#125;,</span><br><span class="line">                &quot;runAfter&quot;: &#123;&#125;,</span><br><span class="line">                &quot;type&quot;: &quot;InitializeVariable&quot;</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;Initialize_nextrowkey&quot;: &#123;</span><br><span class="line">                &quot;inputs&quot;: &#123;</span><br><span class="line">                    &quot;variables&quot;: [</span><br><span class="line">                        &#123;</span><br><span class="line">                            &quot;name&quot;: &quot;NextRowKey&quot;,</span><br><span class="line">                            &quot;type&quot;: &quot;String&quot;,</span><br><span class="line">                            &quot;value&quot;: &quot;&quot;</span><br><span class="line">                        &#125;</span><br><span class="line">                    ]</span><br><span class="line">                &#125;,</span><br><span class="line">                &quot;runAfter&quot;: &#123;</span><br><span class="line">                    &quot;Init_first_run&quot;: [</span><br><span class="line">                        &quot;Succeeded&quot;</span><br><span class="line">                    ]</span><br><span class="line">                &#125;,</span><br><span class="line">                &quot;type&quot;: &quot;InitializeVariable&quot;</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;Until&quot;: &#123;</span><br><span class="line">                &quot;actions&quot;: &#123;</span><br><span class="line">                    &quot;Condition&quot;: &#123;</span><br><span class="line">                        &quot;actions&quot;: &#123;</span><br><span class="line">                            &quot;Get_first_page&quot;: &#123;</span><br><span class="line">                                &quot;inputs&quot;: &#123;</span><br><span class="line">                                    &quot;host&quot;: &#123;</span><br><span class="line">                                        &quot;connection&quot;: &#123;</span><br><span class="line">                                            &quot;name&quot;: &quot;@parameters(&#39;$connections&#39;)[&#39;azuretables&#39;][&#39;connectionId&#39;]&quot;</span><br><span class="line">                                        &#125;</span><br><span class="line">                                    &#125;,</span><br><span class="line">                                    &quot;method&quot;: &quot;get&quot;,</span><br><span class="line">                                    &quot;path&quot;: &quot;&#x2F;Tables&#x2F;@&#123;encodeURIComponent(&#39;yourTable&#39;)&#125;&#x2F;entities&quot;,</span><br><span class="line">                                    &quot;queries&quot;: &#123;</span><br><span class="line">                                        &quot;$select&quot;: &quot;PropA, PropB&quot;</span><br><span class="line">                                    &#125;</span><br><span class="line">                                &#125;,</span><br><span class="line">                                &quot;runAfter&quot;: &#123;</span><br><span class="line">                                    &quot;Set_variable_3&quot;: [</span><br><span class="line">                                        &quot;Succeeded&quot;</span><br><span class="line">                                    ]</span><br><span class="line">                                &#125;,</span><br><span class="line">                                &quot;type&quot;: &quot;ApiConnection&quot;</span><br><span class="line">                            &#125;,</span><br><span class="line">                            &quot;Set_variable_2&quot;: &#123;</span><br><span class="line">                                &quot;inputs&quot;: &#123;</span><br><span class="line">                                    &quot;name&quot;: &quot;NextRowKey&quot;,</span><br><span class="line">                                    &quot;value&quot;: &quot;@&#123;actions(&#39;Get_first_page&#39;)?[&#39;outputs&#39;]?[&#39;headers&#39;]?[&#39;x-ms-continuation-NextRowKey&#39;]&#125;&quot;</span><br><span class="line">                                &#125;,</span><br><span class="line">                                &quot;runAfter&quot;: &#123;</span><br><span class="line">                                    &quot;Get_first_page&quot;: [</span><br><span class="line">                                        &quot;Succeeded&quot;</span><br><span class="line">                                    ]</span><br><span class="line">                                &#125;,</span><br><span class="line">                                &quot;type&quot;: &quot;SetVariable&quot;</span><br><span class="line">                            &#125;,</span><br><span class="line">                            &quot;Set_variable_3&quot;: &#123;</span><br><span class="line">                                &quot;inputs&quot;: &#123;</span><br><span class="line">                                    &quot;name&quot;: &quot;FirstRun&quot;,</span><br><span class="line">                                    &quot;value&quot;: false</span><br><span class="line">                                &#125;,</span><br><span class="line">                                &quot;runAfter&quot;: &#123;&#125;,</span><br><span class="line">                                &quot;type&quot;: &quot;SetVariable&quot;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;,</span><br><span class="line">                        &quot;else&quot;: &#123;</span><br><span class="line">                            &quot;actions&quot;: &#123;</span><br><span class="line">                                &quot;Get_next_page&quot;: &#123;</span><br><span class="line">                                    &quot;inputs&quot;: &#123;</span><br><span class="line">                                        &quot;host&quot;: &#123;</span><br><span class="line">                                            &quot;connection&quot;: &#123;</span><br><span class="line">                                                &quot;name&quot;: &quot;@parameters(&#39;$connections&#39;)[&#39;azuretables&#39;][&#39;connectionId&#39;]&quot;</span><br><span class="line">                                            &#125;</span><br><span class="line">                                        &#125;,</span><br><span class="line">                                        &quot;method&quot;: &quot;get&quot;,</span><br><span class="line">                                        &quot;path&quot;: &quot;&#x2F;Tables&#x2F;@&#123;encodeURIComponent(&#39;userTrackedProducts&#39;)&#125;&#x2F;entities&quot;,</span><br><span class="line">                                        &quot;queries&quot;: &#123;</span><br><span class="line">                                            &quot;$select&quot;: &quot;PropA, PropB&quot;,</span><br><span class="line">                                            &quot;NextRowKey&quot;: &quot;@variables(&#39;NextRowKey&#39;)&quot;</span><br><span class="line">                                        &#125;</span><br><span class="line">                                    &#125;,</span><br><span class="line">                                    &quot;runAfter&quot;: &#123;&#125;,</span><br><span class="line">                                    &quot;type&quot;: &quot;ApiConnection&quot;</span><br><span class="line">                                &#125;,</span><br><span class="line">                                &quot;Set_variable&quot;: &#123;</span><br><span class="line">                                    &quot;inputs&quot;: &#123;</span><br><span class="line">                                        &quot;name&quot;: &quot;NextRowKey&quot;,</span><br><span class="line">                                        &quot;value&quot;: &quot;@&#123;actions(&#39;Get_next_page&#39;)?[&#39;outputs&#39;]?[&#39;headers&#39;]?[&#39;x-ms-continuation-NextRowKey&#39;]&#125;&quot;</span><br><span class="line">                                    &#125;,</span><br><span class="line">                                    &quot;runAfter&quot;: &#123;</span><br><span class="line">                                        &quot;Get_next_page&quot;: [</span><br><span class="line">                                            &quot;Succeeded&quot;</span><br><span class="line">                                        ]</span><br><span class="line">                                    &#125;,</span><br><span class="line">                                    &quot;type&quot;: &quot;SetVariable&quot;</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;,</span><br><span class="line">                        &quot;expression&quot;: &#123;</span><br><span class="line">                            &quot;and&quot;: [</span><br><span class="line">                                &#123;</span><br><span class="line">                                    &quot;equals&quot;: [</span><br><span class="line">                                        &quot;@variables(&#39;FirstRun&#39;)&quot;,</span><br><span class="line">                                        true</span><br><span class="line">                                    ]</span><br><span class="line">                                &#125;</span><br><span class="line">                            ]</span><br><span class="line">                        &#125;,</span><br><span class="line">                        &quot;runAfter&quot;: &#123;&#125;,</span><br><span class="line">                        &quot;type&quot;: &quot;If&quot;</span><br><span class="line">                    &#125;,</span><br><span class="line">                    &quot;For_each&quot;: &#123;</span><br><span class="line">                        &quot;actions&quot;: &#123;</span><br><span class="line">                            &quot;Insert_products&quot;: &#123;</span><br><span class="line">                                &quot;inputs&quot;: &#123;</span><br><span class="line">                                    &quot;body&quot;: &#123;</span><br><span class="line">                                        &quot;PropA&quot;: &quot;@items(&#39;For_each&#39;)[&#39;PropA&#39;]&quot;,</span><br><span class="line">                                        &quot;PropB&quot;: &quot;@items(&#39;For_each&#39;)?[&#39;PropB&#39;]&quot;</span><br><span class="line">                                    &#125;,</span><br><span class="line">                                    &quot;host&quot;: &#123;</span><br><span class="line">                                        &quot;connection&quot;: &#123;</span><br><span class="line">                                            &quot;name&quot;: &quot;@parameters(&#39;$connections&#39;)[&#39;sql&#39;][&#39;connectionId&#39;]&quot;</span><br><span class="line">                                        &#125;</span><br><span class="line">                                    &#125;,</span><br><span class="line">                                    &quot;method&quot;: &quot;post&quot;,</span><br><span class="line">                                    &quot;path&quot;: &quot;&#x2F;datasets&#x2F;default&#x2F;tables&#x2F;@&#123;encodeURIComponent(encodeURIComponent(&#39;[dbo].[YourTable]&#39;))&#125;&#x2F;items&quot;</span><br><span class="line">                                &#125;,</span><br><span class="line">                                &quot;runAfter&quot;: &#123;&#125;,</span><br><span class="line">                                &quot;type&quot;: &quot;ApiConnection&quot;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;,</span><br><span class="line">                        &quot;foreach&quot;: &quot;@body(&#39;Parse_JSON_2&#39;)&quot;,</span><br><span class="line">                        &quot;runAfter&quot;: &#123;</span><br><span class="line">                            &quot;Parse_JSON_2&quot;: [</span><br><span class="line">                                &quot;Succeeded&quot;</span><br><span class="line">                            ]</span><br><span class="line">                        &#125;,</span><br><span class="line">                        &quot;type&quot;: &quot;Foreach&quot;</span><br><span class="line">                    &#125;,</span><br><span class="line">                    &quot;Parse_JSON_2&quot;: &#123;</span><br><span class="line">                        &quot;inputs&quot;: &#123;</span><br><span class="line">                            &quot;content&quot;: &quot;@if(not(variables(&#39;FirstRun&#39;)), body(&#39;Get_next_page&#39;)?[&#39;value&#39;], body(&#39;Get_first_page&#39;)?[&#39;value&#39;])&quot;,</span><br><span class="line">                            &quot;schema&quot;: &#123;</span><br><span class="line">                                &quot;items&quot;: &#123;</span><br><span class="line">                                    &quot;properties&quot;: &#123;</span><br><span class="line">                                        &quot;PropA&quot;: &#123;</span><br><span class="line">                                            &quot;type&quot;: &quot;string&quot;</span><br><span class="line">                                        &#125;,</span><br><span class="line">                                        &quot;PropB&quot;: &#123;</span><br><span class="line">                                            &quot;type&quot;: &quot;string&quot;</span><br><span class="line">                                        &#125;</span><br><span class="line">                                    &#125;,</span><br><span class="line">                                    &quot;required&quot;: [</span><br><span class="line">                                        &quot;odata.etag&quot;,</span><br><span class="line">                                        &quot;PropA&quot;,</span><br><span class="line">                                        &quot;PropB&quot;</span><br><span class="line">                                    ],</span><br><span class="line">                                    &quot;type&quot;: &quot;object&quot;</span><br><span class="line">                                &#125;,</span><br><span class="line">                                &quot;type&quot;: &quot;array&quot;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;,</span><br><span class="line">                        &quot;runAfter&quot;: &#123;</span><br><span class="line">                            &quot;Condition&quot;: [</span><br><span class="line">                                &quot;Succeeded&quot;</span><br><span class="line">                            ]</span><br><span class="line">                        &#125;,</span><br><span class="line">                        &quot;type&quot;: &quot;ParseJson&quot;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;,</span><br><span class="line">                &quot;expression&quot;: &quot;@and(equals(variables(&#39;NextRowKey&#39;), null), not(variables(&#39;FirstRun&#39;)))&quot;,</span><br><span class="line">                &quot;limit&quot;: &#123;</span><br><span class="line">                    &quot;count&quot;: 60,</span><br><span class="line">                    &quot;timeout&quot;: &quot;PT1H&quot;</span><br><span class="line">                &#125;,</span><br><span class="line">                &quot;runAfter&quot;: &#123;</span><br><span class="line">                    &quot;Initialize_nextrowkey&quot;: [</span><br><span class="line">                        &quot;Succeeded&quot;</span><br><span class="line">                    ]</span><br><span class="line">                &#125;,</span><br><span class="line">                &quot;type&quot;: &quot;Until&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;contentVersion&quot;: &quot;1.0.0.0&quot;,</span><br><span class="line">        &quot;outputs&quot;: &#123;&#125;,</span><br><span class="line">        &quot;parameters&quot;: &#123;</span><br><span class="line">            &quot;$connections&quot;: &#123;</span><br><span class="line">                &quot;defaultValue&quot;: &#123;&#125;,</span><br><span class="line">                &quot;type&quot;: &quot;Object&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;triggers&quot;: &#123;</span><br><span class="line">            &quot;manual&quot;: &#123;</span><br><span class="line">                &quot;inputs&quot;: &#123;</span><br><span class="line">                    &quot;schema&quot;: &#123;&#125;</span><br><span class="line">                &#125;,</span><br><span class="line">                &quot;kind&quot;: &quot;Http&quot;,</span><br><span class="line">                &quot;type&quot;: &quot;Request&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
      
    </div>
    <footer class="article-footer">
      <a data-url="https://dibranmulder.github.io/2019/03/22/Migrating-Azure-Table-Storage-to-SQL-with-Azure-Logic-Apps/" data-id="ckfdlvwxm000ifk49ae61evsf" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Azure/" rel="tag">Azure</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Logic-Apps/" rel="tag">Logic Apps</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/SQL-Server/" rel="tag">SQL Server</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Table-Storage/" rel="tag">Table Storage</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Building-a-Web-Scraper-in-Azure" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/02/15/Building-a-Web-Scraper-in-Azure/" class="article-date">
  <time datetime="2019-02-15T14:44:40.000Z" itemprop="datePublished">2019-02-15</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/02/15/Building-a-Web-Scraper-in-Azure/">Building a Web Scraper in Azure</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Building a web scraper is pretty hard. Doing it in Azure is harder. Utilizing Serverless and PaaS services is challenging. I don’t want to pay for a VM and just deploy the scraper on it because I need the solution to be scalable. Secondly I only want to pay for actual usage and not for a VM thats idle.</p>
<h2 id="The-case"><a href="#The-case" class="headerlink" title="The case"></a>The case</h2><p>I want to scrape certain websites twice a day. At 10:00 UTC and at 18:00 UTC. This frequency might change in the future so I don’t want to have it build in hard coded. I’m scraping ecommerce sites and the pages that need to be scraped depend on a list of id’s comming from a database. So the input for the scraper is dynamic. Lastly the output of the scraper has to be stored in a database. Later on I will have to develop some UI which discloses the information for ecommerce traders.</p>
<h2 id="The-solution"><a href="#The-solution" class="headerlink" title="The solution"></a>The solution</h2><img src="/images/scraper/azure-web-scraper.png" />
Web scraping comes in different shapes and sizes. Some packages just perform Http calls and evaluate the response. Others spin up and entire (headless) browser and perform actual DOM operations. Since I want to scrape different ecommerce sites spinning up an actual browser looked like the way to go. Also because lots of ecommerce sites rely on alot on JavaScript. Some are build as an SPA and that requires per definition a browser based approach. After some research I stumbled upon `puppeteer`. A headless Chrome API build by Google itself, very promising.

<p>My initial idea was to run puppeteer inside an Azure Function, however after some research I came to the conclusion that running a headless browser on Azure PaaS or Serverless <a target="_blank" rel="noopener" href="https://github.com/GoogleChrome/puppeteer/issues/515">is not going to happen</a>. So what are the alternatives? Well containers seems like a reasonable solution. I can spin up and tear down the container with some orchestration and thereby limit my costs. A good start point for running puppeteer containers in Azure is <a target="_blank" rel="noopener" href="https://medium.com/@bogdanbujdea/running-puppeteer-in-azure-container-instances-b24fb0a8d3e">this blog post</a>.</p>
<p>For orchestrating the scraper I was thinking about using Azure Functions again. But then on a bright day I figured I would use Azure Logic Apps instead. Logic Apps are great for defining and running workflows and look like a perfect fit. They are pay per usage and are easy to develop!</p>
<h3 id="Puppeteer-TypeScript-and-NodeJs"><a href="#Puppeteer-TypeScript-and-NodeJs" class="headerlink" title="Puppeteer, TypeScript and NodeJs"></a>Puppeteer, TypeScript and NodeJs</h3><p>I wanted to brush up my TypeScript and NodeJS skills since it has been a while that I seriously developed in TypeScript. The last time I did something significant I was still using Visual Studio instead of VS Code for TypeScript development. So here’s the story to get a puppeteer scraper working in NodeJs and TypeScript.</p>
<h4 id="Depedencies"><a href="#Depedencies" class="headerlink" title="Depedencies"></a>Depedencies</h4><p>First of all get TypeScript tsconfig.json file there using the following command. </p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">tsc --init</span><br><span class="line">message TS6071: Successfully created a tsconfig.json file.</span><br></pre></td></tr></table></figure>
<p>A sample of how your TypeScript configuration file might look like is this.<br>Once important thing is to enable source maps. This allows you to debug your TypeScript code instead of debugging the transpiled JavaScript (which is a mess).</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;compilerOptions&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;target&quot;</span>: <span class="string">&quot;es5&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;declaration&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="attr">&quot;lib&quot;</span>: [</span><br><span class="line">          <span class="string">&quot;es2015&quot;</span>, <span class="string">&quot;dom&quot;</span></span><br><span class="line">      ]        </span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;exclude&quot;</span>: [</span><br><span class="line">      <span class="string">&quot;node_modules&quot;</span></span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Once you’ve setup the TypeScript configuration its time to setup a NPM project.</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm init</span><br></pre></td></tr></table></figure>
<p>You are now ready to start developing your TypeScript application.<br>You probably need some packages to interface with Puppeteer, Azure storage or whatever. Install them using npm.</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">npm install puppeteer --save</span><br><span class="line">npm install azure-storage --save</span><br><span class="line">npm install azure-sb --save</span><br></pre></td></tr></table></figure>
<p>A lot of packages got separate TypeScript definition packages. These are required to have type checking. We also require them for puppeteer. You should install them as a dev-dependency instead of a regular dependency.</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">npm install @types/puppeteer --save-dev</span><br><span class="line">npm install @types/azure-sb --save-dev</span><br></pre></td></tr></table></figure>
<h4 id="Puppeteer"><a href="#Puppeteer" class="headerlink" title="Puppeteer"></a>Puppeteer</h4><p>Once you’ve installed your dependencies you can start developing your scraper. It’s all up to you to interact with the page and retrieve the right information. A very basic example is this:</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> puppeteer <span class="keyword">from</span> <span class="string">&#x27;puppeteer&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> browser = <span class="keyword">await</span> puppeteer.launch();</span><br><span class="line"><span class="keyword">const</span> page = <span class="keyword">await</span> browser.newPage();</span><br><span class="line"><span class="keyword">await</span> page.goto(<span class="string">&#x27;https://somesite.com&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Evaluate the page and interact with it.</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">await</span> browser.close();</span><br></pre></td></tr></table></figure>
<p>One thing you probably want to do is to debug your code. In VSCode you’ll have to add a debug configuration. This can be achieved by adding the following configuration in <code>launch.json</code>. Notice the “Launch program” configuration inside the debug panel of VS Code.</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;version&quot;</span>: <span class="string">&quot;0.2.0&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;configurations&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;node&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;request&quot;</span>: <span class="string">&quot;launch&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;preLaunchTask&quot;</span>: <span class="string">&quot;tsc&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;Launch Program &quot;</span>,</span><br><span class="line">            <span class="attr">&quot;sourceMaps&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">&quot;program&quot;</span>: <span class="string">&quot;$&#123;workspaceFolder&#125;\\src\\index.js&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;outFiles&quot;</span>: [</span><br><span class="line">                <span class="string">&quot;$&#123;workspaceFolder&#125;/**/*.js&quot;</span></span><br><span class="line">            ]</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Docker-and-Azure"><a href="#Docker-and-Azure" class="headerlink" title="Docker and Azure"></a>Docker and Azure</h3><p>Well you’ve got your scraper working on Node using TypeScript. The next thing is to host it in the Cloud. We want to containerize the application inside a docker container. Building a docker container requires a dockerfile. Here’s one that works for the Puppeteer scraper. The Google Chrome teams has made a nice <a target="_blank" rel="noopener" href="https://github.com/GoogleChrome/puppeteer/blob/master/docs/troubleshooting.md#running-puppeteer-in-docker">Docker file</a> with some tricks applied, I basically copied that. Secondly <a target="_blank" rel="noopener" href="https://medium.com/@bogdanbujdea/running-puppeteer-in-azure-container-instances-b24fb0a8d3e">is this</a> a nice blogpost about running Docker containers on Azure Container Instances. Its worth a read.</p>
<figure class="highlight docker"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> node:<span class="number">8</span>-slim</span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> apt-get update &amp;&amp; apt-get -yq upgrade &amp;&amp; apt-get install \</span></span><br><span class="line"><span class="bash">    &amp;&amp; apt-get autoremove &amp;&amp; apt-get autoclean</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> apt-get update &amp;&amp; apt-get install -y wget --no-install-recommends \</span></span><br><span class="line"><span class="bash">    &amp;&amp; wget -q -O - https://dl-ssl.google.com/linux/linux_signing_key.pub | apt-key add - \</span></span><br><span class="line"><span class="bash">    &amp;&amp; sh -c <span class="string">&#x27;echo &quot;deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main&quot; &gt;&gt; /etc/apt/sources.list.d/google.list&#x27;</span> \</span></span><br><span class="line"><span class="bash">    &amp;&amp; apt-get update \</span></span><br><span class="line"><span class="bash">    &amp;&amp; apt-get install -y google-chrome-unstable fonts-ipafont-gothic fonts-wqy-zenhei fonts-thai-tlwg fonts-kacst ttf-freefont \</span></span><br><span class="line"><span class="bash">      --no-install-recommends \</span></span><br><span class="line"><span class="bash">    &amp;&amp; rm -rf /var/lib/apt/lists/* \</span></span><br><span class="line"><span class="bash">    &amp;&amp; apt-get purge --auto-remove -y curl \</span></span><br><span class="line"><span class="bash">    &amp;&amp; rm -rf /src/*.deb</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">ADD</span><span class="bash"> https://github.com/Yelp/dumb-init/releases/download/v1.2.1/dumb-init_1.2.1_amd64 /usr/<span class="built_in">local</span>/bin/dumb-init</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> chmod +x /usr/<span class="built_in">local</span>/bin/dumb-init</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># copy project files and install dependencies</span></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> . /var/app  </span></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="bash"> /var/app</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> npm install</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> npm i puppeteer </span></span><br><span class="line"><span class="keyword">ENV</span> AZURE_STORAGE_CONNECTION_STRING=secret</span><br><span class="line"><span class="keyword">ENV</span> AZURE_SERVICEBUS_CONNECTION_STRING=secret</span><br><span class="line"></span><br><span class="line"><span class="comment"># Add pptr user.</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> groupadd -r pptruser &amp;&amp; useradd -r -g pptruser -G audio,video pptruser \</span></span><br><span class="line"><span class="bash">    &amp;&amp; mkdir -p /home/pptruser/Downloads \</span></span><br><span class="line"><span class="bash">    &amp;&amp; chown -R pptruser:pptruser /home/pptruser \</span></span><br><span class="line"><span class="bash">    &amp;&amp; chown -R pptruser:pptruser /var/app</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Run user as non privileged.</span></span><br><span class="line"><span class="keyword">USER</span> pptruser</span><br><span class="line"></span><br><span class="line"><span class="keyword">ENTRYPOINT</span><span class="bash"> [<span class="string">&quot;dumb-init&quot;</span>, <span class="string">&quot;--&quot;</span>]</span></span><br><span class="line"><span class="keyword">CMD</span><span class="bash"> [ <span class="string">&quot;node&quot;</span>, <span class="string">&quot;src/index.js&quot;</span> ]</span></span><br></pre></td></tr></table></figure>

<h3 id="Service-bus"><a href="#Service-bus" class="headerlink" title="Service bus"></a>Service bus</h3><p>Now that we’ve got a very basis scraper running inside a Docker container on Azure Container Instances, its time to feed to scraper with commands.<br>I therefore created a queue of <code>scrape commands</code>. I prefer using Service Bus technology over Http REST interfaces because it has better fault handling. Secondly it might take a while for a scrape commands to finish and I dont want to run in any Http timeouts or whatsoever.</p>
<p>So we have to listen to a Service Bus inside your Node application. Microsoft has created a package that can be used to setup a connection, namely: <code>azure-sb</code>.<br>Here’s the code to listen to Service Bus messages on a queue.</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> azure <span class="keyword">from</span> <span class="string">&quot;azure-sb&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Logger &#125; <span class="keyword">from</span> <span class="string">&quot;./logger&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> logger = <span class="keyword">new</span> Logger(instrumentationKey);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">checkForMessages</span>(<span class="params">sbService: azure.ServiceBusService, queueName: <span class="built_in">string</span></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> options: azure.Azure.ServiceBus.ReceiveSubscriptionMessageOptions = &#123;</span><br><span class="line">    timeoutIntervalInS: <span class="number">60</span>,</span><br><span class="line">    isPeekLock: <span class="literal">true</span></span><br><span class="line">  &#125;;</span><br><span class="line">  sbService.receiveQueueMessage(queueName, options, <span class="function"><span class="keyword">function</span> (<span class="params">err: <span class="built_in">Error</span> | <span class="literal">null</span> | <span class="built_in">string</span>, lockedMessage: azure.Azure.ServiceBus.Message</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (err) &#123;</span><br><span class="line">      <span class="keyword">if</span> (err == <span class="string">&#x27;No messages to receive&#x27;</span>) &#123;</span><br><span class="line">        logger.log(<span class="string">&#x27;No messages&#x27;</span>);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        processMessage(sbService, err, <span class="literal">null</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      processMessage(sbService, <span class="literal">null</span>, lockedMessage);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">processMessage</span>(<span class="params">sbService: azure.ServiceBusService, err: <span class="built_in">Error</span> | <span class="literal">null</span> | <span class="built_in">string</span>, lockedMsg: azure.Azure.ServiceBus.Message</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (err) &#123;</span><br><span class="line">    logger.log(<span class="string">&#x27;Error processing message: &#x27;</span> + err);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    logger.log(<span class="string">&#x27;Processing message - setting lock&#x27;</span>);</span><br><span class="line">    <span class="keyword">const</span> model = <span class="built_in">JSON</span>.parse(lockedMsg.body) <span class="keyword">as</span> Model;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Initiate your scrape here.</span></span><br><span class="line"></span><br><span class="line">    sbService.deleteMessage(lockedMsg, <span class="function"><span class="keyword">function</span> (<span class="params">err2</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (err2) &#123;</span><br><span class="line">        logger.log(<span class="string">&#x27;Failed to delete message: &#x27;</span> + err2);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        logger.log(<span class="string">&#x27;Deleted message.&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    &#125;); </span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> queueName = <span class="string">&#x27;queuename&#x27;</span>;</span><br><span class="line">logger.log(<span class="string">&#x27;Connecting to queue &#x27;</span> + queueName);</span><br><span class="line"><span class="keyword">var</span> sbService = azure.createServiceBusService(AZURE_SERVICEBUS_CONNECTION_STRING);</span><br><span class="line">sbService.createQueueIfNotExists(queueName, <span class="function"><span class="keyword">function</span> (<span class="params">err</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (err) &#123;</span><br><span class="line">    logger.log(<span class="string">&#x27;Failed to create queue: &#x27;</span> + err);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="built_in">setInterval</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        checkForMessages(sbService, queueName);</span><br><span class="line">      &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">        logger.log(<span class="string">&#x27;Error during check for messages.&#x27;</span>);</span><br><span class="line">        logger.error(error);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;, <span class="number">5000</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h3 id="Azure-Logic-Apps"><a href="#Azure-Logic-Apps" class="headerlink" title="Azure Logic Apps"></a>Azure Logic Apps</h3><img src="/images/scraper/logicapp.PNG" />
Now that we can initiate a scrape session with a Service Bus queue message. We should queue some scrape commands.
I chose to use Logic Apps for that because its on pay per use base and secondly its just a basic workflow which probably doesn't change a lot.
Another benefit of Azure Logic Apps is the ability to analyse your 'runs' and exactly see the data flow through your Logic App.
The steps are pretty basic and straight forward.

      
    </div>
    <footer class="article-footer">
      <a data-url="https://dibranmulder.github.io/2019/02/15/Building-a-Web-Scraper-in-Azure/" data-id="ckfdlvwxi000efk490tg280kp" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Azure/" rel="tag">Azure</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Docker/" rel="tag">Docker</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Functions/" rel="tag">Functions</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Logic-Apps/" rel="tag">Logic Apps</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/TypeScript/" rel="tag">TypeScript</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Wordpress/" rel="tag">Wordpress</a></li></ul>

    </footer>
  </div>
  
</article>


  


  <nav id="page-nav">
    
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/2/">Next &amp;raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/AD/" rel="tag">AD</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/AI/" rel="tag">AI</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/API-Gateway/" rel="tag">API Gateway</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/API-Management/" rel="tag">API Management</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/API-management/" rel="tag">API management</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Autonoom-rijden/" rel="tag">Autonoom rijden</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Availability-Zone/" rel="tag">Availability Zone</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Azure/" rel="tag">Azure</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Azure-DevOps/" rel="tag">Azure DevOps</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Azure-Functions/" rel="tag">Azure Functions</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Azure-Search/" rel="tag">Azure Search</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Azure-PaaS-Serverless-Teams-Agile-Versioning/" rel="tag">Azure, PaaS, Serverless, Teams, Agile, Versioning</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Blueprints/" rel="tag">Blueprints</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Cache/" rel="tag">Cache</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Caesar/" rel="tag">Caesar</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Compliance/" rel="tag">Compliance</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/CosmosDb/" rel="tag">CosmosDb</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Dependency-Injection/" rel="tag">Dependency Injection</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Docker/" rel="tag">Docker</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/EF-Core/" rel="tag">EF Core</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Entity-Framework-Core/" rel="tag">Entity Framework Core</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Functions/" rel="tag">Functions</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Functions-V2/" rel="tag">Functions V2</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Governance-Framework/" rel="tag">Governance Framework</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux/" rel="tag">Linux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Logic-Apps/" rel="tag">Logic Apps</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MSI/" rel="tag">MSI</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Migrations/" rel="tag">Migrations</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Naming-conventions/" rel="tag">Naming conventions</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/OpenAI/" rel="tag">OpenAI</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Policies/" rel="tag">Policies</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Resilient/" rel="tag">Resilient</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Resource-groups/" rel="tag">Resource groups</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SQL-Server/" rel="tag">SQL Server</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Security/" rel="tag">Security</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Self-driving-cars/" rel="tag">Self driving cars</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SendGrid/" rel="tag">SendGrid</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Service-Health/" rel="tag">Service Health</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Table-Storage/" rel="tag">Table Storage</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Tensorflow/" rel="tag">Tensorflow</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Tesla/" rel="tag">Tesla</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/TypeScript/" rel="tag">TypeScript</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/VSTS/" rel="tag">VSTS</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/WSL/" rel="tag">WSL</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Woocommerce/" rel="tag">Woocommerce</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Wordpress/" rel="tag">Wordpress</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/AD/" style="font-size: 10px;">AD</a> <a href="/tags/AI/" style="font-size: 10px;">AI</a> <a href="/tags/API-Gateway/" style="font-size: 10px;">API Gateway</a> <a href="/tags/API-Management/" style="font-size: 12.5px;">API Management</a> <a href="/tags/API-management/" style="font-size: 10px;">API management</a> <a href="/tags/Autonoom-rijden/" style="font-size: 10px;">Autonoom rijden</a> <a href="/tags/Availability-Zone/" style="font-size: 10px;">Availability Zone</a> <a href="/tags/Azure/" style="font-size: 20px;">Azure</a> <a href="/tags/Azure-DevOps/" style="font-size: 10px;">Azure DevOps</a> <a href="/tags/Azure-Functions/" style="font-size: 12.5px;">Azure Functions</a> <a href="/tags/Azure-Search/" style="font-size: 10px;">Azure Search</a> <a href="/tags/Azure-PaaS-Serverless-Teams-Agile-Versioning/" style="font-size: 10px;">Azure, PaaS, Serverless, Teams, Agile, Versioning</a> <a href="/tags/Blueprints/" style="font-size: 10px;">Blueprints</a> <a href="/tags/Cache/" style="font-size: 10px;">Cache</a> <a href="/tags/Caesar/" style="font-size: 10px;">Caesar</a> <a href="/tags/Compliance/" style="font-size: 10px;">Compliance</a> <a href="/tags/CosmosDb/" style="font-size: 15px;">CosmosDb</a> <a href="/tags/Dependency-Injection/" style="font-size: 10px;">Dependency Injection</a> <a href="/tags/Docker/" style="font-size: 10px;">Docker</a> <a href="/tags/EF-Core/" style="font-size: 10px;">EF Core</a> <a href="/tags/Entity-Framework-Core/" style="font-size: 10px;">Entity Framework Core</a> <a href="/tags/Functions/" style="font-size: 17.5px;">Functions</a> <a href="/tags/Functions-V2/" style="font-size: 10px;">Functions V2</a> <a href="/tags/Governance-Framework/" style="font-size: 10px;">Governance Framework</a> <a href="/tags/Linux/" style="font-size: 10px;">Linux</a> <a href="/tags/Logic-Apps/" style="font-size: 12.5px;">Logic Apps</a> <a href="/tags/MSI/" style="font-size: 10px;">MSI</a> <a href="/tags/Migrations/" style="font-size: 10px;">Migrations</a> <a href="/tags/Naming-conventions/" style="font-size: 10px;">Naming conventions</a> <a href="/tags/OpenAI/" style="font-size: 10px;">OpenAI</a> <a href="/tags/Policies/" style="font-size: 10px;">Policies</a> <a href="/tags/Resilient/" style="font-size: 10px;">Resilient</a> <a href="/tags/Resource-groups/" style="font-size: 10px;">Resource groups</a> <a href="/tags/SQL-Server/" style="font-size: 10px;">SQL Server</a> <a href="/tags/Security/" style="font-size: 10px;">Security</a> <a href="/tags/Self-driving-cars/" style="font-size: 10px;">Self driving cars</a> <a href="/tags/SendGrid/" style="font-size: 10px;">SendGrid</a> <a href="/tags/Service-Health/" style="font-size: 10px;">Service Health</a> <a href="/tags/Table-Storage/" style="font-size: 10px;">Table Storage</a> <a href="/tags/Tensorflow/" style="font-size: 10px;">Tensorflow</a> <a href="/tags/Tesla/" style="font-size: 10px;">Tesla</a> <a href="/tags/TypeScript/" style="font-size: 10px;">TypeScript</a> <a href="/tags/VSTS/" style="font-size: 10px;">VSTS</a> <a href="/tags/WSL/" style="font-size: 10px;">WSL</a> <a href="/tags/Woocommerce/" style="font-size: 10px;">Woocommerce</a> <a href="/tags/Wordpress/" style="font-size: 12.5px;">Wordpress</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/09/">september 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/12/">december 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/09/">september 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/08/">augustus 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/06/">juni 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/05/">mei 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/04/">april 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/03/">maart 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/02/">februari 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/01/">januari 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/12/">december 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/11/">november 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/10/">oktober 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/08/">augustus 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/07/">juli 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/06/">juni 2018</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2020/09/22/Improving-your-Azure-Seach-performance/">Improving your Azure Cognitive Seach performance</a>
          </li>
        
          <li>
            <a href="/2019/12/06/Applying-an-Azure-Governance-Framework-in-10-steps/">Applying an Azure Governance Framework in 10 steps</a>
          </li>
        
          <li>
            <a href="/2019/09/06/Running-an-OpenAI-Gym-on-Windows-with-WSL/">Running an OpenAI Gym on Windows with WSL</a>
          </li>
        
          <li>
            <a href="/2019/08/23/Sending-e-mails-with-SendGrid-and-Azure-Functions/">Sending e-mails with SendGrid and Azure Functions</a>
          </li>
        
          <li>
            <a href="/2019/08/16/Autonoom-rijden/">Autonoom rijden</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2020 Dibran Mulder<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  
<link rel="stylesheet" href="/fancybox/jquery.fancybox.css">

  
<script src="/fancybox/jquery.fancybox.pack.js"></script>




<script src="/js/script.js"></script>




  </div>
</body>
</html>