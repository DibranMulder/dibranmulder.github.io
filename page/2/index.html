<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-30986898-2"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-30986898-2');
</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({
          google_ad_client: "ca-pub-1187111537862676",
          enable_page_level_ads: true
     });
</script>
  
  <title>Dibran&#39;s Blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="Dibran&#39;s Blog">
<meta property="og:url" content="https://dibranmulder.github.io/page/2/index.html">
<meta property="og:site_name" content="Dibran&#39;s Blog">
<meta property="og:locale">
<meta property="article:author" content="Dibran Mulder">
<meta property="article:tag" content="Azure, Development, Cloud, DevOps.">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="Dibran&#39;s Blog" type="application/atom+xml">
  
  
    <link rel="icon" href="favicon.ico">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  
<link rel="stylesheet" href="/css/style.css">

<!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-math@4.0.0/dist/style.css">
<!-- hexo injector head_end end --><meta name="generator" content="Hexo 5.2.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Dibran&#39;s Blog</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://dibranmulder.github.io"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-Using-Wordpress-in-Serverless-Azure" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/01/25/Using-Wordpress-in-Serverless-Azure/" class="article-date">
  <time datetime="2019-01-25T08:12:18.000Z" itemprop="datePublished">2019-01-25</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/01/25/Using-Wordpress-in-Serverless-Azure/">Using Wordpress / Woocommerce in Serverless Azure</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Sometimes Wordpress isn’t that bad. When for instance you’re building a SEO optimized landing page for a custom made tool and you don’t want to develop everything your self. Secondly, Wordpress has thousands of plugins that can be very useful. In my case we are using Woocomerce with a subscription payment module, so that we can manage payed subscriptions for our tool and secondly we want to manage the user accounts inside Wordpress. This saves me lots of development hours and next to that I don’t have to build any maintenance tooling since that is already inplace in Wordpress. So first line support can be done by not-so-much technical people, in other words they won’t call for every problem :)</p>
<h2 id="Overview"><a href="#Overview" class="headerlink" title="Overview"></a>Overview</h2><img src="/images/wordpress azure.png" />
So in essence its very easy. We just have a user with a single set of credentials which he can use in both the SEO optimized page, lets say `example.com` and in the custom made tool lets say `app.example.com`. Using the [JWT Authentication for WP REST API](https://wordpress.org/plugins/jwt-authentication-for-wp-rest-api/) plugin of Wordpress we can login any user and get a JWT bearer token as response. The JWT Authentication plugin requires a JWT Auth Secret key which we can define and share with the `Azure Functions` backend. The functions backend then checks the validity of incoming Bearer token with the shared JWT Auth Secret key, making an additional call to Wordpress unnecessary. Its blazing fast.

<p>But we are not there yet. We need some communication between the Functions backend and Wordpress on an application to application level. In my case I want to retrieve the available subscriptions and the active subscription for a user from Wordpress / Woocommerce. Subscriptions are the trial, starter, business and pro packs that users can buy and those “packs” enable the user some privileges inside my Angular tool. Since its app to app communication I can’t use a Bearer token, because thats user context bounded, and secondly the <a target="_blank" rel="noopener" href="https://docs.woocommerce.com/document/woocommerce-rest-api/">Woocommerce API</a> requires an OAuth 1.0 authentication. It comes down to this. The Functions backend requires a <code>Consumer key</code> and a <code>Consumer secret</code> which need to be passed into a query string. Postman has excellent OAuth 1.0 support to test it out.</p>
<p><strong>Keep in mind to not add the empty parameters to the signature. Woocommerce doesn’t support it.</strong></p>
<img src="/images/postman oauth1.png" />

<p>So how does this look like in code. There are 2 parts that I want to share with you. Verifying a JWT Bearer token based on a JWT Auth Secret key and the OAuth 1 implementation with Woocommerce.</p>
<h3 id="Verifying-a-JWT-Bearer-token"><a href="#Verifying-a-JWT-Bearer-token" class="headerlink" title="Verifying a JWT Bearer token"></a>Verifying a JWT Bearer token</h3><ul>
<li><p>Perform a Http REST call from Angular.</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">async</span> authenticate(username: <span class="built_in">string</span>, password: <span class="built_in">string</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> authResponse = <span class="keyword">await</span> <span class="built_in">this</span>.http.post(environment.wordpressBackend + <span class="built_in">this</span>.jwtEndpoint, &#123; username, password &#125;).toPromise();</span><br><span class="line">    <span class="built_in">localStorage</span>.setItem(<span class="string">&#x27;token&#x27;</span>, (authResponse <span class="keyword">as</span> AuthResponse).token);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">async</span> getSubscription() &#123;</span><br><span class="line">    <span class="keyword">const</span> res = <span class="keyword">await</span> <span class="built_in">this</span>.http.get(environment.tradersmateBackend + <span class="string">&#x27;api/subscriptions&#x27;</span>).toPromise();</span><br><span class="line">    <span class="built_in">localStorage</span>.setItem(<span class="string">&#x27;subscription&#x27;</span>, res <span class="keyword">as</span> <span class="built_in">string</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>Wordpress anwers with a JWT Bearer token and some meta information.</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;token&quot;</span>: <span class="string">&quot;secrettokenwillbehere&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;user_email&quot;</span>: <span class="string">&quot;dibran@example.com&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;user_nicename&quot;</span>: <span class="string">&quot;dibranmulder&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;user_display_name&quot;</span>: <span class="string">&quot;Dibran Mulder&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>Perform a <code>protected</code> Azure Function call, using an Angular interceptor to add the Bearer token.</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Injectable &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/core&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">  HttpRequest,</span><br><span class="line">  HttpHandler,</span><br><span class="line">  HttpEvent,</span><br><span class="line">  HttpInterceptor</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/common/http&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; AuthService &#125; <span class="keyword">from</span> <span class="string">&#x27;./auth.service&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Observable &#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Injectable</span>()</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> TokenInterceptor <span class="keyword">implements</span> HttpInterceptor &#123;</span><br><span class="line">  <span class="keyword">constructor</span>(<span class="params"><span class="keyword">public</span> auth: AuthService</span>) &#123;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  intercept(request: HttpRequest&lt;<span class="built_in">any</span>&gt;, next: HttpHandler): Observable&lt;HttpEvent&lt;<span class="built_in">any</span>&gt;&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> token = <span class="built_in">this</span>.auth.getToken();</span><br><span class="line">    <span class="keyword">if</span> (token) &#123;</span><br><span class="line">      request = request.clone(&#123;</span><br><span class="line">        setHeaders: &#123;</span><br><span class="line">          Authorization: <span class="string">`Bearer <span class="subst">$&#123;token&#125;</span>`</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> next.handle(request);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>A backend Azure Function checks the incoming Http Request and validates the Bearer token. </p>
</li>
<li><p>Don’t forget to respond with a 401 status code when the token is invalid.</p>
</li>
</ul>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">FunctionName(<span class="meta-string">&quot;SomeGet&quot;</span>)</span>]</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">async</span> Task&lt;HttpResponseMessage&gt; <span class="title">GetSome</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    [HttpTrigger(AuthorizationLevel.Anonymous, <span class="string">&quot;get&quot;</span>, Route = <span class="string">&quot;some&quot;</span></span>)] HttpRequestMessage req,</span></span><br><span class="line"><span class="function">    [Inject] IValidateJwt validateJwt,</span></span><br><span class="line"><span class="function">    ILogger log)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">try</span></span><br><span class="line">    &#123;</span><br><span class="line">        log.LogInformation(<span class="string">&quot;Product add called&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Throws an UnAuthorizedException exception when the Bearer token can&#x27;t be validated.</span></span><br><span class="line">        <span class="keyword">int</span> userId = validateJwt.ValidateToken(req);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Do some business logic here.</span></span><br><span class="line">        <span class="keyword">var</span> results = ...</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> req.CreateResponse(HttpStatusCode.OK, results);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (UnAuthorizedException e)</span><br><span class="line">    &#123;</span><br><span class="line">        log.LogError(e.Message, e);</span><br><span class="line">        <span class="keyword">return</span> req.CreateResponse(HttpStatusCode.Unauthorized);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (Exception e)</span><br><span class="line">    &#123;</span><br><span class="line">        log.LogError(e.Message, e);</span><br><span class="line">        <span class="keyword">return</span> req.CreateErrorResponse(HttpStatusCode.BadRequest, e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>Verify the Bearer token inside your Azure Functions.</li>
<li>Inject the JWT Auth Secret Key into the constructor.</li>
</ul>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ValidateJwt</span> : <span class="title">IValidateJwt</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">const</span> <span class="keyword">string</span> dataClaimType = <span class="string">&quot;data&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">readonly</span> TokenValidationParameters tokenValidationParameters;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ValidateJwt</span>(<span class="params"><span class="keyword">string</span> secretKey</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        tokenValidationParameters = <span class="keyword">new</span> TokenValidationParameters</span><br><span class="line">        &#123;</span><br><span class="line">            IssuerSigningKey = <span class="keyword">new</span> SymmetricSecurityKey(Encoding.ASCII.GetBytes(secretKey)),</span><br><span class="line">            ValidateIssuerSigningKey = <span class="literal">true</span>,</span><br><span class="line">            ValidateIssuer = <span class="literal">false</span>,</span><br><span class="line">            ValidateAudience = <span class="literal">false</span></span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">ValidateToken</span>(<span class="params">HttpRequestMessage httpRequest</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">try</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// We need bearer authentication.</span></span><br><span class="line">            <span class="keyword">if</span> (httpRequest.Headers.Authorization.Scheme != <span class="string">&quot;Bearer&quot;</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> UnAuthorizedException();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Get the token.</span></span><br><span class="line">            <span class="keyword">string</span> authToken = httpRequest.Headers.Authorization.Parameter;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">string</span>.IsNullOrEmpty(authToken))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> UnAuthorizedException();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">var</span> tokenHandler = <span class="keyword">new</span> JwtSecurityTokenHandler();</span><br><span class="line">            <span class="comment">// Validate it.</span></span><br><span class="line">            ClaimsPrincipal principal = tokenHandler.ValidateToken(authToken, tokenValidationParameters, <span class="keyword">out</span> SecurityToken validatedToken);</span><br><span class="line">            <span class="keyword">if</span> (principal.Identity.IsAuthenticated)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// Check for a data claim.</span></span><br><span class="line">                <span class="keyword">if</span> (principal.HasClaim(x =&gt; x.Type == dataClaimType))</span><br><span class="line">                &#123;</span><br><span class="line">                    Claim dataClaim = principal.Claims.FirstOrDefault(x =&gt; x.Type == dataClaimType);</span><br><span class="line">                    <span class="keyword">var</span> userObj = JsonConvert.DeserializeObject&lt;DataClaim&gt;(dataClaim.Value);</span><br><span class="line">                    <span class="comment">// With a user object.</span></span><br><span class="line">                    <span class="keyword">if</span> (userObj != <span class="literal">null</span> &amp;&amp; userObj.User != <span class="literal">null</span>)</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="keyword">return</span> userObj.User.Id;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// Do nothing</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> UnAuthorizedException();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Calling-Woocommerce-with-OAuth-1-0"><a href="#Calling-Woocommerce-with-OAuth-1-0" class="headerlink" title="Calling Woocommerce with OAuth 1.0"></a>Calling Woocommerce with OAuth 1.0</h2><p>To interact with the Woocommerce API we need to implement the OAuth 1 flow. Its not used that much so you won’t find a lot of C# examples online. Here’s mine.</p>
<p>Inject a <code>HttpClient</code>, <code>ConsumerKey</code> and <code>ConsumerSecret</code> into the Constructor. Only set the OAuth properties that are actually used, remember the Postman option with including empty parameters. It was a pain in the ass to get in working but I tested this client with Wordpress 5.0.3 and Woocommerce 3.5.4.</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">WordpressHttpClient</span> : <span class="title">BaseHttpClient</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">readonly</span> <span class="keyword">string</span> consumerKey;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">readonly</span> <span class="keyword">string</span> consumerSecret;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">readonly</span> Random rand;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">WordpressHttpClient</span>(<span class="params"><span class="keyword">string</span> consumerKey, <span class="keyword">string</span> consumerSecret, HttpClient httpClient</span>)</span></span><br><span class="line"><span class="function">        : <span class="title">base</span>(<span class="params">httpClient</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        rand = <span class="keyword">new</span> Random();</span><br><span class="line">        <span class="keyword">this</span>.consumerKey = consumerKey;</span><br><span class="line">        <span class="keyword">this</span>.consumerSecret = consumerSecret;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">async</span> Task&lt;IEnumerable&lt;Subscription&gt;&gt; GetSubscriptionsAsync()</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> nonce = GetNonce();</span><br><span class="line">        <span class="keyword">var</span> timeStamp = GetTimeStamp();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> queryCollection = HttpUtility.ParseQueryString(<span class="keyword">string</span>.Empty);</span><br><span class="line">        queryCollection[<span class="string">&quot;oauth_consumer_key&quot;</span>] = consumerKey;</span><br><span class="line">        queryCollection[<span class="string">&quot;oauth_signature_method&quot;</span>] = <span class="string">&quot;HMAC-SHA1&quot;</span>;</span><br><span class="line">        queryCollection[<span class="string">&quot;oauth_timestamp&quot;</span>] = timeStamp;</span><br><span class="line">        queryCollection[<span class="string">&quot;oauth_nonce&quot;</span>] = nonce;</span><br><span class="line">        queryCollection[<span class="string">&quot;oauth_version&quot;</span>] = <span class="string">&quot;1.0&quot;</span>;</span><br><span class="line">        <span class="keyword">string</span> baseQueryString = queryCollection.ToString();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> requestParameters = <span class="keyword">new</span> List&lt;<span class="keyword">string</span>&gt;();</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">string</span> key <span class="keyword">in</span> queryCollection)</span><br><span class="line">        &#123;</span><br><span class="line">            requestParameters.Add(<span class="string">$&quot;<span class="subst">&#123;key&#125;</span>=<span class="subst">&#123;queryCollection[key]&#125;</span>&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// We need to sign a base string.</span></span><br><span class="line">        <span class="keyword">string</span> otherBase = GetSignatureBaseString(HttpMethod.Get.ToString(), <span class="string">&quot;https://www.example.com/wp-json/wc/v1/subscriptions&quot;</span>, requestParameters);</span><br><span class="line">        <span class="keyword">var</span> otherSignature = GetSignature(otherBase, consumerSecret);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Add that signature to the query parameters.</span></span><br><span class="line">        queryCollection[<span class="string">&quot;oauth_signature&quot;</span>] = otherSignature;</span><br><span class="line">        <span class="keyword">string</span> finalQueryString = queryCollection.ToString();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// And actually perform the request.</span></span><br><span class="line">        <span class="keyword">var</span> finalUri = <span class="keyword">new</span> Uri(<span class="string">&quot;https://www.example.com/wp-json/wc/v1/subscriptions?&quot;</span> + finalQueryString, UriKind.Absolute);</span><br><span class="line">        HttpRequestMessage httpRequestMessage = <span class="keyword">new</span> HttpRequestMessage(HttpMethod.Get, finalUri);</span><br><span class="line">        <span class="keyword">var</span> response = <span class="keyword">await</span> Client.SendAsync(httpRequestMessage);</span><br><span class="line">        response.EnsureSuccessStatusCode();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">await</span> response.Content.ReadAsAsync&lt;Subscription[]&gt;();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">string</span> <span class="title">GetNonce</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">var</span> nonce = rand.Next(<span class="number">1000000000</span>);</span><br><span class="line">        <span class="keyword">return</span> nonce.ToString();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">string</span> <span class="title">GetTimeStamp</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">var</span> ts = DateTime.UtcNow - <span class="keyword">new</span> DateTime(<span class="number">1970</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">return</span> Convert.ToInt64(ts.TotalSeconds).ToString();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">string</span> <span class="title">GetSignature</span>(<span class="params"><span class="keyword">string</span> signatureBaseString, <span class="keyword">string</span> consumerSecret, <span class="keyword">string</span> tokenSecret = <span class="literal">null</span></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">var</span> hmacsha1 = <span class="keyword">new</span> HMACSHA1();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> key = Uri.EscapeDataString(consumerSecret) + <span class="string">&quot;&amp;&quot;</span> + (<span class="keyword">string</span>.IsNullOrEmpty(tokenSecret)</span><br><span class="line">                        ? <span class="string">&quot;&quot;</span></span><br><span class="line">                        : Uri.EscapeDataString(tokenSecret));</span><br><span class="line">        hmacsha1.Key = Encoding.ASCII.GetBytes(key);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> dataBuffer = Encoding.ASCII.GetBytes(signatureBaseString);</span><br><span class="line">        <span class="keyword">var</span> hashBytes = hmacsha1.ComputeHash(dataBuffer);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> Convert.ToBase64String(hashBytes);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">string</span> <span class="title">GetSignatureBaseString</span>(<span class="params"><span class="keyword">string</span> method, <span class="keyword">string</span> url, List&lt;<span class="keyword">string</span>&gt; requestParameters</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">var</span> sortedList = <span class="keyword">new</span> List&lt;<span class="keyword">string</span>&gt;(requestParameters);</span><br><span class="line">        sortedList.Sort();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> requestParametersSortedString = ConcatList(sortedList, <span class="string">&quot;&amp;&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Url must be slightly reformatted because of:</span></span><br><span class="line">        url = ConstructRequestUrl(url);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> method.ToUpper() + <span class="string">&quot;&amp;&quot;</span> + Uri.EscapeDataString(url) + <span class="string">&quot;&amp;&quot;</span> +</span><br><span class="line">                Uri.EscapeDataString(requestParametersSortedString);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">string</span> <span class="title">ConstructRequestUrl</span>(<span class="params"><span class="keyword">string</span> url</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">var</span> uri = <span class="keyword">new</span> Uri(url, UriKind.Absolute);</span><br><span class="line">        <span class="keyword">var</span> normUrl = <span class="keyword">string</span>.Format(<span class="string">&quot;&#123;0&#125;://&#123;1&#125;&quot;</span>, uri.Scheme, uri.Host);</span><br><span class="line">        <span class="keyword">if</span> (!(uri.Scheme == <span class="string">&quot;http&quot;</span> &amp;&amp; uri.Port == <span class="number">80</span> || uri.Scheme == <span class="string">&quot;https&quot;</span> &amp;&amp; uri.Port == <span class="number">443</span>))</span><br><span class="line">        &#123;</span><br><span class="line">            normUrl += <span class="string">&quot;:&quot;</span> + uri.Port;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        normUrl += uri.AbsolutePath;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> normUrl;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Dictionary&lt;<span class="keyword">string</span>, <span class="keyword">string</span>&gt; <span class="title">ExtractQueryParameters</span>(<span class="params"><span class="keyword">string</span> queryString</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">if</span> (queryString.StartsWith(<span class="string">&quot;?&quot;</span>))</span><br><span class="line">            queryString = queryString.Remove(<span class="number">0</span>, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> result = <span class="keyword">new</span> Dictionary&lt;<span class="keyword">string</span>, <span class="keyword">string</span>&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">string</span>.IsNullOrEmpty(queryString))</span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">var</span> s <span class="keyword">in</span> queryString.Split(<span class="string">&#x27;&amp;&#x27;</span>))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (!<span class="keyword">string</span>.IsNullOrEmpty(s) &amp;&amp; !s.StartsWith(<span class="string">&quot;oauth_&quot;</span>))</span><br><span class="line">            &#123;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (s.IndexOf(<span class="string">&#x27;=&#x27;</span>) &gt; <span class="number">-1</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">var</span> temp = s.Split(<span class="string">&#x27;=&#x27;</span>);</span><br><span class="line">                    result.Add(temp[<span class="number">0</span>], temp[<span class="number">1</span>]);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    result.Add(s, <span class="keyword">string</span>.Empty);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">string</span> <span class="title">ConcatList</span>(<span class="params">IEnumerable&lt;<span class="keyword">string</span>&gt; source, <span class="keyword">string</span> separator</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">var</span> sb = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">var</span> s <span class="keyword">in</span> source)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (sb.Length == <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                sb.Append(s);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                sb.Append(separator);</span><br><span class="line">                sb.Append(s);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> sb.ToString();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
      
    </div>
    <footer class="article-footer">
      <a data-url="https://dibranmulder.github.io/2019/01/25/Using-Wordpress-in-Serverless-Azure/" data-id="ckfdlvwy6000rfk491bdm8780" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Azure/" rel="tag">Azure</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Functions/" rel="tag">Functions</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Woocommerce/" rel="tag">Woocommerce</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Wordpress/" rel="tag">Wordpress</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Azure-Functions-Http-Response-caching" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/01/14/Azure-Functions-Http-Response-caching/" class="article-date">
  <time datetime="2019-01-14T13:06:13.000Z" itemprop="datePublished">2019-01-14</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/01/14/Azure-Functions-Http-Response-caching/">Azure Functions Http Response caching</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>As you might know its a <a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/azure/azure-functions/functions-best-practices#write-functions-to-be-stateless">best practice to keep your Azure Functions stateless</a>. That means that also in memory caching should not be done inside your functions. Especially when you’re using a consumption plan. Your cache will be recycled when the plan goes to sleep.<br>What a lot of fokes forget is that the Http protocol as of Http 1.1 contains caching. Setting the right caching headers on a <code>HttpResponseMessage</code> is actually quite easy.</p>
<p><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/aspnet/core/performance/caching/response?view=aspnetcore-2.2">In ASP.net core we even had packages for us to do that</a>. Those obviously don’t work for functions since the attributes can’t be placed on top of Azure Functions with Http Triggers. So sadly we’ve to write code to se the right headers. However its so easy that you won’t be sad for long.</p>
<p>Here’s a simple Http triggered function. Notice the <code>CreateCachedResponse</code> instead of <code>CreateResponse</code> extension method.</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">FunctionName(<span class="meta-string">&quot;SomeFunction&quot;</span>)</span>]</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">async</span> Task&lt;HttpResponseMessage&gt; <span class="title">SomeHttpTriggeredFunctions</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    [HttpTrigger(AuthorizationLevel.Anonymous, <span class="string">&quot;post&quot;</span>, Route = <span class="string">&quot;some/route&quot;</span></span>)] HttpRequestMessage req,</span></span><br><span class="line"><span class="function">    ILogger log)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">try</span></span><br><span class="line">    &#123;</span><br><span class="line">        log.LogInformation(<span class="string">&quot;SomeFunction called&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Do something</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> req.CreateCachedResponse(HttpStatusCode.OK, response);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (Exception e)</span><br><span class="line">    &#123;</span><br><span class="line">        log.LogError(e.Message, e);</span><br><span class="line">        <span class="keyword">return</span> req.CreateErrorResponse(HttpStatusCode.BadRequest, e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>In the extension method we will simply add some headers to the response.</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Net;</span><br><span class="line"><span class="keyword">using</span> System.Net.Http;</span><br><span class="line"><span class="keyword">using</span> System.Net.Http.Headers;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title">CacheResponseExtensions</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> HttpResponseMessage <span class="title">CreateCachedResponse</span>&lt;<span class="title">T</span>&gt;(<span class="params"><span class="keyword">this</span> HttpRequestMessage request, HttpStatusCode statusCode, T <span class="keyword">value</span>, TimeSpan? maxAge = <span class="literal">null</span></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        HttpResponseMessage responseMessage = request.CreateResponse&lt;T&gt;(statusCode, <span class="keyword">value</span>);</span><br><span class="line">        responseMessage.Headers.CacheControl = <span class="keyword">new</span> CacheControlHeaderValue()</span><br><span class="line">        &#123;</span><br><span class="line">            Public = <span class="literal">true</span>,</span><br><span class="line">            MaxAge = maxAge ?? defaultTimeSpan</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">return</span> responseMessage;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>And voila we’ve got client side caching working.</p>
<img src="/images/cache-functions.png" />


<p><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/aspnet/core/performance/caching/response?view=aspnetcore-2.2">https://docs.microsoft.com/en-us/aspnet/core/performance/caching/response?view=aspnetcore-2.2</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://dibranmulder.github.io/2019/01/14/Azure-Functions-Http-Response-caching/" data-id="ckfdlvwxf000bfk49evw6edse" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Azure/" rel="tag">Azure</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Cache/" rel="tag">Cache</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Functions/" rel="tag">Functions</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Azure-API-Management-ARM-Cheatsheet" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/12/19/Azure-API-Management-ARM-Cheatsheet/" class="article-date">
  <time datetime="2018-12-19T09:09:25.000Z" itemprop="datePublished">2018-12-19</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/12/19/Azure-API-Management-ARM-Cheatsheet/">Azure API Management ARM Cheat sheet</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Deploying an API Management instance via ARM is complicated. I’ve created a cheat sheet to help you out.<br>Alot is copied from a complete template originating from <a target="_blank" rel="noopener" href="https://github.com/Azure/azure-quickstart-templates/tree/master/201-api-management-create-all-resources">Github</a>.</p>
<h2 id="ARM"><a href="#ARM" class="headerlink" title="ARM"></a>ARM</h2><p>ARM might be the way to deploy a pre-setup instance. For adding API’s to an existing API Management instance I prefer to use the <a target="_blank" rel="noopener" href="https://github.com/stephaneey/azure-apim-extension">API Management extensions</a> from the Azure DevOps Marketplace. </p>
<h3 id="Instance"><a href="#Instance" class="headerlink" title="Instance"></a>Instance</h3><p>Parameterize every option, in your ARM script. Resources sucha as policies, products, api’s and such go into the sub resources array.</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;apiVersion&quot;</span>: <span class="string">&quot;2017-03-01&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;[variables(&#x27;apiManagementServiceName&#x27;)]&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;Microsoft.ApiManagement/service&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;location&quot;</span>: <span class="string">&quot;[parameters(&#x27;location&#x27;)]&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;tags&quot;</span>: &#123;&#125;,</span><br><span class="line">    <span class="attr">&quot;sku&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;[parameters(&#x27;sku&#x27;)]&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;capacity&quot;</span>: <span class="string">&quot;[parameters(&#x27;skuCount&#x27;)]&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;properties&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;publisherEmail&quot;</span>: <span class="string">&quot;[parameters(&#x27;publisherEmail&#x27;)]&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;publisherName&quot;</span>: <span class="string">&quot;[parameters(&#x27;publisherName&#x27;)]&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;resources&quot;</span>: []</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Tenant-policy"><a href="#Tenant-policy" class="headerlink" title="Tenant policy"></a>Tenant policy</h3><p>To create a tenant wide policy.</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;apiVersion&quot;</span>: <span class="string">&quot;2017-03-01&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;policies&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;policy&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;dependsOn&quot;</span>: [</span><br><span class="line">        <span class="string">&quot;[concat(&#x27;Microsoft.ApiManagement/service/&#x27;, variables(&#x27;apiManagementServiceName&#x27;))]&quot;</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">&quot;properties&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;policyContent&quot;</span>: <span class="string">&quot;[parameters(&#x27;tenantPolicy&#x27;)]&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="API’s"><a href="#API’s" class="headerlink" title="API’s"></a>API’s</h3><p>Adding API’s can be done via Open API definitions. If your Open API definition doesn’t contain a <code>host</code> property, like: <code>&quot;host&quot;:&quot;somewebsite.azurewebsites.net&quot;</code>. Then you should add the <code>service url</code> property inside your ARM.</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;apiVersion&quot;</span>: <span class="string">&quot;2017-03-01&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;apis&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;PetStoreSwaggerImportExample&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;dependsOn&quot;</span>: [</span><br><span class="line">        <span class="string">&quot;[concat(&#x27;Microsoft.ApiManagement/service/&#x27;, variables(&#x27;apiManagementServiceName&#x27;))]&quot;</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">&quot;properties&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;contentFormat&quot;</span>: <span class="string">&quot;SwaggerLinkJson&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;contentValue&quot;</span>: <span class="string">&quot;http://petstore.swagger.io/v2/swagger.json&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;path&quot;</span>: <span class="string">&quot;examplepetstore&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>You can also add operations manually, without using Open API definitions.</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;apiVersion&quot;</span>: <span class="string">&quot;2017-03-01&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;apis&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;exampleApi&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;dependsOn&quot;</span>: [</span><br><span class="line">        <span class="string">&quot;[concat(&#x27;Microsoft.ApiManagement/service/&#x27;, variables(&#x27;apiManagementServiceName&#x27;))]&quot;</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">&quot;properties&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;displayName&quot;</span>: <span class="string">&quot;Example API Name&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;description&quot;</span>: <span class="string">&quot;Description for example API&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;serviceUrl&quot;</span>: <span class="string">&quot;https://example.net&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;path&quot;</span>: <span class="string">&quot;exampleapipath&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;protocols&quot;</span>: [</span><br><span class="line">            <span class="string">&quot;HTTPS&quot;</span></span><br><span class="line">        ]</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;resources&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">&quot;apiVersion&quot;</span>: <span class="string">&quot;2017-03-01&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;operations&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;exampleOperationsDELETE&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;dependsOn&quot;</span>: [</span><br><span class="line">                <span class="string">&quot;[concat(&#x27;Microsoft.ApiManagement/service/&#x27;, variables(&#x27;apiManagementServiceName&#x27;), &#x27;/apis/exampleApi&#x27;)]&quot;</span></span><br><span class="line">            ],</span><br><span class="line">            <span class="attr">&quot;properties&quot;</span>: &#123;</span><br><span class="line">                <span class="attr">&quot;displayName&quot;</span>: <span class="string">&quot;DELETE resource&quot;</span>,</span><br><span class="line">                <span class="attr">&quot;method&quot;</span>: <span class="string">&quot;DELETE&quot;</span>,</span><br><span class="line">                <span class="attr">&quot;urlTemplate&quot;</span>: <span class="string">&quot;/resource&quot;</span>,</span><br><span class="line">                <span class="attr">&quot;description&quot;</span>: <span class="string">&quot;A demonstration of a DELETE call&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">&quot;apiVersion&quot;</span>: <span class="string">&quot;2017-03-01&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;operations&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;exampleOperationsGET&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;dependsOn&quot;</span>: [</span><br><span class="line">                <span class="string">&quot;[concat(&#x27;Microsoft.ApiManagement/service/&#x27;, variables(&#x27;apiManagementServiceName&#x27;), &#x27;/apis/exampleApi&#x27;)]&quot;</span></span><br><span class="line">            ],</span><br><span class="line">            <span class="attr">&quot;properties&quot;</span>: &#123;</span><br><span class="line">                <span class="attr">&quot;displayName&quot;</span>: <span class="string">&quot;GET resource&quot;</span>,</span><br><span class="line">                <span class="attr">&quot;method&quot;</span>: <span class="string">&quot;GET&quot;</span>,</span><br><span class="line">                <span class="attr">&quot;urlTemplate&quot;</span>: <span class="string">&quot;/resource&quot;</span>,</span><br><span class="line">                <span class="attr">&quot;description&quot;</span>: <span class="string">&quot;A demonstration of a GET call&quot;</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">&quot;resources&quot;</span>: [</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="attr">&quot;apiVersion&quot;</span>: <span class="string">&quot;2017-03-01&quot;</span>,</span><br><span class="line">                    <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;policies&quot;</span>,</span><br><span class="line">                    <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;policy&quot;</span>,</span><br><span class="line">                    <span class="attr">&quot;dependsOn&quot;</span>: [</span><br><span class="line">                        <span class="string">&quot;[concat(&#x27;Microsoft.ApiManagement/service/&#x27;, variables(&#x27;apiManagementServiceName&#x27;))]&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;[concat(&#x27;Microsoft.ApiManagement/service/&#x27;, variables(&#x27;apiManagementServiceName&#x27;), &#x27;/apis/exampleApi&#x27;)]&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;[concat(&#x27;Microsoft.ApiManagement/service/&#x27;, variables(&#x27;apiManagementServiceName&#x27;), &#x27;/apis/exampleApi/operations/exampleOperationsGET&#x27;)]&quot;</span></span><br><span class="line">                    ],</span><br><span class="line">                    <span class="attr">&quot;properties&quot;</span>: &#123;</span><br><span class="line">                        <span class="attr">&quot;policyContent&quot;</span>: <span class="string">&quot;[parameters(&#x27;operationPolicy&#x27;)]&quot;</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            ]</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>There are also other ways, such as WSDL, and inserting Open API definitions as a value in your ARM.<br>See the <a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/azure/templates/microsoft.apimanagement/2017-03-01/service/apis">documentation</a> and check for <code>contentFormat</code> and <code>contentValue</code>.</p>
<h3 id="Product"><a href="#Product" class="headerlink" title="Product"></a>Product</h3><p>To create a product and add API’s directly to the product.</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;apiVersion&quot;</span>: <span class="string">&quot;2017-03-01&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;products&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;exampleProduct&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;dependsOn&quot;</span>: [</span><br><span class="line">        <span class="string">&quot;[concat(&#x27;Microsoft.ApiManagement/service/&#x27;, variables(&#x27;apiManagementServiceName&#x27;))]&quot;</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">&quot;properties&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;displayName&quot;</span>: <span class="string">&quot;Example Product Name&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;description&quot;</span>: <span class="string">&quot;Description for example product&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;terms&quot;</span>: <span class="string">&quot;Terms for example product&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;subscriptionRequired&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="attr">&quot;approvalRequired&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="attr">&quot;subscriptionsLimit&quot;</span>: <span class="number">1</span>,</span><br><span class="line">        <span class="attr">&quot;state&quot;</span>: <span class="string">&quot;published&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;resources&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">&quot;apiVersion&quot;</span>: <span class="string">&quot;2017-03-01&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;apis&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;exampleApi&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;dependsOn&quot;</span>: [</span><br><span class="line">                <span class="string">&quot;[concat(&#x27;Microsoft.ApiManagement/service/&#x27;, variables(&#x27;apiManagementServiceName&#x27;))]&quot;</span>,</span><br><span class="line">                <span class="string">&quot;[concat(&#x27;Microsoft.ApiManagement/service/&#x27;, variables(&#x27;apiManagementServiceName&#x27;), &#x27;/apis/exampleApi&#x27;)]&quot;</span>,</span><br><span class="line">                <span class="string">&quot;[concat(&#x27;Microsoft.ApiManagement/service/&#x27;, variables(&#x27;apiManagementServiceName&#x27;), &#x27;/products/exampleProduct&#x27;)]&quot;</span></span><br><span class="line">            ]</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">&quot;apiVersion&quot;</span>: <span class="string">&quot;2017-03-01&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;policies&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;policy&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;dependsOn&quot;</span>: [</span><br><span class="line">                <span class="string">&quot;[concat(&#x27;Microsoft.ApiManagement/service/&#x27;, variables(&#x27;apiManagementServiceName&#x27;))]&quot;</span>,</span><br><span class="line">                <span class="string">&quot;[concat(&#x27;Microsoft.ApiManagement/service/&#x27;, variables(&#x27;apiManagementServiceName&#x27;), &#x27;/products/exampleProduct&#x27;)]&quot;</span></span><br><span class="line">            ],</span><br><span class="line">            <span class="attr">&quot;properties&quot;</span>: &#123;</span><br><span class="line">                <span class="attr">&quot;policyContent&quot;</span>: <span class="string">&quot;[parameters(&#x27;productPolicy&#x27;)]&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="User"><a href="#User" class="headerlink" title="User"></a>User</h3><p>To create a user. But think of using Azure AAD integration.</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;apiVersion&quot;</span>: <span class="string">&quot;2017-03-01&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;users&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;exampleUser1&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;dependsOn&quot;</span>: [</span><br><span class="line">        <span class="string">&quot;[concat(&#x27;Microsoft.ApiManagement/service/&#x27;, variables(&#x27;apiManagementServiceName&#x27;))]&quot;</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">&quot;properties&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;firstName&quot;</span>: <span class="string">&quot;ExampleFirstName1&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;lastName&quot;</span>: <span class="string">&quot;ExampleLastName1&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;email&quot;</span>: <span class="string">&quot;ExampleFirst1@example.com&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;state&quot;</span>: <span class="string">&quot;active&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;note&quot;</span>: <span class="string">&quot;note for example user 1&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Group"><a href="#Group" class="headerlink" title="Group"></a>Group</h3><p>To create a group of users.</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;apiVersion&quot;</span>: <span class="string">&quot;2017-03-01&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;groups&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;exampleGroup&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;dependsOn&quot;</span>: [</span><br><span class="line">        <span class="string">&quot;[concat(&#x27;Microsoft.ApiManagement/service/&#x27;, variables(&#x27;apiManagementServiceName&#x27;))]&quot;</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">&quot;properties&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;displayName&quot;</span>: <span class="string">&quot;Example Group Name&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;description&quot;</span>: <span class="string">&quot;Example group description&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;resources&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">&quot;apiVersion&quot;</span>: <span class="string">&quot;2017-03-01&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;users&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;exampleUser3&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;dependsOn&quot;</span>: [</span><br><span class="line">                <span class="string">&quot;[concat(&#x27;Microsoft.ApiManagement/service/&#x27;, variables(&#x27;apiManagementServiceName&#x27;))]&quot;</span>,</span><br><span class="line">                <span class="string">&quot;[concat(&#x27;Microsoft.ApiManagement/service/&#x27;, variables(&#x27;apiManagementServiceName&#x27;), &#x27;/groups/exampleGroup&#x27;)]&quot;</span></span><br><span class="line">            ]</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Subscription"><a href="#Subscription" class="headerlink" title="Subscription"></a>Subscription</h3><p>To create a subscription for a user.</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;apiVersion&quot;</span>: <span class="string">&quot;2017-03-01&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;subscriptions&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;examplesubscription1&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;dependsOn&quot;</span>: [</span><br><span class="line">        <span class="string">&quot;[concat(&#x27;Microsoft.ApiManagement/service/&#x27;, variables(&#x27;apiManagementServiceName&#x27;))]&quot;</span>,</span><br><span class="line">        <span class="string">&quot;[concat(&#x27;Microsoft.ApiManagement/service/&#x27;, variables(&#x27;apiManagementServiceName&#x27;), &#x27;/products/exampleProduct&#x27;)]&quot;</span>,</span><br><span class="line">        <span class="string">&quot;[concat(&#x27;Microsoft.ApiManagement/service/&#x27;, variables(&#x27;apiManagementServiceName&#x27;), &#x27;/users/exampleUser1&#x27;)]&quot;</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">&quot;properties&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;productId&quot;</span>: <span class="string">&quot;/subscriptions/&#123;subscriptionId&#125;/resourceGroups/&#123;resourceGroupName&#125;/providers/Microsoft.ApiManagement/service/exampleServiceName/products/exampleProduct&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;userId&quot;</span>: <span class="string">&quot;/subscriptions/&#123;subscriptionId&#125;/resourceGroups/&#123;resourceGroupName&#125;/providers/Microsoft.ApiManagement/service/exampleServiceName/users/exampleUser1&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Named-values"><a href="#Named-values" class="headerlink" title="Named values"></a>Named values</h3><p>Add named values, often used in policies as variables.</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;apiVersion&quot;</span>: <span class="string">&quot;2017-03-01&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;properties&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;exampleproperties&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;dependsOn&quot;</span>: [</span><br><span class="line">        <span class="string">&quot;[concat(&#x27;Microsoft.ApiManagement/service/&#x27;, variables(&#x27;apiManagementServiceName&#x27;))]&quot;</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">&quot;properties&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;displayName&quot;</span>: <span class="string">&quot;propertyExampleName&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;value&quot;</span>: <span class="string">&quot;propertyExampleValue&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;tags&quot;</span>: [</span><br><span class="line">            <span class="string">&quot;exampleTag&quot;</span></span><br><span class="line">        ]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Certificate"><a href="#Certificate" class="headerlink" title="Certificate"></a>Certificate</h3><p>To create a certificate.</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;apiVersion&quot;</span>: <span class="string">&quot;2017-03-01&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;certificates&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;exampleCertificate&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;dependsOn&quot;</span>: [</span><br><span class="line">        <span class="string">&quot;[concat(&#x27;Microsoft.ApiManagement/service/&#x27;, variables(&#x27;apiManagementServiceName&#x27;))]&quot;</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">&quot;properties&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;data&quot;</span>: <span class="string">&quot;[parameters(&#x27;mutualAuthenticationCertificate&#x27;)]&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;password&quot;</span>: <span class="string">&quot;[parameters(&#x27;certificatePassword&#x27;)]&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="OpenId-Connect"><a href="#OpenId-Connect" class="headerlink" title="OpenId Connect"></a>OpenId Connect</h4><p>For OpenId integration.</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;apiVersion&quot;</span>: <span class="string">&quot;2017-03-01&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;openidConnectProviders&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;exampleOpenIdConnectProvider&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;dependsOn&quot;</span>: [</span><br><span class="line">        <span class="string">&quot;[concat(&#x27;Microsoft.ApiManagement/service/&#x27;, variables(&#x27;apiManagementServiceName&#x27;))]&quot;</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">&quot;properties&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;displayName&quot;</span>: <span class="string">&quot;exampleOpenIdConnectProviderName&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;description&quot;</span>: <span class="string">&quot;Description for example OpenId Connect provider&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;metadataEndpoint&quot;</span>: <span class="string">&quot;https://example-openIdConnect-url.net&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;clientId&quot;</span>: <span class="string">&quot;exampleClientId&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;clientSecret&quot;</span>: <span class="string">&quot;[parameters(&#x27;openIdConnectClientSecret&#x27;)]&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Identity-providers"><a href="#Identity-providers" class="headerlink" title="Identity providers"></a>Identity providers</h4><p>You can add multiple identity providers. The following providers are available.</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">&quot;facebook&quot;</span>,</span><br><span class="line"><span class="string">&quot;google&quot;</span>,</span><br><span class="line"><span class="string">&quot;microsoft&quot;</span>,</span><br><span class="line"><span class="string">&quot;twitter&quot;</span>,</span><br><span class="line"><span class="string">&quot;aad&quot;</span>,</span><br><span class="line"><span class="string">&quot;aadB2C&quot;</span>]</span><br></pre></td></tr></table></figure>

<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;apiVersion&quot;</span>: <span class="string">&quot;2017-03-01&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;identityProviders&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;google&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;dependsOn&quot;</span>: [</span><br><span class="line">        <span class="string">&quot;[concat(&#x27;Microsoft.ApiManagement/service/&#x27;, variables(&#x27;apiManagementServiceName&#x27;))]&quot;</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">&quot;properties&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;clientId&quot;</span>: <span class="string">&quot;googleClientId&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;clientSecret&quot;</span>: <span class="string">&quot;[parameters(&#x27;googleClientSecret&#x27;)]&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Logger"><a href="#Logger" class="headerlink" title="Logger"></a>Logger</h3><p>You can use either <code>EventHub</code> or <code>Application Insights</code> as a Logging framework.<br>The difference is in the credentials.</p>
<h4 id="Eventhub"><a href="#Eventhub" class="headerlink" title="Eventhub"></a>Eventhub</h4><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;apiVersion&quot;</span>: <span class="string">&quot;2017-03-01&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;loggers&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;exampleLogger&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;dependsOn&quot;</span>: [</span><br><span class="line">        <span class="string">&quot;[concat(&#x27;Microsoft.ApiManagement/service/&#x27;, variables(&#x27;apiManagementServiceName&#x27;))]&quot;</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">&quot;properties&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;loggerType&quot;</span>: <span class="string">&quot;azureEventHub&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;description&quot;</span>: <span class="string">&quot;Description for example logger&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;credentials&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;exampleEventHubName&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;connectionString&quot;</span>: <span class="string">&quot;[parameters(&#x27;eventHubNamespaceConnectionString&#x27;)]&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Application-Insights"><a href="#Application-Insights" class="headerlink" title="Application Insights"></a>Application Insights</h4><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;apiVersion&quot;</span>: <span class="string">&quot;2017-03-01&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;loggers&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;exampleLogger&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;dependsOn&quot;</span>: [</span><br><span class="line">        <span class="string">&quot;[concat(&#x27;Microsoft.ApiManagement/service/&#x27;, variables(&#x27;apiManagementServiceName&#x27;))]&quot;</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">&quot;properties&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;loggerType&quot;</span>: <span class="string">&quot;applicationInsights&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;description&quot;</span>: <span class="string">&quot;Description for example logger&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;credentials&quot;</span>: <span class="string">&quot;3e2e9837-b17b-44b3-a652-ed296080c57d&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><p><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/azure/templates/microsoft.apimanagement/2018-01-01/service">Microsoft ARM Docs</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://dibranmulder.github.io/2018/12/19/Azure-API-Management-ARM-Cheatsheet/" data-id="ckfdlvwxc0008fk49ebt6bsnn" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/API-Management/" rel="tag">API Management</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Azure/" rel="tag">Azure</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Azure-Api-Management-overview" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/11/13/Azure-Api-Management-overview/" class="article-date">
  <time datetime="2018-11-13T15:43:45.000Z" itemprop="datePublished">2018-11-13</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/11/13/Azure-Api-Management-overview/">Azure API  Management overview</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Azure API Management is a jungle of configurations, options and possibilities. The documentation is not always that clear and sometimes its hard to see what your options are and which suit your solution best. In this blogpost I’m trying to shine some light into that darkness.</p>
<h2 id="Terminology"><a href="#Terminology" class="headerlink" title="Terminology"></a>Terminology</h2><p>Lest started with some very basics. API Management(from now on APIM, cauz im lazy) is a service sitting in the middle of a consuming client application and a backend service. Its there for reasons, such as: enforcing policies, caching, routing, security and so on. Its often used as a central hub within a company to manage outgoing and incomming traffic. Its main goal is to retrain control over your API’s.</p>
<img src="/images/apim/apim basic.png" />

<ul>
<li>The consuming client applications are called: Client or front-end application.</li>
<li>The incomming traffic from a client application is call inbound traffic.</li>
<li>Your API which you are disclosing via APIM is called the backend service or api.</li>
<li>The response from the backend service is called outbound traffic.</li>
</ul>
<img src="/images/apim/apim basic flow.png" />

<h3 id="Products-and-groups"><a href="#Products-and-groups" class="headerlink" title="Products and groups"></a>Products and groups</h3><p>Next up APIM got some features and data structures which you need to be familiar with. It all starts with products and groups. A product essentially is a set of API’s. For a client application to be effective it might have to consult several backend api’s to get all data. Especially when you are using a microservice based architecture. A product then might be a combination of multiple backend api’s. Its important to keep in mind that a set of backend API’s should look like one product from a client application perspective. Once you’ve defined a set of API’s for a product you’ll have to grant groups of users to a product. APIM also contains a build in group called ‘Guests’ which once allowed access to a product opens up your API’s in your product for everyone. </p>
<h3 id="Subscriptions"><a href="#Subscriptions" class="headerlink" title="Subscriptions"></a>Subscriptions</h3><p>You can also choose to enable subscriptions for a product. Once enabled users have to request a subscription and they obtain a set of keys. Those keys should be added to every call to APIM so that APIM can validate if your subscription is still valid.</p>
<h3 id="Policies"><a href="#Policies" class="headerlink" title="Policies"></a>Policies</h3><p>Lastly a product can also contain policies. Later you’ll see that you can also define policies on API or even on operation level. Policies applied on product level apply on every API inside the product. Its a hierachial system for defining policies.</p>
<h2 id="Add-API’s"><a href="#Add-API’s" class="headerlink" title="Add API’s"></a>Add API’s</h2><img src="/images/apim/addapi.png" />
You can add API's in various ways. With a blank API's you'll have to define every thing youself. Its doesn't bootstrap any operations or whatsoever. Other options do bootstrap your API's inside APIM. OpenAPI spefications for instance delivery detailed operations and improve efficiency and usability. OpenAPI definitions were previously called Swagger definitions. 

<p>Its also possibile to integrate with a Function App in Api Management. As discussed in <a href="2018/10/19/Building-Serverless-APIs-in-Azure/">this post</a> an API Gateway is recommended when you’re creating a Serverless API or when you’re using a Microservice based architecture. Be aware that OpenAPI definitons inside Azure Functions V2 are still in preview and therefore the bootstrapped operations lack some detail.</p>
<p>In the next blogpost I’ll address the CI/CD posibilities in combination with APIM. In my opinion its indispensable for a DevOps team, let alone a whole company using the same APIM instance.</p>
<h2 id="Security"><a href="#Security" class="headerlink" title="Security"></a>Security</h2><img src="/images/apim/apim.png" />

<h3 id="Client-Authentication"><a href="#Client-Authentication" class="headerlink" title="Client Authentication"></a>Client Authentication</h3><p>OpenId<br>OAuth<br>Subscription Keys</p>
<h3 id="Backend-service"><a href="#Backend-service" class="headerlink" title="Backend service"></a>Backend service</h3><p>Function keys<br>Basic Auth<br>Client certificates</p>
<img src="/images/apim/functions keys.png" />

<h2 id="Policies-1"><a href="#Policies-1" class="headerlink" title="Policies"></a>Policies</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">policies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">inbound</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">base</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">inbound</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">backend</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">base</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">backend</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">outbound</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">base</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">outbound</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">on-error</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">base</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">on-error</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">policies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="Categories"><a href="#Categories" class="headerlink" title="Categories"></a>Categories</h3><ul>
<li>Restriction</li>
<li>Advanced</li>
<li>Authentication</li>
<li>Caching</li>
<li>Cross domain policies (CORS)</li>
<li>Transformation </li>
</ul>
<p><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/azure/api-management/api-management-policies">https://docs.microsoft.com/en-us/azure/api-management/api-management-policies</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://dibranmulder.github.io/2018/11/13/Azure-Api-Management-overview/" data-id="ckfdlvwxd0009fk49a7h8gide" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/API-Management/" rel="tag">API Management</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Azure/" rel="tag">Azure</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Secrets-in-Azure-DevOps-the-bad-parts" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/10/25/Secrets-in-Azure-DevOps-the-bad-parts/" class="article-date">
  <time datetime="2018-10-25T10:30:57.000Z" itemprop="datePublished">2018-10-25</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/10/25/Secrets-in-Azure-DevOps-the-bad-parts/">Secrets in Azure DevOps the bad parts</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Storing secrets inside your build and release pipeline variables is a bad practise and Microsoft advises not to use it, but use KeyVault instead. However fact is, is that its also very convenient and easy to use, so people are going to use it alot. But what are the risks of using this? Are your secrets save?</p>
<h2 id="Decrypting-secrets"><a href="#Decrypting-secrets" class="headerlink" title="Decrypting secrets"></a>Decrypting secrets</h2><p>May 17th of 2018 FoxIt published <a target="_blank" rel="noopener" href="https://www.fox-it.com/en/insights/blogs/blog/introducing-team-foundation-server-decryption-tool/">a tool</a> to decrypt secrets from the TFS/VSTS and now AzureDevops variable stores. This tool on itself is a huge risk from a compliance and security perspective.</p>
<p>Imagine you store connection strings or passwords inside the variables store and they provide access to your production databases. Malicious developers are now able to retrieve those secrets and do their harm. Without any trace. Since you are not able to get a trace log from Azure DevOps. A better way the prevent variables to be decrypted is the read them from KeyVault. </p>
<img src="/images/secrets.png" />

<h2 id="Secrets-in-ARM-scripts"><a href="#Secrets-in-ARM-scripts" class="headerlink" title="Secrets in ARM scripts"></a>Secrets in ARM scripts</h2><p>Another risk with using secrets inside ARM scripts is the risk of exposing variables without knowing it. ARM parameters are often strings, for example: usernames, password, connection strings, etc. Those strings might come from trusted sources maybe even a KeyVault. One mistake thats often made is that those parameters are of type string. See the example below, these are the parameters for a basic WebApp ARM Script. In this WebApp we want to access a database and we want to have the connection string to that database as a parameter.</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;parameters&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;webAppName&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;string&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;metadata&quot;</span>: &#123;</span><br><span class="line">                <span class="attr">&quot;description&quot;</span>: <span class="string">&quot;Base name of the resource such as web app name and app service plan &quot;</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">&quot;minLength&quot;</span>: <span class="number">2</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">&quot;sku&quot;</span>:&#123;</span><br><span class="line">            <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;string&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;defaultValue&quot;</span> : <span class="string">&quot;S1&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;metadata&quot;</span>: &#123;</span><br><span class="line">                <span class="attr">&quot;description&quot;</span>: <span class="string">&quot;The SKU of App Service Plan, by defaut is standard  S1&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">&quot;location&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;string&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;defaultValue&quot;</span>: <span class="string">&quot;[resourceGroup().location]&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;metadata&quot;</span>: &#123;</span><br><span class="line">                <span class="attr">&quot;description&quot;</span>: <span class="string">&quot;Location for all resources.&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">&quot;databaseConnectionString&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;string&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;defaultValue&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;metadata&quot;</span>: &#123;</span><br><span class="line">                <span class="attr">&quot;description&quot;</span>: <span class="string">&quot;The connection string to the database.&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>What a lot of people don’t know is that you can look into the deployments of a Resource Group. Simply go to <code>Resource groups</code> &gt; <code>Deployments</code> and select one. If a parameter is not marked as type: <code>securestring</code> then it will be shown in plain text. The bad part of this experience is that you require very few rights to look into the deployments of a resource group. Read rights are enough. You are for instance prohibited to look into the app settings or connection strings of a WebApp but you are often allowed to look into this deployments.</p>
<p>The correct parameter type should be the following:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;parameters&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;databaseConnectionString&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;securestring&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;defaultValue&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;metadata&quot;</span>: &#123;</span><br><span class="line">                <span class="attr">&quot;description&quot;</span>: <span class="string">&quot;The connection string to the database.&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
      
    </div>
    <footer class="article-footer">
      <a data-url="https://dibranmulder.github.io/2018/10/25/Secrets-in-Azure-DevOps-the-bad-parts/" data-id="ckfdlvwxr000ofk4963miajn0" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Azure-DevOps/" rel="tag">Azure DevOps</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Security/" rel="tag">Security</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Building-Serverless-APIs-in-Azure" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/10/19/Building-Serverless-APIs-in-Azure/" class="article-date">
  <time datetime="2018-10-19T13:44:40.000Z" itemprop="datePublished">2018-10-19</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/10/19/Building-Serverless-APIs-in-Azure/">Building Serverless API&#39;s in Azure</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Serverless is a hot topic in Cloud Development. Serverless cloud computing is all about scalability, performance, minimizing cost and maximizing business value by eliminating complexity. Its a true game changer but is it always the best approach for your software? In this blogpost I’ll address the pros and cons regarding Serverless API’s.</p>
<h2 id="REST-API’s"><a href="#REST-API’s" class="headerlink" title="REST API’s"></a>REST API’s</h2><p>We’ve been building API’s for decades, with techniques like RCP, SOAP, Enterprise Service Buses, etc. The majority of the people nowadays build their API’s based on a REST or RESTful architecture. How does this trend match the new serverless hype that’s taking place? In this blogpost we are trying to find that out. </p>
<p>I’ll assume that you know what REST is but in case you don’t. It’s based on the following principles: </p>
<blockquote>
<p>performance, scalability, simplicity, modifiability, visibility, portability, and reliability</p>
</blockquote>
<p>In order for an architecture to achieve those goals, REST has the following constraints:</p>
<blockquote>
<p>Client-Server Architecture, Statelessness, Cachability, Layered system, Code on demand and Uniform Interface. </p>
</blockquote>
<p>More information about the constraints and principles can be found <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Representational_state_transfer">here</a></p>
<p>So, at first sight, it doesn’t really look that Serverless computing and REST are in conflict. Moreover, Serverless computing might be complementary to REST. Let’s have a closer look.</p>
<h2 id="Serverless"><a href="#Serverless" class="headerlink" title="Serverless"></a>Serverless</h2><p>According to Martin Fowler’s blog this is the definition of Serverless:</p>
<blockquote>
<p>Serverless can also mean applications where server-side logic is still written by the application developer, but, unlike traditional architectures, it’s run in stateless compute containers that are event-triggered, ephemeral (may only last for one invocation), and fully managed by a third party. One way to think of this is “Functions as a Service” or “FaaS”.</p>
</blockquote>
<p><a target="_blank" rel="noopener" href="https://martinfowler.com/articles/serverless.html">Source from Martin Fowler</a></p>
<p>So the key takeaways are: event triggered, ephemeral and fully managed by a third party. So those Functions are serverside logic, triggered by events. In a REST based scenario that trigger might be an Http call, representing a REST operation. So far so good.</p>
<img src="/images/serverless/Serverless API.png" />

<p>So, we might end up building Azure Functions for every REST operation. The client application then has to orchestrate the REST calls to the right functions. This might be done via naming conventions, a pattern which is common in REST based architectures. If you are questioning if this is really a good idea, hold that thought! I’ll come back to it.</p>
<p>Calling Azure Functions directly from your Client feels like a bad idea. Azure Functions should be those little snippets of code just executing at crazy scale and they should perform really well. On the other hand, we want to have an API with all kinds of additional features, we need those features to have an effective and future proof communication with our clients. I’m talking about:</p>
<ul>
<li>SSL termination</li>
<li>Authentication</li>
<li>IP whitelisting</li>
<li>Client rate limiting (throttling)</li>
<li>Logging and monitoring</li>
<li>Response caching</li>
<li>Web application firewall</li>
<li>GZIP compression</li>
<li>Servicing static content</li>
<li>Restfull routing</li>
<li>Versioning</li>
<li>Health checking</li>
<li>Documentation</li>
</ul>
<p>These features and Functions don’t fit really well. If we end up adding all those features to our Azure Functions we should just have picked ASP.net core and we could have built that API way faster than we would have in Azure Functions. So how do we bring those features in play while keeping our Azure Functions lean and mean. Well we need some sort of Application Gateway. A service sitting in the middle of the client and our Azure Functions which takes care of most of the features above. This Application Gateway should scale very good and shouldn’t introduce a new bottle neck. Think of it as an Load Balancer.</p>
<img src="/images/serverless/Serverless.png" />

<h2 id="Azure-API-Gateway"><a href="#Azure-API-Gateway" class="headerlink" title="Azure API Gateway"></a>Azure API Gateway</h2><p>Azure offers a set of services which have the possibility to route traffic, cache and so on. However most of them are not a good fit to act as an API Gateway. </p>
<p>The following services are just for routing traffic on different levels but don’t implement documentation, logging, analytics, caching and so on:</p>
<ul>
<li>Azure Traffic manager<br>DNS based (global) load balancer and fail-over solution</li>
<li>Azure Application Gateway<br>HTTP/HTTPS based redirect + SSL offload + Web Application Firewall (OWASP) solution </li>
<li>Azure Load Balancer<br>Generic (port based) load balancer -&gt; often used for IaaS VM’s</li>
</ul>
<h2 id="Azure-API-Management"><a href="#Azure-API-Management" class="headerlink" title="Azure API Management"></a>Azure API Management</h2><p>The only service which is an actual API Gateway implementation is Azure API management. It includes caching, routing, security, documentation, logging and so on. It’s a comprehensive suite of features, and I’m planning to write a bunch of blog posts about it. So, stay tuned.</p>
<p>One thing to consider is the pricing of Azure API management. It’s quite expensive with a start rate of about 670 dollars. If you want to do Global API management or VNET integration you will have to pick the Premium tier, which comes at 2700 dollar a month. So the key take away is that if you want to build a REST API on Functions you might have to give in some features or pay a little extra.</p>
<img src="/images/serverless/costs.png" />

<p>A best practice is to share the API management instance across a company. In this way you can manage all outbound API’s from one service. Also you are managing all clients inside one service, offboarding clients is way easier this way.</p>
<img src="/images/serverless/announcement.png" />
[Link to the Video](https://www.youtube.com/watch?v=BoZimCedfq8&t=39m58s)

<p>On Ignite 2018, Microsoft announced an API Management Consumption based tier. This tier should be optimized to handle Serverless scenarios. So basically Microsoft confirms the need for API Gateway when building Serverless architectures.</p>
<p>This consumption tier is now in private preview, hopefully it will be in public preview and later GA very soon. In the near future I will write some blog posts on:</p>
<ul>
<li>How to configure an API management instance via ARM and Azure DevOps</li>
<li>How to add Azure Functions to API management via Azure DevOps.</li>
<li>Building REST API’s on Azure Functions. Including features like:<ul>
<li>Dependency injection</li>
<li>Response caching</li>
<li>Authentication</li>
</ul>
</li>
</ul>
<p>Stay tuned and happy coding.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://dibranmulder.github.io/2018/10/19/Building-Serverless-APIs-in-Azure/" data-id="ckfdlvwxl000hfk498npdb723" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/API-Gateway/" rel="tag">API Gateway</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/API-management/" rel="tag">API management</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Azure/" rel="tag">Azure</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Functions/" rel="tag">Functions</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Azure-AD-Managed-Service-Identity" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/10/05/Azure-AD-Managed-Service-Identity/" class="article-date">
  <time datetime="2018-10-05T15:09:54.000Z" itemprop="datePublished">2018-10-05</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/10/05/Azure-AD-Managed-Service-Identity/">Azure AD Managed Service Identity</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="What-is-Azure-AD-Managed-Service-Identity-MSI"><a href="#What-is-Azure-AD-Managed-Service-Identity-MSI" class="headerlink" title="What is Azure AD Managed Service Identity (MSI)"></a>What is Azure AD Managed Service Identity (MSI)</h1><p>Azure AD MSI is an Azure feature, which allows Identity managed access to Azure resources. This improves security, by reducing the need for applications, to have credentials in code, configurations. It creates an identity, which is linked to an Azure resource. The identity can then be granted access to Azure resources. This allows for access management on identity level, and one of the advantages, that the Identity management itself is done by Azure.</p>
<p>​”A common challenge when building cloud applications is how to manage the credentials that need to be in your code for authenticating to cloud services. Keeping these credentials secure is an important task. Ideally, they never appear on developer workstations or get checked into source control. Azure Key Vault provides a way to securely store credentials and other keys and secrets, but your code needs to authenticate to Key Vault to retrieve them. Managed Service Identity (MSI) makes solving this problem simpler by giving Azure services an automatically managed identity in Azure Active Directory (Azure AD). You can use this identity to authenticate to any service that supports Azure AD authentication, including Key Vault, without having any credentials in your code.</p>
<p>​Managed Service Identity comes with Azure Active Directory free, which is the default for Azure subscriptions. There is no additional cost for Managed Service Identity.”</p>
<p>(from: <a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/azure/active-directory/managed-service-identity/overview">Azure AD Intro</a>)</p>
<h2 id="Azure-AD-MSI-Setup-options"><a href="#Azure-AD-MSI-Setup-options" class="headerlink" title="Azure AD MSI Setup options"></a>Azure AD MSI Setup options</h2><p>There are several options to setup MSI, this article will give an impression how to setup AD MSI using the Azure Portal.</p>
<h3 id="Azure-Portal"><a href="#Azure-Portal" class="headerlink" title="Azure Portal"></a>Azure Portal</h3><p>The most easiest method is to use the Azure Portal. This provides an intuitive way, and shows which features are supported. The suggested approach, is to setup features in the Azure portal to have a good idea on the desired setup, and then use the <a target="_blank" rel="noopener" href="https://azure.microsoft.com/nl-nl/blog/azure-resource-explorer-a-new-tool-to-discover-the-azure-api/">Azure resource explorer</a> to define the arm script.</p>
<h3 id="​ARM"><a href="#​ARM" class="headerlink" title="​ARM"></a>​ARM</h3><p>Setting up the AD MSI with ARM is possible, at the moment there are some PowerShell scripts required to set up an VSTS pipeline. One thing to keep in mind, is that a new Azure Identity will be created, so the difficult part of the ARM template, is linking an existing users and grant them permissions.  </p>
<h3 id="PowerShell-Azure-CLI"><a href="#PowerShell-Azure-CLI" class="headerlink" title="PowerShell / Azure CLI"></a>PowerShell / Azure CLI</h3><p>As with all Azure features, it’s possible to use PowerShell and the Azure CLI to setup the MSI. One important aspect of this feature, is that it’s managed in Azure, which means local debugging becomes complex. To resolve this, it’s possible to use the Azure CLI to is the easiest way to perform local debugging (see <a target="_blank" rel="noopener" href="https://rahulpnath.com/blog/authenticating-with-azure-key-vault-using-managed-service-identity/">this article</a>).​</p>
<h3 id="Walkthrough-enable-Azure-AD-MSI-for-existing-functions"><a href="#Walkthrough-enable-Azure-AD-MSI-for-existing-functions" class="headerlink" title="Walkthrough - enable Azure AD MSI for existing functions"></a>Walkthrough - enable Azure AD MSI for existing functions</h3><h1 id="Objective"><a href="#Objective" class="headerlink" title="Objective"></a>Objective</h1><p>In this walkthrough, we enable Azure AD MSI for an existing Azure Function The function retrieves a secret from Azure KeyVault. In the initial implementation</p>
<p>the function had to retrieve the KeyVault Id &amp; secret in the configuration file. </p>
<h4 id="CONFIG-FILE"><a href="#CONFIG-FILE" class="headerlink" title="CONFIG FILE"></a>CONFIG FILE</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- ClientId and ClientSecret refer to the web application registration with Azure Active Directory --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">add</span> <span class="attr">key</span>=<span class="string">&quot;ClientId&quot;</span> <span class="attr">value</span>=<span class="string">&quot;clientid&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">add</span> <span class="attr">key</span>=<span class="string">&quot;ClientSecret&quot;</span> <span class="attr">value</span>=<span class="string">&quot;clientsecret&quot;</span> /&gt;</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">&lt;!-- SecretUri is the URI for the secret in Azure Key Vault --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">add</span> <span class="attr">key</span>=<span class="string">&quot;SecretUri&quot;</span> <span class="attr">value</span>=<span class="string">&quot;secreturi&quot;</span> /&gt;</span>​</span><br></pre></td></tr></table></figure>

<h4 id="CODE-TO-ACCESS-TOKEN"><a href="#CODE-TO-ACCESS-TOKEN" class="headerlink" title="CODE TO ACCESS TOKEN"></a>CODE TO ACCESS TOKEN</h4><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//the method that will be provided to the KeyVaultClient</span></span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">async</span> Task&lt;<span class="keyword">string</span>&gt; <span class="title">GetToken</span>(<span class="params"><span class="keyword">string</span> authority, <span class="keyword">string</span> resource, <span class="keyword">string</span> scope</span>) </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">var</span> authContext = <span class="keyword">new</span> AuthenticationContext(authority);</span><br><span class="line">    ClientCredential clientCred = <span class="keyword">new</span> ClientCredential(GetSetting(<span class="string">&quot;ClientId&quot;</span>), (GetSetting(<span class="string">&quot;ClientSecret&quot;</span>));</span><br><span class="line">    AuthenticationResult result = <span class="keyword">await</span> authContext.AcquireTokenAsync(resource, clientCred);</span><br><span class="line">    <span class="keyword">if</span> (result == <span class="literal">null</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> InvalidOperationException(<span class="string">&quot;Failed to obtain the JWT token&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> result.AccessToken;</span><br><span class="line">&#125;&#125;​</span><br></pre></td></tr></table></figure>

<h4 id="CODE-TO-RETRIEVE-THE-SECRET"><a href="#CODE-TO-RETRIEVE-THE-SECRET" class="headerlink" title="CODE TO RETRIEVE THE SECRET"></a>CODE TO RETRIEVE THE SECRET</h4><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> kv = <span class="keyword">new</span> KeyVaultClient(<span class="keyword">new</span> KeyVaultClient.AuthenticationCallback(Utils.GetToken));</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> sec = <span class="keyword">await</span> kv.GetSecretAsync(WebConfigurationManager.AppSettings[<span class="string">&quot;SecretUri&quot;</span>]);</span><br></pre></td></tr></table></figure>

<p>The problem with the code shown above is;</p>
<ol>
<li>Any change in the KeyVault security resulted in downtime in the function</li>
<li>It was not clear who was able to access the KeyVault</li>
</ol>
<h3 id="Why-AD-MSI"><a href="#Why-AD-MSI" class="headerlink" title="Why AD MSI?"></a>Why AD MSI?</h3><p>With the new approach, we will make sure that only the function is able to access the KeyVault. By enabling Azure AD MSI, one the advantages, is that we do this using an Identity linked to the Azure function. In the new workflow, the Azure function has no need for any configuration, thus the function is more secure, and all the management of access, is done in the KeyVault. </p>
<img src="/images/msi/overview.png" />

<h3 id="Azure-Function-Enable-AD-MSI"><a href="#Azure-Function-Enable-AD-MSI" class="headerlink" title="Azure Function - Enable AD MSI"></a>Azure Function - Enable AD MSI</h3><p>Within our Azure function, we navigate to platform features, and click on ‘​​Managed Service Identity’ (note that this is also supported in several other Azure services such as WebApps). </p>
<img src="/images/msi/capture.png" />

<p>We can enable the feature, which will create an Azure Identity </p>
<img src="/images/msi/enable.png" />

<p>This has created an Identity, recognizable by the name of the function we created.</p>
<p>We now have completed the first step, 2 things needs to be done:</p>
<ol>
<li>Manage access for the identity</li>
<li>Update the Code in the function</li>
</ol>
<h3 id="Key-Vault-Access"><a href="#Key-Vault-Access" class="headerlink" title="Key Vault Access"></a>Key Vault Access</h3><p>The CCC provides a Blueprint and service to create a KeyVault, in summary, it allows for storage of secrets/certificates (with renewal procedures), and is highly recommended to store confidential data in (see: Architecture Blueprint Azure Key Vault.docx). We will assume a KeyVault is already available, and will configure the identity;</p>
<ol>
<li>We click on Access Control (IAM)</li>
<li>Click Add<br>a. Choose the role ‘Reader’<br>b. Select ‘Function App’, in the dropdown ‘Assign Rights’ (note that we have several types available)</li>
</ol>
<img src="/images/msi/assignIdentity.png" />

<p>  c. Choose the appropiate subscription<br>  d. Choose the appropiate resource group<br>  e. Select the Identity<br>  f. Click save</p>
<p>What have we done? We now have granted the function to access the Key Vault, with the specified Identity. Any decision to revoke access, change permissions, can now be defined in the Key Vault resource itself.</p>
<p>Our sample secret within the Key Vault;</p>
<img src="/images/msi/secret.png" style="height: 500px;" />

<h3 id="Azure-Function-Code-Change"><a href="#Azure-Function-Code-Change" class="headerlink" title="Azure Function - Code Change"></a>Azure Function - Code Change</h3><p>We have now ensured that the function can retrieve data ​from the KeyVault without requiring a configuration. We now need to make the following changes</p>
<ol>
<li>Remove the configuration for SecretKey-Value, so that we only have the URI configured;</li>
</ol>
<h4 id="CONFIG-FILE-1"><a href="#CONFIG-FILE-1" class="headerlink" title="CONFIG FILE"></a>CONFIG FILE</h4><pre><code>&lt;!-- SecretUri is the URI for the secret in Azure Key Vault --&gt;
&lt;add key=&quot;SecretUri&quot; value=&quot;secreturi&quot; /&gt;​</code></pre>
<h4 id="CODE-TO-ACCESS-TOKEN-1"><a href="#CODE-TO-ACCESS-TOKEN-1" class="headerlink" title="CODE TO ACCESS TOKEN"></a>CODE TO ACCESS TOKEN</h4><p>Obsolete!</p>
<h4 id="CODE-TO-RETRIEVE-THE-SECRET-1"><a href="#CODE-TO-RETRIEVE-THE-SECRET-1" class="headerlink" title="CODE TO RETRIEVE THE SECRET"></a>CODE TO RETRIEVE THE SECRET</h4><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> azureServiceTokenProvider = <span class="keyword">new</span> AzureServiceTokenProvider();​</span><br><span class="line"><span class="keyword">var</span> kvClient = <span class="keyword">new</span> KeyVaultClient(<span class="keyword">new</span> KeyVaultClient.AuthenticationCallback(azureServiceTokenProvider.KeyVaultTokenCallback));</span><br><span class="line"><span class="keyword">var</span> result = <span class="keyword">await</span> kvClient.GetSecretAsync(GetSetting(<span class="string">&quot;SecretUri&quot;</span>));</span><br><span class="line">log.Info(result.Value);</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>Output from the function</p>
<img src="/images/msi/demo.png" />

<h3 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a>Summary</h3><p>As shown in this simple example, it’s quite easy to enable Azure AD MSI for your application. Using Azure AD MSI, results in a lot of benefits. Besides manually configuring this, it’s also possible to set this up using ARM scripts, VSTS, with the following article​​</p>
<h3 id="Resources"><a href="#Resources" class="headerlink" title="Resources"></a>Resources</h3><h4 id="Intro"><a href="#Intro" class="headerlink" title="Intro"></a>Intro</h4><p><a target="_blank" rel="noopener" href="https://azure.microsoft.com/nl-nl/blog/keep-credentials-out-of-code-introducing-azure-ad-managed-service-identity/">https://azure.microsoft.com/nl-nl/blog/keep-credentials-out-of-code-introducing-azure-ad-managed-service-identity/</a></p>
<h4 id="Supported-Azure-services"><a href="#Supported-Azure-services" class="headerlink" title="Supported Azure services"></a>Supported Azure services</h4><p><a target="_blank" rel="noopener" href="https://docs.microsoft.com/nl-nl/azure/active-directory/managed-service-identity/overview">https://docs.microsoft.com/nl-nl/azure/active-directory/managed-service-identity/overview</a></p>
<h4 id="Web-Application-accessing-a-KeyVault-using-Azure-AD-MSI"><a href="#Web-Application-accessing-a-KeyVault-using-Azure-AD-MSI" class="headerlink" title="Web Application accessing a KeyVault using Azure AD MSI"></a>Web Application accessing a KeyVault using Azure AD MSI</h4><p><a target="_blank" rel="noopener" href="https://docs.microsoft.com/nl-nl/azure/key-vault/key-vault-use-from-web-application">https://docs.microsoft.com/nl-nl/azure/key-vault/key-vault-use-from-web-application</a></p>
<h4 id="VSTS-and-MSI"><a href="#VSTS-and-MSI" class="headerlink" title="VSTS and MSI"></a>VSTS and MSI</h4><p><a target="_blank" rel="noopener" href="https://blogs.msdn.microsoft.com/azuredev/2017/10/15/devops-using-azure-msi-with-vsts-step-by-step/">https://blogs.msdn.microsoft.com/azuredev/2017/10/15/devops-using-azure-msi-with-vsts-step-by-step/</a></p>
<h4 id="Debugging-a-function-locally-with-Azure-AD-MSI"><a href="#Debugging-a-function-locally-with-Azure-AD-MSI" class="headerlink" title="Debugging a function locally with Azure AD MSI"></a>Debugging a function locally with Azure AD MSI</h4><p><a target="_blank" rel="noopener" href="https://rahulpnath.com/blog/authenticating-with-azure-key-vault-using-managed-service-identity/">https://rahulpnath.com/blog/authenticating-with-azure-key-vault-using-managed-service-identity/</a><br>​</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://dibranmulder.github.io/2018/10/05/Azure-AD-Managed-Service-Identity/" data-id="ckfdlvwxb0007fk49dhfma48w" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/AD/" rel="tag">AD</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Azure/" rel="tag">Azure</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/MSI/" rel="tag">MSI</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Azure-functions-V2-with-EF-Core" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/08/23/Azure-functions-V2-with-EF-Core/" class="article-date">
  <time datetime="2018-08-23T13:48:30.000Z" itemprop="datePublished">2018-08-23</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/08/23/Azure-functions-V2-with-EF-Core/">Azure functions V2 with EF Core</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Last week I was trying to build an API on top of Azure Functions with a backing SQL database. This sounds like a pretty easy task however that was not the case, here’s my story.</p>
<p>Normally when I use a SQL database in a WebApp, and therefore this also applies to Functions, I use an ORM mapper. I’m pretty familiar with Entity Framework so that’s what I tried. You might think why don’t you use <a href="(https://docs.microsoft.com/en-us/azure/azure-functions/functions-triggers-bindings">Triggers and Bindings</a> to connect with your SQL database? Well SQL bindings and triggers aren’t supported yet.</p>
<p>If you want to use Entity Framework inside Azure Functions V2 then you would have to use Entity Framework Core (EF Core) since EF core runs on .NET Core which supports .NET Standard 2.0, and .NET Standard 2.0 is the target for Azure Functions v2 projects.</p>
<h2 id="Installation"><a href="#Installation" class="headerlink" title="Installation"></a>Installation</h2><p>Well having that said I chose to have a separate class library for my EF Core database context to live in because I have multiple function apps inside my solution, which all have to use that same database context.</p>
<p>EF core requires some Nuget packages, at the time of writing I use the 2.1.2 versions of the understanding packages. The <code>Design</code> package is required when you want to work with migrations, if your not planning to do that then forget about that package. The <code>SqlServer</code> package has actually a pretty cool story. It is possible to use <a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/ef/core/providers/">other underlying databases</a> such as CosmosDb, MySql or what have you. So only use that <code>SqlServer</code> package when you have a backing Sql Server database.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Microsoft.EntityFrameworkCore</span><br><span class="line">Microsoft.EntityFrameworkCore.Design</span><br><span class="line">Microsoft.EntityFrameworkCore.SqlServer</span><br></pre></td></tr></table></figure>

<p>Do not install the following packages.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Microsoft.EntityFrameworkCore.Tools</span><br><span class="line">Microsoft.EntityFrameworkCore.Tools.DotNet</span><br></pre></td></tr></table></figure>
<p>Those packages got <a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/ef/core/miscellaneous/cli/dotnet">deprecated after .Net core 2.1.3</a>. Before you continue, make sure you have downloaded the latest .NET Core SDK. To check your local version execute:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; dotnet --version</span><br><span class="line">2.1.400</span><br></pre></td></tr></table></figure>
<h2 id="Setting-up-the-context"><a href="#Setting-up-the-context" class="headerlink" title="Setting up the context"></a>Setting up the context</h2><p>Just like with the traditional EF you have to setup a DbContext class with all the DbSets/tables and models and stuff. Generally EF core is simular to EF but there are some differences. A good site with alot of documentation is: <a target="_blank" rel="noopener" href="https://www.learnentityframeworkcore.com/">https://www.learnentityframeworkcore.com/</a>. Your context might look like this:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MyContext</span> : <span class="title">DbContext</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MyContext</span>(<span class="params">DbContextOptions&lt;MyContext&gt; dbContextOptions</span>) : <span class="title">base</span>(<span class="params">dbContextOptions</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnModelCreating</span>(<span class="params">ModelBuilder modelBuilder</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> DbSet&lt;Order&gt; Orders &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> DbSet&lt;Client&gt; Clients &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    </span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Azure-Functions-V2-Dependency-injection"><a href="#Azure-Functions-V2-Dependency-injection" class="headerlink" title="Azure Functions V2 Dependency injection"></a>Azure Functions V2 Dependency injection</h2><p>After setting up your DbContext you probably want to use it in your Azure Functions. In order for you to effectively do that you have to setup proper dependency injection. Sadly this is not yet supported out of the box in Azure Functions V1 or V2 so you’ll have to build it your own. Don’t be sad I have found a pretty good implementation on <a target="_blank" rel="noopener" href="https://github.com/BorisWilhelms/azure-function-dependency-injection">Github</a>. Once you have a project with that code you can just reference that project from within your Azure Functions project or just create a Nuget package.</p>
<p>All you then have to do is setup a ServiceProvider and add your dependencies simular to what you would have done in ASP.net core for instance. Note that the package <code>Microsoft.EntityFrameworkCore</code> contains a <code>AddDbContext</code> method that is build for injecting EF Core DbContexts.</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ServiceProviderBuilder</span> : <span class="title">IServiceProviderBuilder</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> IServiceProvider <span class="title">BuildServiceProvider</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        IConfigurationRoot config = <span class="keyword">new</span> ConfigurationBuilder()</span><br><span class="line">            .SetBasePath(Environment.CurrentDirectory)</span><br><span class="line">            .AddJsonFile(<span class="string">&quot;local.settings.json&quot;</span>, optional: <span class="literal">true</span>, reloadOnChange: <span class="literal">true</span>)</span><br><span class="line">            .AddEnvironmentVariables()</span><br><span class="line">            .Build();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> connectionString = config.GetConnectionString(<span class="string">&quot;SqlConnectionString&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> services = <span class="keyword">new</span> ServiceCollection();</span><br><span class="line"></span><br><span class="line">        services.AddSingleton&lt;IDemoService, DemoService&gt;();</span><br><span class="line"></span><br><span class="line">        services.AddDbContext&lt;MyContext&gt;(options =&gt; options.UseSqlServer(connectionString));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> services.BuildServiceProvider(<span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Once you’ve setup the registration then it’s very easy to inject it into your Azure Functions, take a look at this sample:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title">DemoFunction</span></span><br><span class="line">&#123;</span><br><span class="line">    [<span class="meta">FunctionName(nameof(DemoFunction))</span>]</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">async</span> Task&lt;IActionResult&gt; <span class="title">Run</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">        [HttpTrigger(</span></span></span><br><span class="line"><span class="function"><span class="params">            AuthorizationLevel.Anonymous,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="string">&quot;get&quot;</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">            Route = <span class="string">&quot;demo/route/&#123;id&#125;&quot;</span></span>)]HttpRequestMessage req,</span></span><br><span class="line"><span class="function">        [Inject] MyContext myContext,</span></span><br><span class="line"><span class="function">        <span class="keyword">string</span> id,</span></span><br><span class="line"><span class="function">        ILogger log)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">var</span> order = myContext.Orders.FirstOrDefault(x =&gt; x.Id == id);</span><br><span class="line">        order.Paid = <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">await</span> mspContext.SaveChangesAsync();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Migrations"><a href="#Migrations" class="headerlink" title="Migrations"></a>Migrations</h2><p>So we’ve got a DbContext setup and injected it into our Azure Functions, the next thing what you probably want to do is to use Migrations. EF core comes with great command line tooling, remember when we were using the Package Manager console to execute some Powershell? Finally those days are over. With the new <code>dotnet ef</code> tooling you can just do it from the command line.</p>
<p>There is no such thing as <code>Enable-Migrations</code> anymore, you just add a Migration and you’ve enabled it. The command to add a migrations is: <code>dotnet ef migrations add &lt;name&gt;</code>.</p>
<p>Remember that I created a Shared Class Library which targets .NET Standard? Well If you get the following error you’ve done the same as I did:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt; dotnet ef migrations add InitialCreate</span><br><span class="line"></span><br><span class="line">Startup project &#39;MyProject.Shared.csproj&#39; targets framework &#39;.NETStandard&#39;. There is no runtime associated with this framework, and projects targeting it cannot be executed directly. To use the Entity Framework Core .NET Command-line Tools with this project, add an executable project targeting .NET Core or .NET Framework that references this project, and set it as the startup project using --startup-project; or, update this project to cross-target .NET Core or .NET Framework.</span><br></pre></td></tr></table></figure>
<p>An easy work around is to enable multiple TargetFrameworks, note that its plural, add an ‘s’ after TargetFramework. If you add a netcoreapp target framework then your Class Library can execute on its own, even without a <code>static void main()</code> or something like that.</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">Project</span> <span class="attr">Sdk</span>=<span class="string">&quot;Microsoft.NET.Sdk&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">PropertyGroup</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">TargetFrameworks</span>&gt;</span>netcoreapp2.0.7;netstandard2.0<span class="tag">&lt;/<span class="name">TargetFrameworks</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">PropertyGroup</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">Project</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>If you execute the <code>dotnet ef migrations add &lt;name&gt;</code> again then you will probably get the following error.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt; dotnet ef migrations add InitialCreate</span><br><span class="line"></span><br><span class="line">Unable to create an object of type &#39;MyContext&#39;. Add an implementation of &#39;IDesignTimeDbContextFactory&lt;MyContext&gt;&#39; to the project, or see https:&#x2F;&#x2F;go.microsoft.com&#x2F;fwlink&#x2F;?linkid&#x3D;851728 for additional patterns supported at design time.</span><br></pre></td></tr></table></figure>
<p>This error states that you do not have setup a <code>DbContextOptions</code> object for your <code>DbContext</code> class. In other words during command line execution it doesn’t know where to execute or check the migrations on. In order for you to workaround this you’ll have to implement a <code>IDesignTimeDbContextFactory&lt;MyContext&gt;</code>. You’ll not have to reference it anywhere, the tooling will just check for the existence and initiate the class. I chose to create an <code>appsettings.json</code> file and inject a connectionString inside that file.</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">DesignTimeDbContextFactory</span> : <span class="title">IDesignTimeDbContextFactory</span>&lt;<span class="title">MyContext</span>&gt;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> MyContext <span class="title">CreateDbContext</span>(<span class="params"><span class="keyword">string</span>[] args</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        IConfigurationRoot configuration = <span class="keyword">new</span> ConfigurationBuilder()</span><br><span class="line">            .SetBasePath(Directory.GetCurrentDirectory())</span><br><span class="line">            .AddJsonFile(<span class="string">&quot;appsettings.json&quot;</span>)</span><br><span class="line">            .Build();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> builder = <span class="keyword">new</span> DbContextOptionsBuilder&lt;MyContext&gt;();</span><br><span class="line">        <span class="keyword">var</span> connectionString = configuration.GetConnectionString(<span class="string">&quot;SqlConnectionString&quot;</span>);</span><br><span class="line">        builder.UseSqlServer(connectionString);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> MyContext(builder.Options);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;ConnectionStrings&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;SqlConnectionString&quot;</span>: <span class="string">&quot;Server=tcp:whatever.database.windows.net,1433;Initial Catalog=whatever;Persist Security Info=False;User ID=whateveradmin;Password=secret;MultipleActiveResultSets=False;Encrypt=True;TrustServerCertificate=False;Connection Timeout=30;&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>If you try the command again, it should work.</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; dotnet ef migrations add InitialCreate</span><br><span class="line">Done. To undo this action, use &#x27;ef migrations remove&#x27;</span><br></pre></td></tr></table></figure>
<h2 id="CI-CD"><a href="#CI-CD" class="headerlink" title="CI / CD"></a>CI / CD</h2><p>Last but not least you probably want to generate migrations and execute them from your CI/CD environment. This way you’ll get a fully managed way of migrating/managing your database for all different environments.</p>
<h3 id="VSTS"><a href="#VSTS" class="headerlink" title="VSTS"></a>VSTS</h3><img src="/images/efcore/vstsbuild.png">
In VSTS you just setup a build with the following steps:
* dotnet restore
* dotnet build
* dotnet publish
    - Name the projects of your function apps.
* dotnet custom
    - Add `ef` as custom command
    - Add the arguments below. Set the project and the startup-project to your Class Library.
* Stage the ARM template
* Publish the artifacts
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">migrations script -i --project $(Build.SourcesDirectory)\MyProject.Shared\MyProject.Shared.csproj --startup-project $(Build.SourcesDirectory)\MyProject.Shared.csproj\MyProject.Shared.csproj.csproj -o $(build.artifactstagingdirectory)\Migrations\scripts.sql</span><br></pre></td></tr></table></figure>
Its important that you add the `-i` argument. This argument will generate the migrations script in such a way that it checks if the migration is already executed on the database. This prevents the pipeline from applying the same migrations twice. Notice that the migrations script is outputed to the artifacts directory which is published at the last step of the build.

<img src="/images/efcore/vstsrelease.png">
In the release part of the CI/CD pipeline you'll just have to the following:
* Execute the ARM script
* I use ARM script outputs to get the SQL Server name and Database name.
* Stop your Azure Functions
* Redeploy them
* Execute the migrations script against the database
* Restart the Azure Functions.

<p>Well that’s it, you’ve got Azure Functions V2 running Entity Framework Core in Azure! Thanks for reading and happy coding.</p>
<h2 id="Some-tips-and-tricks"><a href="#Some-tips-and-tricks" class="headerlink" title="Some tips and tricks"></a>Some tips and tricks</h2><p>Just some tips and tricks.</p>
<p>Don’t worry about this warning. Since EF Core tools are build into the .NET Core tooling you might have mismatches with your EF Core packages.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">The EF Core tools version &#39;2.1.0-rtm-30799&#39; is older than that of the runtime &#39;2.1.1-rtm-30846&#39;. Update the tools for the latest features and bug fixes.</span><br></pre></td></tr></table></figure>
<p>It can also occur that you only get this warning in VSTS. That might be the result of different .NET Core SDK’s on your client pc and VSTS. Check <a target="_blank" rel="noopener" href="https://github.com/Microsoft/vsts-image-generation/blob/master/images/win/Vs2017-Server2016-Readme.md#net-core">this page</a> out to see what version of <code>dotnet</code> is running in VSTS.</p>
<p>Adding the <code>-i</code> argument prevents migrations from being executed twice.</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; dotnet ef migrations script -i</span><br></pre></td></tr></table></figure>
<p>It adds the following check to the generated SQL:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">IF NOT EXISTS(<span class="keyword">SELECT</span> * <span class="keyword">FROM</span> [__EFMigrationsHistory] <span class="keyword">WHERE</span> [MigrationId] = N<span class="string">&#x27;20180823120412_InitialCreate&#x27;</span>)</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">    <span class="comment">-- Generated migrations code here</span></span><br><span class="line"><span class="keyword">END</span></span><br></pre></td></tr></table></figure>
<p>To remove all migrations and start over just simply execute this.<br>It can be handy at the initial development.</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; dotnet ef database update <span class="number">0</span></span><br><span class="line">&gt; dotnet ef migrations remove</span><br></pre></td></tr></table></figure>
      
    </div>
    <footer class="article-footer">
      <a data-url="https://dibranmulder.github.io/2018/08/23/Azure-functions-V2-with-EF-Core/" data-id="ckfdlvwxh000dfk496ol9hudp" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Azure/" rel="tag">Azure</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Dependency-Injection/" rel="tag">Dependency Injection</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/EF-Core/" rel="tag">EF Core</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Entity-Framework-Core/" rel="tag">Entity Framework Core</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Functions-V2/" rel="tag">Functions V2</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Migrations/" rel="tag">Migrations</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/VSTS/" rel="tag">VSTS</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Azure-Service-Health" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/08/20/Azure-Service-Health/" class="article-date">
  <time datetime="2018-08-20T14:13:53.000Z" itemprop="datePublished">2018-08-20</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/08/20/Azure-Service-Health/">Azure Service Health</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>The Azure cloud provides data redundancy, global data centers, disaster recovery, SLA’s, so you would easily forget that incidents can happen. It might not be likely, with all the automatic healing, and services within Azure, but in case something is down, it is crucial to be able to have insights in what is happening, and even better, to be in control. This article describes the several options available for global Azure monitoring, and highlights the features in <a target="_blank" rel="noopener" href="https://azure.microsoft.com/en-us/features/service-health/">Azure Service Health</a> (<a target="_blank" rel="noopener" href="https://azure.microsoft.com/en/status/">Azure Status</a>)</p>
<h2 id="Azure-monitoring"><a href="#Azure-monitoring" class="headerlink" title="Azure monitoring"></a>Azure monitoring</h2><p>Azure contains a massive amount of services, and provides an extensive set of monitoring services. Monitoring can be done roughly on these levels (this is an short overview, more services are available): </p>
<ol>
<li><p>Application level - for this Application Insights is ideal, it provides analytics on all events monitored (out of the box, custom events, and even events from Azure services), and has some powerfull features, such as anomaly detection, which is able to distinguish normal vs extrodinary events.</p>
</li>
<li><p>Service level - for this Log Analytics or Operations Management Suite (OMS) can be used, which enables you to log all activity within Azure resources, and specify metric based alerts (such as spikes in data in / requests etc)</p>
</li>
<li><p>Cloud level – Azure Service Health monitoring is a valuable service, which helps in case of any interruption, events within all of the Azure datacenters, and services, which might have impact for you as a customer.</p>
</li>
</ol>
<p>In this article we’ll describe the following Azure Service Health features:</p>
<ul>
<li>Portal feature<ul>
<li>Health Map - which can be used in the Azure portal and show the actual status</li>
</ul>
</li>
<li>Monitoring features<ul>
<li>Health Alert - which is an type of alert fired when an issues is detected within Azure, impacting resources</li>
<li>Action group - which is used to send out alert information, and which can help to trigger workflows</li>
</ul>
</li>
</ul>
<h2 id="Portal-feature"><a href="#Portal-feature" class="headerlink" title="Portal feature"></a>Portal feature</h2><h3 id="Health-Map"><a href="#Health-Map" class="headerlink" title="Health Map"></a>Health Map</h3><p>Within the Azure portal it’s easy to setup an Azure Service Health map, it takes only a few clicks. </p>
<ol>
<li>We login to the Azure portal</li>
<li>Click all services, filter on “Service health” (suggestion: mark it as favorite)</li>
</ol>
<img src="/images/servicehealth/serviceHealth.PNG" style="height: 115px;" />

<ol start="3">
<li><p>Within the service health blade it’s possible to setup the map, but also view:<br> a. Service issues (any issues within Azure)<br> b. Planned Maintenance (planned activities by Microsoft)<br> c. Health Advisories (adivise based on service issues by Microsoft)<br> d. Health History<br> e. Resource Health (current status)<br> f. Health Alerts (configured alerts)</p>
</li>
<li><p>From the tab ‘Service Issues’, perform the following actions:<br> a. Select the subscription(s), for which Health alerts needs to be monitored<br> b. Select the regions which are relevant<br> c. Select the services used to monitor<br> d. Click on ‘Pin filtered world map to dashboard’</p>
</li>
</ol>
<p>Navigate to the Azure Dashboard (close all blades/tabs), and a similar maps as shown below is now added, any issues with the selected region/applicable services are displayed in the map</p>
<img src="/images/servicehealth/Map.PNG" style="height: 350px;" />

<h2 id="Monitoring-features"><a href="#Monitoring-features" class="headerlink" title="Monitoring features"></a>Monitoring features</h2><p>In case an issue is detected by the Azure Service health, an alert is fired. In order to do something with this alert, an action group needs to be linked to this alert. </p>
<p>The action group is configured, and based on the action type, information is pushed to a service. This flow has to following steps, in this section each step is explained</p>
<img src="/images/servicehealth/alertOutputs.png" />

<h3 id="Azure-Health-monitoring"><a href="#Azure-Health-monitoring" class="headerlink" title="Azure Health monitoring"></a>Azure Health monitoring</h3><p>This is the service which enables the health monitoring. Click on ‘Health Service’, this can be done through the menu item ‘Health Service’, or within the ‘Monitor’, in the section: ‘Service Health’</p>
<img src="/images/servicehealth/menu.PNG" style="height: 100px;" />

<p>Now click on ‘Health Alerts’ in order to set up a new rule.</p>
<h3 id="Azure-Health-alerts"><a href="#Azure-Health-alerts" class="headerlink" title="Azure Health alerts"></a>Azure Health alerts</h3><p>We can now define alerts and specify which subscription, service, region is monitored;</p>
<img src="/images/servicehealth/configureAlert.PNG" />

<ol>
<li>Define the conditions</li>
<li>Select the Event types, the following event types can be selected:<ul>
<li>Service Issue - outage/issues within Azure</li>
<li>Planned maintenance - Azure service affected by scheduled maintenance (notitications are sent upfront)</li>
<li>Health advisories - suggestions by Microsoft to mitigate problems base on a Service issue (e.g. routing data etc)</li>
</ul>
</li>
<li>Enter the alert details</li>
<li>In case there is no action group, ‘Create a new Action group’ * </li>
</ol>
<h3 id="Action-group"><a href="#Action-group" class="headerlink" title="Action group"></a>Action group</h3><p>The action group is a definition, what actions are taken, in case an alert occurs. The action group is basically a container which can be linked to an Alert, in which Action types can be defined. </p>
<img src="/images/servicehealth/runBook.PNG" style="height: 440px;" />

<ol>
<li>Choose the subscription / resource group</li>
<li>Select one or more action types<br> a. Configure the action type</li>
</ol>
<p>Considerations:</p>
<ol>
<li>An email-sms-voice seems to be the most obvious types of alerts to use, as it’s a risk to let a function/logic* app handle outage, without being sure that the outage is affecting these types of services. </li>
<li>A WebHook, could be very interesting, as it allows you to notify an external hosted service.</li>
<li>To mitigate problems, the Azure Automation Runbook enables you to run a workflow, such are shutting down services ** changes routes, so that the impact is limited. </li>
<li>The ITSM connector,*** which can create service tickets in your preferred service management tool.</li>
</ol>
<img src="/images/servicehealth/actionGroupSetup.PNG" style="height: 250px;" />

<p>* Functions/Logic apps needs to be defined in the subscription in which the Alert is defined<br>** The Automation RunBook, is either a standard one, or the one saved in the User library.<br>*** The ITSM is a connector, which supports the following service management tools: ServiceNow, System Center Service Manager, Provance and Cherwell</p>
<h2 id="Automation"><a href="#Automation" class="headerlink" title="Automation"></a>Automation</h2><h3 id="ARM-template"><a href="#ARM-template" class="headerlink" title="ARM template"></a>ARM template</h3><p>Based on our configured alert, it’s now possible to create additional alerts, and use the existing configuration as an template. With the Azure resource explorer, we can navigate to our subscription, select the Operation privder ‘Microsoft.Insights’ and view our template and re-use this. It’s also possible to use the Azure Template feature, and deploy directly from within Azure, an example of such a template can be found here: Service Health Template.</p>
<p>** This blog is written by: ** <script src="//platform.linkedin.com/in.js" type="text/javascript"></script></p>
<script type="IN/MemberProfile" data-id="https://www.linkedin.com/in/sandernefs/" data-format="inline" data-related="false"></script>
      
    </div>
    <footer class="article-footer">
      <a data-url="https://dibranmulder.github.io/2018/08/20/Azure-Service-Health/" data-id="ckfdlvwxg000cfk49d0zigdie" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Azure/" rel="tag">Azure</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Service-Health/" rel="tag">Service Health</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Unique-keys-in-Azure-Cosmos-DB" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/07/03/Unique-keys-in-Azure-Cosmos-DB/" class="article-date">
  <time datetime="2018-07-03T14:06:31.000Z" itemprop="datePublished">2018-07-03</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/07/03/Unique-keys-in-Azure-Cosmos-DB/">Unique keys in Azure Cosmos DB</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>NoSQL databases often don’t have support for database constraints. It doesn’t make sense to constraint since the data is schemaless and therefore where does the database has to constrain on?<br>Well its true for most cases but sometimes you just want to make sure that there’s only 1 document for an entity. Lets say your CosmosDb is managing client or user entities. It doesn’t make sense to have 2 users documents representing the same user, does it? It could result in bugs or other unwanted behavior.</p>
<h2 id="Unique-keys"><a href="#Unique-keys" class="headerlink" title="Unique keys"></a>Unique keys</h2><p>CosmosDb supports Unique Keys, well I rather call them Unique Paths.<br>Lets say you have a document representing a client and it looks something like this:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;id&quot;</span>: <span class="string">&quot;1234567&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;BigFirm&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;country&quot;</span>: <span class="string">&quot;The Netherlands&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;address&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;street&quot;</span>: <span class="string">&quot;Sillicon Valley Road&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;housenumber&quot;</span>: <span class="string">&quot;42&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;state&quot;</span>: <span class="string">&quot;California&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;country&quot;</span>: <span class="string">&quot;The Greatest Country on Earth&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;users&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;Dibran&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;title&quot;</span>: <span class="string">&quot;CEO&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;username&quot;</span>: <span class="string">&quot;d.mulder@bigfirm.com&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;Charles&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;title&quot;</span>: <span class="string">&quot;Slave&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;username&quot;</span>: <span class="string">&quot;charles@bigfirm.com&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Lets say you want every document to have an unique combination of name and country. And secondly, you want to have unique list of user titles inside your users array. Its actually quite easy to do that, but the sad part is that you can only add unique keys at the creation of a collection. After that you’re not able to edit them anymore.</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">DocumentCollection myCollection = <span class="keyword">new</span> DocumentCollection();</span><br><span class="line">myCollection.Id = <span class="string">&quot;ClientCollection&quot;</span>;</span><br><span class="line">myCollection.UniqueKeyPolicy = <span class="keyword">new</span> UniqueKeyPolicy</span><br><span class="line">&#123;</span><br><span class="line">    UniqueKeys =</span><br><span class="line">    <span class="keyword">new</span> Collection&lt;UniqueKey&gt;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">new</span> UniqueKey &#123; Paths = <span class="keyword">new</span> Collection&lt;<span class="keyword">string</span>&gt; &#123; <span class="string">&quot;/name&quot;</span> , <span class="string">&quot;/country&quot;</span> &#125;&#125;</span><br><span class="line">        <span class="keyword">new</span> UniqueKey &#123; Paths = <span class="keyword">new</span> Collection&lt;<span class="keyword">string</span>&gt; &#123; <span class="string">&quot;/users/title&quot;</span> &#125; &#125;,</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">await</span> client.CreateDocumentCollectionAsync(</span><br><span class="line">    UriFactory.CreateDatabaseUri(dataBase),</span><br><span class="line">    myCollection,</span><br><span class="line">    <span class="keyword">new</span> RequestOptions &#123; OfferThroughput = <span class="number">400</span> &#125;);</span><br></pre></td></tr></table></figure>
<p>Its just that simple, now you’ll have a collection with a unique key policy. Actually if you look at the json definition of a collection then you’ll be able to see it, take a look:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;id&quot;</span>: <span class="string">&quot;ClientCollection&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;indexingPolicy&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;indexingMode&quot;</span>: <span class="string">&quot;consistent&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;automatic&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">&quot;includedPaths&quot;</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">&quot;path&quot;</span>: <span class="string">&quot;/*&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;indexes&quot;</span>: [</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="attr">&quot;kind&quot;</span>: <span class="string">&quot;Range&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;dataType&quot;</span>: <span class="string">&quot;Number&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;precision&quot;</span>: <span class="number">-1</span></span><br><span class="line">          &#125;,</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="attr">&quot;kind&quot;</span>: <span class="string">&quot;Hash&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;dataType&quot;</span>: <span class="string">&quot;String&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;precision&quot;</span>: <span class="number">3</span></span><br><span class="line">          &#125;</span><br><span class="line">        ]</span><br><span class="line">      &#125;</span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">&quot;excludedPaths&quot;</span>: []</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;uniqueKeyPolicy&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;uniqueKeys&quot;</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">&quot;paths&quot;</span>: [</span><br><span class="line">          <span class="string">&quot;/name&quot;</span>,</span><br><span class="line">          <span class="string">&quot;/country&quot;</span></span><br><span class="line">        ]</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">&quot;paths&quot;</span>: [</span><br><span class="line">          <span class="string">&quot;/users/title&quot;</span></span><br><span class="line">        ]</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Bear in mind that you’ll have to check for conflict exceptions in your code. If you’re violating the unique key policy then a <code>Microsoft.Azure.Documents.DocumentClientException</code> is thrown. This exceptions contains a <code>System.Net.HttpStatusCode.Conflict</code> status code, this is where you want to check on. Your code will look something like this:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span></span><br><span class="line">&#123;</span><br><span class="line">    response = <span class="keyword">await</span> client.CreateDocumentAsync(collectionUri, document, requestOptions);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">catch</span> (Microsoft.Azure.Documents.DocumentClientException ex)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> ( ex.StatusCode == System.Net.HttpStatusCode.Conflict )</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// Unique key constraint violation ...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// Some other issue ...</span></span><br><span class="line">        <span class="keyword">throw</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Hopefully this helped a little, for further reading please see:<br><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/azure/cosmos-db/unique-keys">https://docs.microsoft.com/en-us/azure/cosmos-db/unique-keys</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://dibranmulder.github.io/2018/07/03/Unique-keys-in-Azure-Cosmos-DB/" data-id="ckfdlvwxr000nfk49e6x8awwn" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Azure/" rel="tag">Azure</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/CosmosDb/" rel="tag">CosmosDb</a></li></ul>

    </footer>
  </div>
  
</article>


  


  <nav id="page-nav">
    
    <a class="extend prev" rel="prev" href="/">&amp;laquo; Prev</a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/3/">Next &amp;raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/AD/" rel="tag">AD</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/AI/" rel="tag">AI</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/API-Gateway/" rel="tag">API Gateway</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/API-Management/" rel="tag">API Management</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/API-management/" rel="tag">API management</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Autonoom-rijden/" rel="tag">Autonoom rijden</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Availability-Zone/" rel="tag">Availability Zone</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Azure/" rel="tag">Azure</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Azure-DevOps/" rel="tag">Azure DevOps</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Azure-Functions/" rel="tag">Azure Functions</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Azure-Search/" rel="tag">Azure Search</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Azure-PaaS-Serverless-Teams-Agile-Versioning/" rel="tag">Azure, PaaS, Serverless, Teams, Agile, Versioning</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Blueprints/" rel="tag">Blueprints</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Cache/" rel="tag">Cache</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Caesar/" rel="tag">Caesar</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Compliance/" rel="tag">Compliance</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/CosmosDb/" rel="tag">CosmosDb</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Dependency-Injection/" rel="tag">Dependency Injection</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Docker/" rel="tag">Docker</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/EF-Core/" rel="tag">EF Core</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Entity-Framework-Core/" rel="tag">Entity Framework Core</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Functions/" rel="tag">Functions</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Functions-V2/" rel="tag">Functions V2</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Governance-Framework/" rel="tag">Governance Framework</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux/" rel="tag">Linux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Logic-Apps/" rel="tag">Logic Apps</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MSI/" rel="tag">MSI</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Migrations/" rel="tag">Migrations</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Naming-conventions/" rel="tag">Naming conventions</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/OpenAI/" rel="tag">OpenAI</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Policies/" rel="tag">Policies</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Resilient/" rel="tag">Resilient</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Resource-groups/" rel="tag">Resource groups</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SQL-Server/" rel="tag">SQL Server</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Security/" rel="tag">Security</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Self-driving-cars/" rel="tag">Self driving cars</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SendGrid/" rel="tag">SendGrid</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Service-Health/" rel="tag">Service Health</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Table-Storage/" rel="tag">Table Storage</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Tensorflow/" rel="tag">Tensorflow</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Tesla/" rel="tag">Tesla</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/TypeScript/" rel="tag">TypeScript</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/VSTS/" rel="tag">VSTS</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/WSL/" rel="tag">WSL</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Woocommerce/" rel="tag">Woocommerce</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Wordpress/" rel="tag">Wordpress</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/AD/" style="font-size: 10px;">AD</a> <a href="/tags/AI/" style="font-size: 10px;">AI</a> <a href="/tags/API-Gateway/" style="font-size: 10px;">API Gateway</a> <a href="/tags/API-Management/" style="font-size: 12.5px;">API Management</a> <a href="/tags/API-management/" style="font-size: 10px;">API management</a> <a href="/tags/Autonoom-rijden/" style="font-size: 10px;">Autonoom rijden</a> <a href="/tags/Availability-Zone/" style="font-size: 10px;">Availability Zone</a> <a href="/tags/Azure/" style="font-size: 20px;">Azure</a> <a href="/tags/Azure-DevOps/" style="font-size: 10px;">Azure DevOps</a> <a href="/tags/Azure-Functions/" style="font-size: 12.5px;">Azure Functions</a> <a href="/tags/Azure-Search/" style="font-size: 10px;">Azure Search</a> <a href="/tags/Azure-PaaS-Serverless-Teams-Agile-Versioning/" style="font-size: 10px;">Azure, PaaS, Serverless, Teams, Agile, Versioning</a> <a href="/tags/Blueprints/" style="font-size: 10px;">Blueprints</a> <a href="/tags/Cache/" style="font-size: 10px;">Cache</a> <a href="/tags/Caesar/" style="font-size: 10px;">Caesar</a> <a href="/tags/Compliance/" style="font-size: 10px;">Compliance</a> <a href="/tags/CosmosDb/" style="font-size: 15px;">CosmosDb</a> <a href="/tags/Dependency-Injection/" style="font-size: 10px;">Dependency Injection</a> <a href="/tags/Docker/" style="font-size: 10px;">Docker</a> <a href="/tags/EF-Core/" style="font-size: 10px;">EF Core</a> <a href="/tags/Entity-Framework-Core/" style="font-size: 10px;">Entity Framework Core</a> <a href="/tags/Functions/" style="font-size: 17.5px;">Functions</a> <a href="/tags/Functions-V2/" style="font-size: 10px;">Functions V2</a> <a href="/tags/Governance-Framework/" style="font-size: 10px;">Governance Framework</a> <a href="/tags/Linux/" style="font-size: 10px;">Linux</a> <a href="/tags/Logic-Apps/" style="font-size: 12.5px;">Logic Apps</a> <a href="/tags/MSI/" style="font-size: 10px;">MSI</a> <a href="/tags/Migrations/" style="font-size: 10px;">Migrations</a> <a href="/tags/Naming-conventions/" style="font-size: 10px;">Naming conventions</a> <a href="/tags/OpenAI/" style="font-size: 10px;">OpenAI</a> <a href="/tags/Policies/" style="font-size: 10px;">Policies</a> <a href="/tags/Resilient/" style="font-size: 10px;">Resilient</a> <a href="/tags/Resource-groups/" style="font-size: 10px;">Resource groups</a> <a href="/tags/SQL-Server/" style="font-size: 10px;">SQL Server</a> <a href="/tags/Security/" style="font-size: 10px;">Security</a> <a href="/tags/Self-driving-cars/" style="font-size: 10px;">Self driving cars</a> <a href="/tags/SendGrid/" style="font-size: 10px;">SendGrid</a> <a href="/tags/Service-Health/" style="font-size: 10px;">Service Health</a> <a href="/tags/Table-Storage/" style="font-size: 10px;">Table Storage</a> <a href="/tags/Tensorflow/" style="font-size: 10px;">Tensorflow</a> <a href="/tags/Tesla/" style="font-size: 10px;">Tesla</a> <a href="/tags/TypeScript/" style="font-size: 10px;">TypeScript</a> <a href="/tags/VSTS/" style="font-size: 10px;">VSTS</a> <a href="/tags/WSL/" style="font-size: 10px;">WSL</a> <a href="/tags/Woocommerce/" style="font-size: 10px;">Woocommerce</a> <a href="/tags/Wordpress/" style="font-size: 12.5px;">Wordpress</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/09/">september 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/12/">december 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/09/">september 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/08/">augustus 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/06/">juni 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/05/">mei 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/04/">april 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/03/">maart 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/02/">februari 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/01/">januari 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/12/">december 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/11/">november 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/10/">oktober 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/08/">augustus 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/07/">juli 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/06/">juni 2018</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2020/09/22/Improving-your-Azure-Search-performance/">Improving your Azure Cognitive Search performance</a>
          </li>
        
          <li>
            <a href="/2019/12/06/Applying-an-Azure-Governance-Framework-in-10-steps/">Applying an Azure Governance Framework in 10 steps</a>
          </li>
        
          <li>
            <a href="/2019/09/06/Running-an-OpenAI-Gym-on-Windows-with-WSL/">Running an OpenAI Gym on Windows with WSL</a>
          </li>
        
          <li>
            <a href="/2019/08/23/Sending-e-mails-with-SendGrid-and-Azure-Functions/">Sending e-mails with SendGrid and Azure Functions</a>
          </li>
        
          <li>
            <a href="/2019/08/16/Autonoom-rijden/">Autonoom rijden</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2020 Dibran Mulder<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  
<link rel="stylesheet" href="/fancybox/jquery.fancybox.css">

  
<script src="/fancybox/jquery.fancybox.pack.js"></script>




<script src="/js/script.js"></script>




  </div>
</body>
</html>